(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const ge=["S","H","D","C"],He=["E","W"],nt={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function $(e){const t=e.slice(0,1),n=e.slice(1);if(!ge.includes(t)||!(n in nt))throw new Error(`Invalid CardId: ${e}`);return{suit:t,rank:n}}function g(e,t){return`${e}${t}`}function R(e){return nt[e]}function rt(e,t){const{suit:n,rank:s}=$(t),a=[],r=["N","E","S","W"];for(const i of r)e.hands[i][n].includes(s)&&a.push(i);return a}function st(e,t,n,s){return e.hands[t][n].filter(a=>R(a)>=R(s)).length}function Wt(e,t){const n={};for(const s of t){const{suit:a,rank:r}=$(s);if(n[a])throw new Error(`Duplicate threat suit: ${a}`);const i=rt(e,s);if(i.length!==1)throw new Error(`Threat card ${s} must exist in exactly one hand (found ${i.length})`);const o=i[0];n[a]={suit:a,threatCardId:s,threatRank:r,establishedOwner:o,active:!0,threatLength:st(e,o,a,r)}}return{threatsBySuit:n,threatCardIds:[...t]}}function At(e,t){const n={E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}};for(const s of He)for(const a of ge){for(const c of t.hands[s][a])n[s].idle.add(g(a,c));const r=e.threatsBySuit[a];if(!r||!r.active||r.threatLength<=0)continue;const i=t.hands[s][a],o=i.some(c=>R(c)>R(r.threatRank)),l=i.length>=r.threatLength;if(!o||!l)continue;const d=[...i].sort((c,f)=>R(f)-R(c)).slice(0,r.threatLength);for(const c of d){const f=g(a,c);n[s].idle.delete(f),n[s].busy.add(f)}}return n}function It(e){return{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}}function Je(e,t,n){return[...e[t].busy].some(s=>$(s).suit===n)}function Ue(e,t,n){const s=e.threatsBySuit[n];if(!s||!s.active)return;const a=Je(t,"E",n),r=Je(t,"W",n);return a&&r?"double":a||r?"single":"none"}function at(e,t,n){const s=e.threatsBySuit[n];return!s||!s.active?!1:(s.stopStatus??Ue(e,t,n))==="none"}function it(e,t,n){return at(e,t,n)?e.threatsBySuit[n]?.threatRank??null:null}function Nt(e,t,n,s){for(const a of He){for(const c of[...n[a].busy])$(c).suit===s&&n[a].busy.delete(c);for(const c of[...n[a].idle])$(c).suit===s&&n[a].idle.delete(c);for(const c of t.hands[a][s])n[a].idle.add(g(s,c));const r=e.threatsBySuit[s];if(!r||!r.active||r.threatLength<=0)continue;const i=t.hands[a][s],o=i.some(c=>R(c)>R(r.threatRank)),l=i.length>=r.threatLength;if(!o||!l)continue;const d=[...i].sort((c,f)=>R(f)-R(c)).slice(0,r.threatLength);for(const c of d){const f=g(s,c);n[a].idle.delete(f),n[a].busy.add(f)}}}function ot(e,t,n,s,a){for(const o of Object.keys(e))$(o).suit===a&&delete e[o];const r=["N","E","S","W"];for(const o of r)for(const l of s.hands[o][a]){const d=g(a,l);e[d]="default"}for(const o of He){for(const l of n[o].idle)$(l).suit===a&&(e[l]="idle");for(const l of n[o].busy)$(l).suit===a&&(e[l]="busy")}const i=t.threatsBySuit[a];i?.active&&(e[i.threatCardId]="threat",at(t,n,a)&&(e[i.threatCardId]="promotedWinner"))}function Ye(e,t){const n=Wt(e,t),s=At(n,e);for(const r of ge){const i=n.threatsBySuit[r];i&&(n.threatsBySuit[r]={...i,stopStatus:Ue(n,s,r)})}const a={};for(const r of ge)ot(a,n,s,e,r);return{threat:n,labels:s,perCardRole:a}}function lt(e,t,n){const s={threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}},a=It(e.labels),r={...e.perCardRole};delete r[n];const i=$(n).suit,o=new Set;s.threatsBySuit[i]&&o.add(i);for(const l of o){const d=s.threatsBySuit[l];if(!d)continue;const c=rt(t,d.threatCardId),f=c.length===1&&c[0]===d.establishedOwner;s.threatsBySuit[l]={...d,active:f,threatLength:f?st(t,d.establishedOwner,l,d.threatRank):0,stopStatus:void 0},Nt(s,t,a,l);const p=s.threatsBySuit[l];p&&(s.threatsBySuit[l]={...p,stopStatus:Ue(s,a,l)}),ot(r,s,a,t,l)}return{threat:s,labels:a,perCardRole:r}}const ct=["S","H","D","C"],J={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function Tt(e,t){if(t&&e[t].length>0)return e[t].map(s=>g(t,s));const n=[];for(const s of ct)for(const a of e[s])n.push(g(s,a));return n}function $e(e,t,n){return n[e].idle.has(t)}function je(e){return $(e).rank}function I(e){return $(e).suit}function me(e,t){return!!t.threatsBySuit[e]?.active}function ut(e,t){const n=t.threatsBySuit[e];return!n||!n.active?null:n.threatRank}function ne(e,t,n){const s=ut(e,t);if(!s)return null;const a=it(t,n,e);return a&&J[a]>J[s]?a:s}function Ge(e,t,n,s){return $e(e,t,n)?!me(I(t),s):!1}function Me(e,t,n,s){if(!$e(e,t,n))return!1;const a=I(t),r=ne(a,s,n);return r?J[je(t)]<J[r]:!1}function dt(e,t,n,s){return $e(e,t,n)?!Ge(e,t,n,s)&&!Me(e,t,n,s):!1}function ht(e,t,n){return n[e].busy.has(t)}function ye(e,t,n,s){if(!ht(e,t,n))return!1;const a=I(t);return me(a,s)}function ft(e,t,n){const s=n.threatsBySuit[e]?.stopStatus;if(s)return s;if(!me(e,n))return;const a=[...t.E.busy].some(i=>I(i)===e),r=[...t.W.busy].some(i=>I(i)===e);return a&&r?"double":a||r?"single":"none"}function Ve(e,t,n,s){return ft(t,n,s)==="double"}function _e(e,t,n,s){return ft(t,n,s)!=="single"?!1:[...n[e].busy].some(a=>I(a)===t)}function qe(e,t){const n=I(e),s=je(e),a=ut(n,t);return a?J[s]<J[a]:!1}function pt(e,t,n,s,a){const r=t.hands[e],i=Tt(r,n),o=i.filter(y=>Ge(e,y,a,s)),l=i.filter(y=>Me(e,y,a,s)),d=i.filter(y=>dt(e,y,a,s)),c=i.filter(y=>{if(!ye(e,y,a,s))return!1;const h=I(y);return Ve(e,h,a,s)&&qe(y,s)}),f=i.filter(y=>{if(!ye(e,y,a,s))return!1;const h=I(y);return Ve(e,h,a,s)}),p=i.filter(y=>{if(!ye(e,y,a,s))return!1;const h=I(y);return _e(e,h,a,s)&&qe(y,s)}),u=i.filter(y=>{if(!ye(e,y,a,s))return!1;const h=I(y);return _e(e,h,a,s)});return{legal:i,tier1a:o,tier1b:l,tier1c:d,tier2a:c,tier2b:f,tier3a:p,tier3b:u,tier4:i}}function Dt(e,t,n,s){const a=t.map(u=>{const y=I(u),h=je(u),C=$e(e,u,s),G=ht(e,u,s),K=ne(y,n,s);return{cardId:u,suit:y,rank:h,label:G?"busy":C?"idle":"default",idle:C,suitActiveThreat:me(y,n),threshold:K,rankBelowThreshold:K?J[h]<J[K]:null,tier1a:Ge(e,u,s,n),tier1b:Me(e,u,s,n),tier1c:dt(e,u,s,n)}}),r=a.filter(u=>u.tier1a).map(u=>u.cardId),i=a.filter(u=>u.tier1b).map(u=>u.cardId),o=a.filter(u=>u.tier1c).map(u=>u.cardId),l=a.filter(u=>u.idle).map(u=>u.cardId),d=new Map;for(const u of[...r,...i,...o])d.set(u,(d.get(u)??0)+1);const c=l.filter(u=>!d.has(u)),f=[...d.entries()].filter(([,u])=>u>1).map(([u])=>u),p=[];for(const u of ct){const y=n.threatsBySuit[u];!y||!y.active||p.push({suit:u,active:y.active,threatRank:y.threatRank,promotedWinnerRank:it(n,s,u),threshold:ne(u,n,s)??y.threatRank,stopStatus:y.stopStatus??"-"})}return{cards:a,idleLegal:l,tier1a:r,tier1b:i,tier1c:o,activeThreats:p,integrityOk:c.length===0&&f.length===0&&l.length===r.length+i.length+o.length,missing:c,overlap:f}}const yt=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],Rt=["N","E","S","W"];function U(e){return yt.indexOf(e)}function kt(e,t){return`${e}${t}`}function Pt(e,t){const n=U(e),s=U(t);return n<0||s<0||s-n<=1?[]:yt.slice(n+1,s)}function Ot(e,t,n,s,a){const r=Pt(s,a);if(r.length===0)return!0;const i=Rt.filter(o=>o!==t);return r.every(o=>i.every(l=>!e.hands[l][n].includes(o)))}function Ht(e,t){return Math.abs(U(e)-U(t))===1}function Ut(e,t,n){const s=[...e.hands[t][n]].sort((r,i)=>U(r)-U(i));if(s.length===0)return[];const a=[[s[0]]];for(let r=1;r<s.length;r+=1){const i=s[r-1],o=s[r];Ht(i,o)||Ot(e,t,n,i,o)?a[a.length-1].push(o):a.push([o])}return a}function jt(e,t,n){const s=[...n].sort((i,o)=>U(i)-U(o)),a=s[0],r=s[s.length-1];return`${e}:${t}:${a}-${r}`}function Gt(e,t){const n=[...t].sort((a,r)=>U(a)-U(r)),s=n[n.length-1];return kt(e,s)}function F(e,t,n){const s=n[0],a=n.slice(1),i=Ut(e,t,s).find(o=>o.includes(a))??[a];return{classId:jt(t,s,i),representative:Gt(s,i),members:i.map(o=>kt(s,o))}}const ue=["N","E","S","W"],Fe=["S","H","D","C"],ee={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function z(e){return{S:[...e.S],H:[...e.H],D:[...e.D],C:[...e.C]}}function Mt(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},hands:{N:z(e.hands.N),E:z(e.hands.E),S:z(e.hands.S),W:z(e.hands.W)},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:{enabled:e.replay.enabled,transcript:e.replay.transcript?{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}:null,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard}}}function Ft(e){const t=ue.indexOf(e);return ue[(t+1)%ue.length]}function Kt(e){return e==="N"||e==="S"?"NS":"EW"}function Ce(e){return ue.every(t=>Fe.every(n=>e[t][n].length===0))}function zt(e,t){return e.type==="minTricks"?t[e.side]>=e.n:!1}function Qt(e){let n=e.seed+Math.imul(e.counter,2654435769)>>>0;return n^=n>>>16,n=Math.imul(n,2146121005)>>>0,n^=n>>>15,n=Math.imul(n,2221713035)>>>0,n^=n>>>16,e.counter+=1,n/4294967296}function Be(e,t){return Math.floor(Qt(t)*e)}function Jt(e,t){const n=e[0].suit,s=t?e.filter(i=>i.suit===t):[],a=s.length>0?s:e.filter(i=>i.suit===n);let r=a[0];for(const i of a)ee[i.rank]>ee[r.rank]&&(r=i);return r.seat}function Yt(e,t,n){const s=e[t].indexOf(n);return s<0?!1:(e[t].splice(s,1),!0)}function le(e){return e.userControls.includes(e.turn)}function oe(e){const t=v(e);if(t.length===0)return null;const n=Be(t.length,e.rng);return!Number.isFinite(n)||n<0||n>=t.length?t[0]:t[n]??t[0]}function Vt(e){const t=e.turn,n=e.trick[0]?.suit??"-",s=e.contract.strain,a=v(e).map(i=>F(e,i.seat,g(i.suit,i.rank)).classId).sort().join(","),r=e.trickClassIds.join(",");return`seat=${t}|lead=${n}|trump=${s}|legal=${a}|trick=${r}`}function _t(e){const t={};for(const n of ue){const s=e.preferredDiscards?.[n];s&&(t[n]=Array.isArray(s)?[...s]:[s])}return t}function qt(e){const t=e.turn,n=e.preferredDiscards[t];if(!n||n.length===0)return null;const s=e.trick[0]?.suit??null;if(!s)return{preferred:n,applied:!1,reason:"not-discard"};if(e.hands[t][s].length>0)return{preferred:n,applied:!1,reason:"can-follow-suit"};if(e.preferredDiscardUsed[t])return{preferred:n,applied:!1,reason:"already-used"};const a=v(e).map(i=>g(i.suit,i.rank)),r=new Set;for(const i of Fe)for(const o of e.hands[t][i])r.add(g(i,o));for(const i of n)if(r.has(i))return a.includes(i)?{preferred:n,applied:!0,chosen:i,reason:"applied"}:{preferred:n,applied:!1,chosen:i,reason:"not-legal"};return{preferred:n,applied:!1,reason:"not-in-hand"}}function Xt(e,t){const n=e.turn==="E"||e.turn==="W",s=n?Vt(e):void 0;let a;if(n&&e.replay.enabled&&e.replay.transcript){const h=e.replay.transcript.decisions[e.replay.cursor];if(!h)e.replay.enabled=!1;else if(h.sig!==s)e.replay.enabled=!1,a={action:"disabled",index:h.index,reason:"sig-mismatch",card:h.chosenCard};else{const C=v(e),G=e.replay.divergenceIndex!==null&&e.replay.cursor===e.replay.divergenceIndex&&e.replay.forcedCard?e.replay.forcedCard:h.chosenCard,K=C.find(E=>g(E.suit,E.rank)===G);if(K){e.replay.cursor+=1;const E=h.chosenBucket,M=[...h.bucketCards];return e.replay.divergenceIndex!==null&&h.index===e.replay.divergenceIndex&&(e.replay.enabled=!1),{play:K,decisionSig:s,chosenBucket:E,bucketCards:M,replay:{action:"forced",index:h.index,card:G}}}else{const E=C.find(M=>F(e,M.seat,g(M.suit,M.rank)).classId===h.chosenClassId);if(!E)e.replay.enabled=!1,a={action:"disabled",index:h.index,reason:"card-not-legal",card:G};else{e.replay.cursor+=1;const M=h.chosenBucket,we=[...h.bucketCards];return e.replay.divergenceIndex!==null&&h.index===e.replay.divergenceIndex&&(e.replay.enabled=!1),{play:E,decisionSig:s,chosenBucket:M,bucketCards:we,replay:{action:"forced",index:h.index,card:g(E.suit,E.rank)}}}}}}const r=qt(e);if(r?.applied&&r.chosen){e.preferredDiscardUsed[e.turn]=!0;const{suit:h,rank:C}=$(r.chosen);return{play:{seat:e.turn,suit:h,rank:C},preferredDiscard:r,chosenBucket:"preferred",bucketCards:[r.chosen],decisionSig:s,replay:a}}if(t.kind==="randomLegal"){const h=v(e);return{play:oe(e),preferredDiscard:r??void 0,chosenBucket:"legal",bucketCards:h.map(C=>g(C.suit,C.rank)),decisionSig:s,replay:a}}if(t.kind!=="threatAware")return{play:null,preferredDiscard:r??void 0,decisionSig:s,replay:a};if(e.turn!=="E"&&e.turn!=="W")return{play:oe(e),preferredDiscard:r??void 0,decisionSig:s,replay:a};const i=e.trick[0]?.suit??null;if(!i){const h=v(e);return{play:oe(e),preferredDiscard:r??void 0,chosenBucket:"lead:none",bucketCards:h.map(C=>g(C.suit,C.rank)),decisionSig:s,replay:a}}if(e.hands[e.turn][i].length>0){const h=v(e);if(!e.threat||!e.threatLabels)return{play:oe(e),preferredDiscard:r??void 0,chosenBucket:"follow:baseline",bucketCards:h.map(w=>g(w.suit,w.rank)),decisionSig:s,replay:a};const C=ne(i,e.threat,e.threatLabels);if(!C)return{play:oe(e),preferredDiscard:r??void 0,chosenBucket:"follow:baseline",bucketCards:h.map(w=>g(w.suit,w.rank)),decisionSig:s,replay:a};const G=h.filter(w=>ee[w.rank]<ee[C]),K=h.filter(w=>ee[w.rank]>=ee[C]),E=G.length>0?G:K,M=Be(E.length,e.rng);return{play:E[M]??E[0]??h[0]??null,preferredDiscard:r??void 0,chosenBucket:G.length>0?"follow:below":"follow:above",bucketCards:E.map(w=>g(w.suit,w.rank)),decisionSig:s,replay:a}}if(!e.threat)return{play:null,preferredDiscard:r??void 0,decisionSig:s,replay:a};const o=e.threatLabels??{E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}},l=pt(e.turn,{hands:e.hands},i,e.threat,o),c=[{name:"tier1a",cards:l.tier1a},{name:"tier1b",cards:l.tier1b},{name:"tier1c",cards:l.tier1c},{name:"tier2a",cards:l.tier2a},{name:"tier2b",cards:l.tier2b},{name:"tier3a",cards:l.tier3a},{name:"tier3b",cards:l.tier3b},{name:"tier4",cards:l.tier4}].find(h=>h.cards.length>0)??{name:"tier4",cards:l.tier4},f=Be(c.cards.length,e.rng),p=c.cards[f]??c.cards[0],{suit:u,rank:y}=$(p);return{play:{seat:e.turn,suit:u,rank:y},preferredDiscard:r??void 0,chosenBucket:c.name,bucketCards:[...c.cards],decisionSig:s,replay:a}}function Xe(e,t,n,s,a,r,i,o){const l=[],d=g(t.suit,t.rank),c=F(e,t.seat,d).classId;if(!Yt(e.hands[t.seat],t.suit,t.rank))return l.push({type:"illegal",reason:`Card ${t.suit}${t.rank} not in ${t.seat} hand`}),l;if(e.trick.push({...t}),e.trickClassIds.push(`${t.seat}:${c}`),n==="autoplay"?l.push({type:n,play:{...t},preferredDiscard:s,chosenBucket:a,bucketCards:r,decisionSig:i,replay:o}):l.push({type:n,play:{...t}}),e.threat&&e.threatLabels){const h=lt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},g(t.suit,t.rank));e.threat=h.threat,e.threatLabels=h.labels,e.cardRoles={...h.perCardRole}}if(e.trick.length<4)return e.turn=Ft(e.turn),l;const p=e.trick.map(h=>({...h})),u=Jt(p,e.trumpSuit),y=Kt(u);return e.tricksWon[y]+=1,e.trick=[],e.trickClassIds=[],e.leader=u,e.turn=u,l.push({type:"trickComplete",winner:u,trick:p}),Ce(e.hands)&&(e.phase="end",l.push({type:"handComplete",success:zt(e.goal,e.tricksWon),tricksWon:{...e.tricksWon}})),l}function ve(e){const t=e.contract.strain==="NT"?null:e.contract.strain,n=Object.values(e.policies).some(o=>o?.kind==="threatAware");let s=null,a=null,r={};if(n){if(!e.threatCardIds||e.threatCardIds.length===0)throw new Error(`Problem ${e.id} uses threatAware policy but has no threatCardIds`);const o=Ye({hands:e.hands},e.threatCardIds);s=o.threat,a=o.labels,r={...o.perCardRole}}else if(e.threatCardIds&&e.threatCardIds.length>0){const o=Ye({hands:e.hands},e.threatCardIds);s=o.threat,a=o.labels,r={...o.perCardRole}}const i={id:e.id,contract:{...e.contract},trumpSuit:t,threat:s,threatLabels:a,cardRoles:r,hands:{N:z(e.hands.N),E:z(e.hands.E),S:z(e.hands.S),W:z(e.hands.W)},leader:e.leader,turn:e.leader,trick:[],trickClassIds:[],tricksWon:{NS:0,EW:0},phase:"awaitUser",rng:{seed:e.rngSeed>>>0,counter:0},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:_t(e),preferredDiscardUsed:{},replay:{enabled:!1,transcript:null,cursor:0,divergenceIndex:null,forcedCard:null}};return Ce(i.hands)?i.phase="end":i.phase=le(i)?"awaitUser":"auto",i}function v(e){if(e.phase==="end")return[];const t=e.hands[e.turn],n=e.trick[0]?.suit,s=n?t[n]??[]:[],a=n&&s.length>0?[n]:Fe,r=[];for(const i of a){const o=t[i]??[];for(const l of o)r.push({seat:e.turn,suit:i,rank:l})}return r}function Zt(e,t){const n=Mt(e),s=[];if(n.phase==="end")return s.push({type:"illegal",reason:"Hand already complete"}),{state:n,events:s};if(t.seat!==n.turn)return s.push({type:"illegal",reason:`Expected turn ${n.turn}, got ${t.seat}`}),n.phase=le(n)?"awaitUser":"auto",{state:n,events:s};if(!v(n).some(i=>i.seat===t.seat&&i.suit===t.suit&&i.rank===t.rank))return s.push({type:"illegal",reason:`Illegal play ${t.seat}:${t.suit}${t.rank}`}),n.phase=le(n)?"awaitUser":"auto",{state:n,events:s};for(s.push(...Xe(n,t,"played"));!le(n)&&!Ce(n.hands);){n.phase="auto";const i=n.policies[n.turn];if(!i){s.push({type:"illegal",reason:`No policy configured for auto seat ${n.turn}`});break}const o=Xt(n,i);if(!o.play){const l=v(n);s.push({type:"illegal",reason:`Autoplay failed for ${n.turn} (policy=${i?.kind??"none"}, legal=${l.length}${o.replay?.reason?`, replay=${o.replay.reason}`:""})`});break}s.push(...Xe(n,o.play,"autoplay",o.preferredDiscard,o.chosenBucket,o.bucketCards,o.decisionSig,o.replay))}return Ce(n.hands)?(n.phase="end",{state:n,events:s}):(n.phase=le(n)?"awaitUser":"auto",{state:n,events:s})}function en(e,t){return t.E.busy.has(e)||t.W.busy.has(e)}function tn(e,t){if(!t.threatCardIds.includes(e))return!1;const{suit:n}=e.length>=2?{suit:e[0]}:{suit:"S"},s=t.threatsBySuit[n];return!!(s?.active&&s.threatCardId===e)}function nn(e,t,n){const{suit:s}=e.length>=2?{suit:e[0]}:{suit:"S"},a=t.threatsBySuit[s];if(!a||!a.active||a.threatCardId!==e)return!1;const r=[...n.E.busy].some(o=>o.startsWith(s)),i=[...n.W.busy].some(o=>o.startsWith(s));return!r&&!i}function Ke(e,t,n,s){return s?nn(e,t,n)?"purple":tn(e,t)?"green":en(e,n)?"blue":"black":"black"}const rn=["S","H","D","C"],sn=["N","E","S","W"],T={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function an(e,t){return T[t]-T[e]}function We(e,t,n){return[...e.hands[t][n]].sort(an)}function Ae(e,t){const{suit:n,rank:s}=$(t);return sn.filter(a=>e.hands[a][n].includes(s))}function Ze(e){return e.length>0?e.join(","):"-"}function S(e){return e.length>0?e.join(" "):"-"}function te(e){return[...e].sort((t,n)=>{const s=$(t),a=$(n);return s.suit!==a.suit?s.suit.localeCompare(a.suit):T[a.rank]-T[s.rank]})}function Ie(e){return e?rn.filter(t=>!!e.threatsBySuit[t]):[]}function ze(e,t,n){const s=t.threatsBySuit[e];if(!s||!s.active)return!1;const a=[...n.E.busy].some(i=>i.startsWith(e)),r=[...n.W.busy].some(i=>i.startsWith(e));return!a&&!r}function bt(e,t){return!e||!t||e.threatCardIds.length===0?"rankColors: -":`rankColors: ${e.threatCardIds.map(s=>`${s}=${Ke(s,e,t,!0)}`).join(" ")}`}function gt(e,t){if(!e||!t)return"rankColorsBusy: -";const n=te([...t.E.busy,...t.W.busy]);if(n.length===0)return"rankColorsBusy: -";const s=r=>t.E.busy.has(r)?"E":t.W.busy.has(r)?"W":"-";return`rankColorsBusy: ${n.map(r=>`${s(r)}:${r}=${Ke(r,e,t,!0)}`).join(" ")}`}function on(e){const t=[];t.push(`[THREAT:init] problem=${e.problemId}`),t.push(`rawThreatCardIds=${e.threatCardIdsRaw.join(" ")||"-"}`);for(const n of e.threatCardIdsRaw)try{const s=$(n),a=Ae(e.position,n);t.push(`validate card=${n} parsed=(${s.suit},${s.rank}) owner=${a.length===1?a[0]:"-"} foundExactlyOnce=${a.length===1}`)}catch{t.push(`validate card=${n} parsed=(invalid) owner=- foundExactlyOnce=false`)}if(e.validationError)return t.push(`validation=ERROR ${e.validationError}`),t.join(`
`);if(t.push("validation=OK"),!e.ctx||!e.labels)return t.push("threatState=none"),t.join(`
`);for(const n of Ie(e.ctx)){const s=e.ctx.threatsBySuit[n];if(!s)continue;const a=Ae(e.position,s.threatCardId),r=a.length===1?a[0]:"-",i=r==="-"?[]:We(e.position,r,n);t.push(`threat suit=${n} card=${s.threatCardId} threatRank=${s.threatRank} initialOwner=${s.establishedOwner} currentOwner=${r} active=${s.active} threatLength=${s.threatLength} stopStatus=${s.stopStatus??"-"} ownerHolding=${Ze(i)} promotedWinner=${ze(n,e.ctx,e.labels)}`);for(const o of["E","W"]){const l=We(e.position,o,n),d=l.some(u=>T[u]>T[s.threatRank]),c=l.length>=s.threatLength&&d&&s.active&&s.threatLength>0,f=[...e.labels[o].busy].filter(u=>u.startsWith(n)),p=[...e.labels[o].idle].filter(u=>u.startsWith(n));t.push(`labels suit=${n} defender=${o} holding=${Ze(l)} hasOver=${d} length=${l.length} busy=${c} busyCards=${S(f)} idleCards=${S(p)}`)}}return t.push(bt(e.ctx,e.labels)),t.push(gt(e.ctx,e.labels)),t.join(`
`)}function ln(e){const t=[];t.push(`[THREAT:after-trick] index=${e.trickIndex} leader=${e.leader} trick=${e.trick.map(r=>`${r.seat}:${g(r.suit,r.rank)}`).join(" ")}`);const n=new Set(e.trick.map(r=>r.suit)),s=new Set([...Ie(e.beforeCtx),...Ie(e.afterCtx)]),a=[...n].filter(r=>s.has(r));t.push(`touchedThreatSuits=${a.join(" ")||"-"}`);for(const r of a){const i=e.beforeCtx?.threatsBySuit[r],o=e.afterCtx?.threatsBySuit[r];if(!o)continue;const l=Ae(e.position,o.threatCardId),d=l.length===1?l[0]:"-";t.push(`suit=${r} threatCard=${o.threatCardId} currentOwner=${d} initialOwner=${o.establishedOwner}`);for(const p of["E","W"]){const u=We(e.position,p,r),y=u.some(h=>T[h]>T[o.threatRank]);t.push(`suit=${r} defender=${p} length=${u.length} hasOver=${y}`)}if(i?.active&&!o.active){t.push(`suit=${r} THREAT OFF reason=designated-card-owner-changed initialOwner=${o.establishedOwner} currentOwner=${d}`);continue}const c=i?.threatLength??0,f=o.threatLength;t.push(`suit=${r} active=${o.active} threatLength ${c}->${f}`),e.afterLabels&&t.push(`suit=${r} promotedWinner=${ze(r,e.afterCtx,e.afterLabels)}`);for(const p of["E","W"]){const u=e.beforeLabels?te([...e.beforeLabels[p].busy].filter(C=>C.startsWith(r))):[],y=e.afterLabels?te([...e.afterLabels[p].busy].filter(C=>C.startsWith(r))):[],h=e.afterLabels?te([...e.afterLabels[p].idle].filter(C=>C.startsWith(r))):[];t.push(`suit=${r} defender=${p} busyCards ${S(u)} -> ${S(y)}`),S(u)!==S(y)&&t.push(`suit=${r} defender=${p} busyNow=${S(y)} idleNow=${S(h)}`)}}if(e.afterLabels){const r=[...e.afterLabels.E.busy].sort(),i=[...e.afterLabels.W.busy].sort();t.push(`busySummary E=${S(r)} | W=${S(i)}`)}return t.push(bt(e.afterCtx,e.afterLabels)),t.push(gt(e.afterCtx,e.afterLabels)),t.join(`
`)}function cn(e){const t=[];t.push(`[THREAT:after-play] seat=${e.play.seat} played=${g(e.play.suit,e.play.rank)}`);const n=e.play.suit,s=e.beforeCtx?.threatsBySuit[n]||e.afterCtx?.threatsBySuit[n]?[n]:[];t.push(`dirtyThreatSuits=${s.join(" ")||"-"}`);for(const a of s){const r=e.beforeCtx?.threatsBySuit[a],i=e.afterCtx?.threatsBySuit[a];if(i){t.push(`suit=${a} active=${i.active} threatLength ${r?.threatLength??0}->${i.threatLength} stopStatus=${r?.stopStatus??"-"}->${i.stopStatus??"-"}`);for(const o of["E","W"]){const l=e.beforeLabels?te([...e.beforeLabels[o].busy].filter(c=>c.startsWith(a))):[],d=e.afterLabels?te([...e.afterLabels[o].busy].filter(c=>c.startsWith(a))):[];t.push(`suit=${a} defender=${o} busyCards ${S(l)} -> ${S(d)}`)}e.afterCtx&&e.afterLabels&&t.push(`suit=${a} promotedWinner=${ze(a,e.afterCtx,e.afterLabels)}`)}}return t.join(`
`)}function un(e){let t="tier4";e.tier1a.includes(e.chosen)?t="tier1a":e.tier1b.includes(e.chosen)?t="tier1b":e.tier1c.includes(e.chosen)?t="tier1c":e.tier2a.includes(e.chosen)?t="tier2a":e.tier2b.includes(e.chosen)?t="tier2b":e.tier3a.includes(e.chosen)?t="tier3a":e.tier3b.includes(e.chosen)&&(t="tier3b");const n=[...new Set(e.legal.map(r=>$(r).suit))],s=e.defender==="E"?"W":"E",a=[`[THREAT:discard] defender=${e.defender} ledSuit=${e.ledSuit??"none"} trump=${e.trumpStrain}`,`legal=${S(e.legal)}`,`tier1a=${S(e.tier1a)}`,`tier1b=${S(e.tier1b)}`,`tier1c=${S(e.tier1c)}`,`tier2a=${S(e.tier2a)}`,`tier2b=${S(e.tier2b)}`,`tier3a=${S(e.tier3a)}`,`tier3b=${S(e.tier3b)}`,`tier4=${S(e.tier4)}`,`chosenTier=${t} chosen=${e.chosen}`,`rng=${e.rngState?`seed:${e.rngState.seed} counter:${e.rngState.counter}`:"n/a"}`];for(const r of n){const i=e.ctx?.threatsBySuit[r];i&&a.push(`threat suit=${r} active=${i.active} threatRank=${i.threatRank} threatLength=${i.threatLength} stopStatus=${i.stopStatus??"-"}`)}if(e.ctx&&e.labels){const r=e.ctx,i=e.labels,o=n.map(l=>{const d=ne(l,r,i);return d?`${l}=${d}`:null}).filter(l=>!!l);a.push(`thresholds=${o.length>0?o.join(" "):"-"}`)}for(const r of e.legal){const{suit:i,rank:o}=$(r),l=!!e.labels?.[e.defender].busy.has(r),d=!!e.labels?.[e.defender].idle.has(r),c=e.ctx?.threatsBySuit[i],f=!!c?.active,p=!!(e.labels&&[...e.labels[e.defender].busy].some(C=>C.startsWith(i))),u=!!(e.labels&&[...e.labels[s].busy].some(C=>C.startsWith(i))),y=f&&p&&u,h=!!(l&&c&&c.active&&T[o]<T[c.threatRank]);a.push(`candidate ${r} status=${d?"idle":l?"busy":"unknown"} group=${y?"coordinated":"solo"} belowThreat=${h}`)}if(e.ctx&&e.labels){const r=Dt(e.defender,e.legal,e.ctx,e.labels),i=l=>l??"-",o=l=>String(T[l]);a.push("[THREAT:discard:explainTier1]"),a.push(`defender=${e.defender} ledSuit=${e.ledSuit??"none"} trump=${e.trumpStrain}`),a.push(`activeThreats=${r.activeThreats.length>0?r.activeThreats.map(l=>`${l.suit}(active=${l.active} threatRank=${l.threatRank} promotedWinnerRank=${i(l.promotedWinnerRank)} threshold=${l.threshold} stopStatus=${l.stopStatus})`).join(" "):"-"}`);for(const l of r.cards)a.push(`card=${l.cardId} suit=${l.suit} rank=${o(l.rank)} label=${l.label} idle=${l.idle} suitActiveThreat=${l.suitActiveThreat} threshold=${i(l.threshold)} rank<threshold?=${l.rankBelowThreshold===null?"-":l.rankBelowThreshold} tier1a?=${l.tier1a} tier1b?=${l.tier1b} tier1c?=${l.tier1c}`);a.push(`tier1Integrity idleLegal=${r.idleLegal.length} tier1sum=${r.tier1a.length+r.tier1b.length+r.tier1c.length} ok=${r.integrityOk}`),r.integrityOk||a.push(`tier1Integrity ERROR missing=${S(r.missing)} overlap=${S(r.overlap)}`)}return a.join(`
`)}const dn={id:"p001",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:[],H:[],D:["A","K","Q"],C:[]},S:{S:["5"],H:[],D:["2"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8"]},hn={id:"p002",contract:{strain:"C"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:7},hands:{N:{S:["A","Q","9","5","4"],H:["A","K","2"],D:[],C:[]},W:{S:["J","T","8"],H:["Q","T","8"],D:["A","Q"],C:[]},E:{S:["K","7","6"],H:["J","9","7"],D:["K","J"],C:[]},S:{S:[],H:["4","3"],D:["6","5","4"],C:["T","9","8"]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},threatCardIds:["S9","H2","D5"],preferredDiscards:{W:"DA",E:"H7"},rngSeed:202},fn={id:"p003",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:["Q","T"],H:[],D:["A"],C:[]},S:{S:["5"],H:[],D:["8"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8","D8"]},ie=[{id:"p001",label:"p001",problem:dn},{id:"p002",label:"p002",problem:hn},{id:"p003",label:"p003",problem:fn}],Ct=document.querySelector("#app");if(!Ct)throw new Error("Missing #app");const L=Ct,de=["N","E","S","W"],St=["S","H","D","C"],ce=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],$t={S:"♠",H:"♥",D:"♦",C:"♣"},pn={N:"North",E:"East",S:"South",W:"West"},et=Math.max(...ie.flatMap(({problem:e})=>de.flatMap(t=>St.map(n=>e.hands[t][n].length)))),yn=12,kn=4,bn=9,gn=4,Cn=4,Sn=6,Qe=14,$n=16,mn=3,vn=8,En=Math.round(Qe*.6),wn=Math.round(Qe*.6),Ln=yn+kn+et*bn+Math.max(0,et-1)*gn+Cn,mt=$n+mn+Qe*4+vn+Sn,vt=mt+6;L.style.setProperty("--hand-box-w",`${Ln}px`);L.style.setProperty("--hand-box-h",`${mt}px`);L.style.setProperty("--trick-box-w",`${vt}px`);L.style.setProperty("--trick-box-h",`${vt}px`);L.style.setProperty("--table-gap-y",`${En}px`);L.style.setProperty("--table-gap-x",`${wn}px`);L.style.setProperty("--slot-offset","12%");let P=ie[0].problem,j=ie[0].id,W=P.rngSeed>>>0,k=ve({...P,rngSeed:W}),b=[],O=[],D=!1,Ne=!0,Le=!0,Te=!0,B=!1,re=null,_=null,se=!1,q=null,X=null;const fe=[];let ae=[],m=null;const he=new Set;let Y=[],x="running",H=!1,N=null,Q=null;function xn(e){const t=new Map(ce.map((n,s)=>[n,s]));return[...e].sort((n,s)=>(t.get(n)??99)-(t.get(s)??99))}function V(e){return`${e.seat}:${e.suit}${Et(e.rank)}`}function De(e){return{hands:e.hands}}function Bn(e){return Array.isArray(e.threatCardIds)?[...e.threatCardIds]:[]}function Et(e){return e==="T"?"10":e}function Re(e){if(!q||!X)return"rank--black";const t=Ke(e,q,X,Te);return t==="purple"?"rank--purple":t==="green"?"rank--green":t==="blue"?"rank--blue":"rank--black"}function Pe(e,t,n){const s=document.createElement("span");if(s.className=`rank ${n}`,t!=="T"){s.textContent=Et(t),e.appendChild(s);return}const a=document.createElement("span");a.className=`rank ten ${n}`;const r=document.createElement("span");r.className="digit-one",r.textContent="1";const i=document.createElement("span");i.className="digit-zero",i.textContent="0",a.append(r,i),e.appendChild(a)}function Wn(e){return e.type==="played"?`played ${V(e.play)}`:e.type==="autoplay"?`autoplay ${V(e.play)}`:e.type==="illegal"?`illegal ${e.reason}`:e.type==="trickComplete"?`trickComplete winner=${e.winner} trick=${e.trick.map(V).join(" ")}`:`handComplete success=${e.success} NS=${e.tricksWon.NS} EW=${e.tricksWon.EW}`}function An(e){return e==="N"||e==="S"?"NS":"EW"}function In(e){const t=de.indexOf(e);return de[(t+1)%de.length]}function Z(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,hands:{N:{S:[...e.hands.N.S],H:[...e.hands.N.H],D:[...e.hands.N.D],C:[...e.hands.N.C]},E:{S:[...e.hands.E.S],H:[...e.hands.E.H],D:[...e.hands.E.D],C:[...e.hands.E.C]},S:{S:[...e.hands.S.S],H:[...e.hands.S.H],D:[...e.hands.S.D],C:[...e.hands.S.C]},W:{S:[...e.hands.W.S],H:[...e.hands.W.H],D:[...e.hands.W.D],C:[...e.hands.W.C]}},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:e.replay.transcript?{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,transcript:{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}}:{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,transcript:null}}}function wt(e){return e?{threatCardIds:[...e.threatCardIds],threatsBySuit:{...e.threatsBySuit}}:null}function Lt(e){return e?{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}:null}function xt(e){return e?e.map(t=>({...t})):null}function Nn(e){return{state:Z(k),currentProblemId:j,currentSeed:W,logs:[...b],deferredLogLines:[...O],trickFrozen:B,lastCompletedTrick:xt(re),frozenViewState:_?Z(_):null,canLeadDismiss:se,threatCtx:wt(q),threatLabels:Lt(X),play:{...e},runStatus:x,playAgainAvailable:H,playAgainUnavailableReason:N,playAgainLastCandidateIndex:Q}}function Tn(e){k=Z(e.state),j=e.currentProblemId,P=ie.find(t=>t.id===j)?.problem??P,W=e.currentSeed,b=[...e.logs],O=[...e.deferredLogLines],B=e.trickFrozen,re=xt(e.lastCompletedTrick),_=e.frozenViewState?Z(e.frozenViewState):null,se=e.canLeadDismiss,q=wt(e.threatCtx),X=Lt(e.threatLabels),x=e.runStatus,H=e.playAgainAvailable,N=e.playAgainUnavailableReason,Q=e.playAgainLastCandidateIndex}function Oe(e,t,n,s,a){return`${e}|${t}|${n}|${s}|${a}`}function Bt(e,t){if(!e||e.decisions.length===0)return{ok:!1,reason:"no-untried-same-bucket-alternatives"};for(let n=e.decisions.length-1;n>=0;n-=1){const s=e.decisions[n];if(s.sameBucketAlternativeClassIds.find(r=>!t.has(Oe(e.problemId,e.seed,s.index,s.chosenBucket,r))))return{ok:!0,lastCandidateIndex:s.index}}return{ok:!1,reason:"no-untried-same-bucket-alternatives"}}function ke(e,t){const n=e.hands[t];return n.S.length+n.H.length+n.D.length+n.C.length}function Dn(e){return e.length>0?e.map(V).join(" "):"-"}function Rn(e){return[`snapshot phase=${e.phase}`,`turn=${e.turn}`,`leader=${e.leader}`,`trick=${Dn(e.trick)}`,`rem=N:${ke(e,"N")} E:${ke(e,"E")} S:${ke(e,"S")} W:${ke(e,"W")}`,`won=NS:${e.tricksWon.NS} EW:${e.tricksWon.EW}`].join(" ")}function Se(e,t){if(t.type==="played"||t.type==="autoplay"){const n=g(t.play.suit,t.play.rank),s=F(e,t.play.seat,n).classId,a=e.hands[t.play.seat][t.play.suit],r=a.indexOf(t.play.rank);if(r>=0&&a.splice(r,1),e.trick.push({...t.play}),e.trickClassIds.push(`${t.play.seat}:${s}`),e.threat&&e.threatLabels){const i=lt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},g(t.play.suit,t.play.rank));e.threat=i.threat,e.threatLabels=i.labels,e.cardRoles={...i.perCardRole}}e.turn=In(e.turn);return}if(t.type==="trickComplete"){e.trick=[],e.trickClassIds=[],e.leader=t.winner,e.turn=t.winner,e.tricksWon[An(t.winner)]+=1;return}t.type==="handComplete"&&(e.phase="end",e.tricksWon={...t.tricksWon})}function xe(e,t,n,s){const a=[],r=Z(e);for(const i of n){if(D&&i.type==="autoplay"){if(i.replay?.action==="forced"&&a.push(`[PLAYAGAIN] forcing index=${i.replay.index??"?"} card=${i.replay.card??`${i.play.suit}${i.play.rank}`}`),i.replay?.action==="disabled"&&a.push(`[PLAYAGAIN] replay disabled due to ${i.replay.reason??"mismatch"}`),i.preferredDiscard){const c=i.preferredDiscard;c.applied&&c.chosen?a.push(`[PREFDISC] seat=${i.play.seat} applied preferred discard=${c.chosen}`):a.push(`[PREFDISC] seat=${i.play.seat} preferred=${c.preferred.join("/")} not-applied reason=${c.reason}`)}const o=r.trick[0]?.suit??"none",l=v(r).length;if(a.push(`autoplayDecision seat=${r.turn} leadSuit=${o} legal=${l} chosen=${V(i.play)}`),r.policies[r.turn]?.kind==="threatAware"&&r.trick.length>0&&r.hands[r.turn][r.trick[0].suit].length>0){const c=r.trick[0].suit,f=v(r).map(u=>`${u.suit}${u.rank}`),p=r.threat&&r.threatLabels?ne(c,r.threat,r.threatLabels):null;if(p){const u=v(r).filter(h=>ce.indexOf(h.rank)>ce.indexOf(p)).map(h=>`${h.suit}${h.rank}`),y=v(r).filter(h=>ce.indexOf(h.rank)<=ce.indexOf(p)).map(h=>`${h.suit}${h.rank}`);a.push(`[THREAT:follow] defender=${r.turn} ledSuit=${c} threshold=${p}`),a.push(`inSuit=${f.join(" ")||"-"} below=${u.join(" ")||"-"} above=${y.join(" ")||"-"} chosen=${i.play.suit}${i.play.rank}`)}else a.push(`[THREAT:follow] defender=${r.turn} ledSuit=${c} threshold=- inSuit=${f.join(" ")||"-"} chosen=${i.play.suit}${i.play.rank} (baseline)`)}if((r.turn==="E"||r.turn==="W")&&r.trick.length>0&&r.hands[r.turn][r.trick[0].suit].length===0&&r.threat&&r.threatLabels){const c=r.trick[0].suit,f=r.threat,p=r.threatLabels,u=pt(r.turn,De(r),c,f,p);a.push(un({defender:r.turn,ledSuit:c,trumpStrain:r.contract.strain,ctx:f,labels:p,legal:u.legal,tier1a:u.tier1a,tier1b:u.tier1b,tier1c:u.tier1c,tier2a:u.tier2a,tier2b:u.tier2b,tier3a:u.tier3a,tier3b:u.tier3b,tier4:u.tier4,chosen:g(i.play.suit,i.play.rank),rngState:{seed:s.rng.seed,counter:s.rng.counter}}))}}if(a.push(Wn(i)),D&&(i.type==="played"||i.type==="autoplay")){const o=r.threat,l=r.threatLabels;Se(r,i);const d=r.threat,c=r.threatLabels;a.push(cn({play:i.play,beforeCtx:o,afterCtx:d,beforeLabels:l,afterLabels:c}))}else Se(r,i);if(D&&i.type==="illegal"){const o=r.trick[0]?.suit??"none",l=v(r).slice(0,10).map(V).join(" ");a.push(`illegalContext attempted=${V(t)} turn=${r.turn} leadSuit=${o} legal=${l||"-"}`)}if(i.type==="trickComplete"&&D&&r.threat&&r.threatLabels){const o=r.tricksWon.NS+r.tricksWon.EW+1;a.push(ln({trickIndex:o,leader:r.leader,trick:i.trick,beforeCtx:r.threat,afterCtx:r.threat,beforeLabels:r.threatLabels,afterLabels:r.threatLabels,position:De(r)}))}}return D&&a.push(Rn(s)),a}function Pn(e,t){const n=Z(e);for(const s of t){if(s.type==="autoplay"&&(s.play.seat==="E"||s.play.seat==="W")&&s.decisionSig){const a=g(s.play.suit,s.play.rank),r=s.bucketCards?[...s.bucketCards]:[a],i=[],o={};for(const d of r){const c=F(n,s.play.seat,d);i.includes(c.classId)||i.push(c.classId),o[c.classId]||(o[c.classId]=c.representative)}const l=F(n,s.play.seat,a).classId;ae.push({index:ae.length,seat:s.play.seat,sig:s.decisionSig,chosenCard:a,chosenClassId:l,chosenBucket:s.chosenBucket??"unknown",bucketCards:r,sameBucketAlternativeClassIds:i.filter(d=>d!==l),representativeCardByClass:o})}Se(n,s)}}function On(e){const t=e.goal;return t.type==="minTricks"?`${t.side} ${t.n} tricks`:"Unknown goal"}function Hn(){return B&&_?_:k}function pe(e){B=!1,re=null,_=null,se=!1,e&&O.length>0&&(b=[...b,...O].slice(-500),O=[])}function Ee(e,t){t&&(b=[]);const n=Bn(P);q=k.threat??null,X=k.threatLabels??null,n.length!==0&&D&&(b=[...b,on({problemId:e,threatCardIdsRaw:n,position:De(k),ctx:q,labels:X})].slice(-500))}function tt(e,t){W=e>>>0,k=ve({...P,rngSeed:W}),b=[...b,`${t} seed=${W}`].slice(-500),x="running",H=!1,N=null,Q=null,ae=[],Y=[],fe.length=0,O=[],pe(!1),Ee(j,!1),A()}function Un(e){const t=ie.find(n=>n.id===e);t&&(P=t.problem,j=t.id,W=P.rngSeed>>>0,k=ve({...P,rngSeed:W}),x="running",H=!1,N=null,Q=null,ae=[],Y=[],m=null,he.clear(),fe.length=0,O=[],pe(!1),Ee(j,!0),A())}function jn(){const e=fe.pop();e&&(Tn(e),b=[...b,`[UNDO] restored snapshot before user play: ${e.play.seat}:${g(e.play.suit,e.play.rank)}`].slice(-500),A())}function Gn(e){if(k.replay.enabled&&k.replay.transcript&&(e.seat==="N"||e.seat==="S")){const r=g(e.suit,e.rank),i=F(k,e.seat,r).classId,o=k.replay.transcript.userPlays[Y.length];if(o&&o.playClassId!==i)k.replay.enabled=!1,b=[...b,`[PLAYAGAIN] replay disabled due to user class mismatch expected=${o.playClassId} actual=${i}`].slice(-500);else if(D){const l=F(k,e.seat,r);b=[...b,`[EQ] seat=${e.seat} played=${r} class=${l.classId} rep=${l.representative}`].slice(-500)}}if(e.seat==="N"||e.seat==="S"){const r=g(e.suit,e.rank),i=F(k,e.seat,r).classId;Y.push({index:Y.length,seat:e.seat,playClassId:i})}fe.push(Nn(e)),B&&pe(!0);const t=k,n=Zt(k,e);k=n.state,q=k.threat??null,X=k.threatLabels??null;const s=n.events.findIndex(r=>r.type==="trickComplete");if(Pn(t,n.events),s>=0){const r=n.events.slice(0,s+1),i=n.events.slice(s+1),o=Z(t);for(const c of r)Se(o,c);B=!0,_=o;const l=r[r.length-1];l.type==="trickComplete"&&(re=l.trick.map(c=>({...c}))),se=k.phase!=="end"&&k.trick.length===0&&k.userControls.includes(k.turn);const d=xe(t,e,r,o);if(b=[...b,...d].slice(-500),i.length>0){const c=xe(o,e,i,k);O=[...O,...c].slice(-500)}}else{const r=xe(t,e,n.events,k);b=[...b,...r].slice(-500)}const a=n.events.find(r=>r.type==="handComplete");if(a?.type==="handComplete"&&a.success){m={problemId:j,seed:W,decisions:ae.map(i=>({...i,bucketCards:[...i.bucketCards],sameBucketAlternativeClassIds:[...i.sameBucketAlternativeClassIds],representativeCardByClass:{...i.representativeCardByClass}})),userPlays:Y.map(i=>({...i}))},b=[...b,`[PLAYAGAIN] recorded transcript ${m.decisions.length} decisions`].slice(-500);const r=Bt(m,he);H=r.ok,N=r.ok?null:r.reason??"no-untried-same-bucket-alternatives",Q=r.lastCandidateIndex??null,b=[...b,r.ok?`[PLAYAGAIN] availability ok=true lastCandidateIndex=${r.lastCandidateIndex}`:`[PLAYAGAIN] availability ok=false reason=${N}`].slice(-500)}if(a?.type==="handComplete"){const r=a.success?"success":"failure";D&&(b=[...b,`[GOAL] endOfRun=true NSwon=${a.tricksWon.NS} EWwon=${a.tricksWon.EW} required${k.goal.side}>=${k.goal.n} success=${a.success}`,`[RUNSTATUS] ${x} -> ${r}`].slice(-500)),x=r}A()}function Mn(){const e=Bt(m,he);if(H=e.ok,N=e.ok?null:e.reason??"no-untried-same-bucket-alternatives",Q=e.lastCandidateIndex??null,!e.ok||!m){b=[...b,`[PLAYAGAIN] availability ok=false reason=${N}`].slice(-500),A();return}const t=m?.seed??W;k=ve({...P,rngSeed:t});let n=null,s=null;for(let a=m.decisions.length-1;a>=0;a-=1){const r=m.decisions[a],i=r.sameBucketAlternativeClassIds.find(o=>!he.has(Oe(m.problemId,m.seed,r.index,r.chosenBucket,o)));if(i){if(n=r.index,s=r.representativeCardByClass[i]??null,he.add(Oe(m.problemId,m.seed,r.index,r.chosenBucket,i)),!s)continue;b=[...b,`[PLAYAGAIN] divergenceIndex=${n} forcedCard=${s}`].slice(-500);break}}if(!s||n===null){H=!1,N="no-untried-same-bucket-alternatives",Q=null,b=[...b,`[PLAYAGAIN] availability ok=false reason=${N}`].slice(-500),A();return}k.replay={enabled:!0,transcript:{problemId:m.problemId,seed:m.seed,decisions:m.decisions.map(a=>({...a,bucketCards:[...a.bucketCards],sameBucketAlternativeClassIds:[...a.sameBucketAlternativeClassIds],representativeCardByClass:{...a.representativeCardByClass}})),userPlays:m.userPlays.map(a=>({...a}))},cursor:0,divergenceIndex:n,forcedCard:s},W=t,x="running",H=!1,N=null,Q=null,ae=[],Y=[],O=[],pe(!1),Ee(j,!1),b=[...b,"[PLAYAGAIN] replay enabled"].slice(-500),A()}function Fn(e,t,n,s,a){const r=document.createElement("div");r.className="suit-row";const i=document.createElement("span");i.className=`suit-symbol suit-${n}`,i.textContent=$t[n],r.appendChild(i);const o=document.createElement("div");o.className="cards";const l=xn(e.hands[t][n]);if(l.length>0)for(const d of l){const c=`${n}${d}`;if(a&&s.has(c)){const p=document.createElement("button");p.type="button",p.className="rank-text legal",Pe(p,d,Re(g(n,d))),p.onclick=()=>Gn({seat:t,suit:n,rank:d}),o.appendChild(p)}else{const p=document.createElement("span");p.className="rank-text muted",Pe(p,d,Re(g(n,d))),o.appendChild(p)}}return r.appendChild(o),r}function be(e,t){const n=document.createElement("section"),s=e.turn===t;n.className=`hand seat-${t}`;const a=document.createElement("div");a.className="hand-head",a.innerHTML=`<strong class="seat-name${s?" active-seat-name":""}">${pn[t]}</strong>`,n.appendChild(a);const r=!B&&s?v(e):[],i=new Set(r.map(d=>`${d.suit}${d.rank}`)),o=!B&&e.phase!=="end"&&e.userControls.includes(t)&&s;if(B&&se&&k.userControls.includes(k.turn)&&t===k.turn){const d=v(k);for(const c of d)i.add(`${c.suit}${c.rank}`)}const l=o||B&&se&&t===k.turn;for(const d of St)n.appendChild(Fn(e,t,d,i,l));return n}function Kn(e){const t=document.createElement("section");t.className=`trick-table${B?" frozen":""}`,B&&(t.title="Click to dismiss trick",t.onclick=()=>{pe(!0),A()});const n=B&&re?re:e.trick,s=new Map(n.map(a=>[a.seat,a]));for(const a of de){const r=document.createElement("div");r.className=`trick-slot slot-${a}`;const i=s.get(a);if(i){const o=document.createElement("span");o.className="played-text";const l=document.createElement("span");l.className=`played-suit suit-${i.suit}`,l.textContent=$t[i.suit];const d=document.createElement("span");d.className="played-rank",Pe(d,i.rank,Re(g(i.suit,i.rank))),o.append(l,d),r.appendChild(o)}t.appendChild(r)}return t}function zn(e){const t=document.createElement("section");t.className="status-panel";const n=document.createElement("div");n.className="status-head";const s=document.createElement("strong");s.textContent="Status",n.appendChild(s);const a=document.createElement("div");a.className="controls";const r=document.createElement("button");r.type="button",r.textContent="Reset",r.onclick=()=>tt(W,"reset"),a.appendChild(r);const i=document.createElement("button");i.type="button",i.textContent="Backup",i.disabled=fe.length===0,i.onclick=()=>jn(),a.appendChild(i);const o=document.createElement("button");o.type="button",o.textContent="New seed",o.onclick=()=>tt(Date.now()>>>0,"newSeed"),a.appendChild(o);const l=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=Ne,d.onchange=()=>{Ne=d.checked,A()},l.append(d," Show log"),a.appendChild(l);const c=document.createElement("label"),f=document.createElement("input");f.type="checkbox",f.checked=D,f.onchange=()=>{D=f.checked,A()},c.append(f," Verbose log"),a.appendChild(c),n.appendChild(a),t.appendChild(n);const p=document.createElement("div");return p.className="status-facts",p.innerHTML=`
    <div><span class="k">Contract</span><span class="v">${e.contract.strain}</span></div>
    <div><span class="k">Goal</span><span class="v">${On(e)}</span></div>
    <div class="tricks"><span class="k">Tricks</span><span class="v heavy">NS ${e.tricksWon.NS} - EW ${e.tricksWon.EW}</span></div>
    <div class="meta-row"><span class="k">Leader</span><span class="v turn-meta">${e.leader}</span></div>
    <div class="meta-row"><span class="k">Turn</span><span class="v turn-meta turn-emph">${e.turn}</span></div>
    <div class="meta-row"><span class="k">Seed</span><span class="v seed">${W}</span></div>
  `,t.appendChild(p),t}function A(){const e=Hn();L.innerHTML="";const t=document.createElement("section");t.className="board-shell";const n=document.createElement("div");n.className="table-host";const s=document.createElement("div");s.className="table-tools";const a=document.createElement("label");a.textContent="Puzzle: ";const r=document.createElement("select");for(const f of ie){const p=document.createElement("option");p.value=f.id,p.textContent=f.label,p.selected=f.id===j,r.appendChild(p)}r.onchange=()=>{Un(r.value)},a.appendChild(r),s.appendChild(a);const i=document.createElement("label"),o=document.createElement("input");o.type="checkbox",o.checked=Le,o.onchange=()=>{Le=o.checked,A()},i.append(o," Show guides"),s.appendChild(i);const l=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=Te,d.onchange=()=>{Te=d.checked,A()},l.append(d," Teaching mode"),s.appendChild(l),n.appendChild(s);const c=document.createElement("main");if(c.className=`table-canvas${Le?" show-guides":""}`,c.appendChild(Kn(e)),c.appendChild(be(e,"N")),c.appendChild(be(e,"W")),c.appendChild(be(e,"E")),c.appendChild(be(e,"S")),n.appendChild(c),t.appendChild(n),t.appendChild(zn(e)),L.appendChild(t),x==="success"||x==="failure"){const f=document.createElement("div");f.className=`banner ${x==="success"?"ok":"fail"}`,f.textContent=x==="success"?"Success - goal achieved":"Not enough tricks - try again",L.appendChild(f)}if(x==="success"&&H){const f=document.createElement("button");f.type="button",f.textContent="Play Again",f.onclick=()=>Mn(),L.appendChild(f)}if(x==="success"&&!H){const f=document.createElement("div");f.className="banner",f.textContent="No 'Play Again' variations available: defenders had no same-tier alternatives to explore.",L.appendChild(f)}if(Ne){const f=document.createElement("section");f.className="log-panel";const p=document.createElement("strong");p.textContent="Log",f.appendChild(p);const u=document.createElement("div");u.className="log",u.textContent=b.length>0?b.join(`
`):"No events yet",f.appendChild(u),L.appendChild(f),u.scrollTop=u.scrollHeight}}Ee(j,!1);A();
