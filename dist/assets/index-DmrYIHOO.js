(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const Oe=["S","H","D","C"],rt=["E","W"],$t={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function q(e){const t=e.slice(0,1),n=e.slice(1);if(!Oe.includes(t)||!(n in $t))throw new Error(`Invalid CardId: ${e}`);return{suit:t,rank:n}}function k(e,t){return`${e}${t}`}function V(e){return $t[e]}function Et(e,t){const{suit:n,rank:r}=q(t),s=[],a=["N","E","S","W"];for(const i of a)e.hands[i][n].includes(r)&&s.push(i);return s}function xt(e,t,n,r){return e.hands[t][n].filter(s=>V(s)>=V(r)).length}function zt(e,t){const n={};for(const r of t){const{suit:s,rank:a}=q(r);if(n[s])throw new Error(`Duplicate threat suit: ${s}`);const i=Et(e,r);if(i.length!==1)throw new Error(`Threat card ${r} must exist in exactly one hand (found ${i.length})`);const l=i[0];n[s]={suit:s,threatCardId:r,threatRank:a,establishedOwner:l,active:!0,threatLength:xt(e,l,s,a)}}return{threatsBySuit:n,threatCardIds:[...t]}}function Vt(e,t){const n={E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}};for(const r of rt)for(const s of Oe){for(const c of t.hands[r][s])n[r].idle.add(k(s,c));const a=e.threatsBySuit[s];if(!a||!a.active||a.threatLength<=0)continue;const i=t.hands[r][s],l=i.some(c=>V(c)>V(a.threatRank)),o=i.length>=a.threatLength;if(!l||!o)continue;const f=[...i].sort((c,d)=>V(d)-V(c)).slice(0,a.threatLength);for(const c of f){const d=k(s,c);n[r].idle.delete(d),n[r].busy.add(d)}}return n}function Jt(e){return{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}}function ut(e,t,n){return[...e[t].busy].some(r=>q(r).suit===n)}function st(e,t,n){const r=e.threatsBySuit[n];if(!r||!r.active)return;const s=ut(t,"E",n),a=ut(t,"W",n);return s&&a?"double":s||a?"single":"none"}function It(e,t,n){const r=e.threatsBySuit[n];return!r||!r.active?!1:(r.stopStatus??st(e,t,n))==="none"}function _t(e,t,n){return It(e,t,n)?e.threatsBySuit[n]?.threatRank??null:null}function Xt(e,t,n,r){for(const s of rt){for(const c of[...n[s].busy])q(c).suit===r&&n[s].busy.delete(c);for(const c of[...n[s].idle])q(c).suit===r&&n[s].idle.delete(c);for(const c of t.hands[s][r])n[s].idle.add(k(r,c));const a=e.threatsBySuit[r];if(!a||!a.active||a.threatLength<=0)continue;const i=t.hands[s][r],l=i.some(c=>V(c)>V(a.threatRank)),o=i.length>=a.threatLength;if(!l||!o)continue;const f=[...i].sort((c,d)=>V(d)-V(c)).slice(0,a.threatLength);for(const c of f){const d=k(r,c);n[s].idle.delete(d),n[s].busy.add(d)}}}function At(e,t,n,r,s){for(const l of Object.keys(e))q(l).suit===s&&delete e[l];const a=["N","E","S","W"];for(const l of a)for(const o of r.hands[l][s]){const f=k(s,o);e[f]="default"}for(const l of rt){for(const o of n[l].idle)q(o).suit===s&&(e[o]="idle");for(const o of n[l].busy)q(o).suit===s&&(e[o]="busy")}const i=t.threatsBySuit[s];i?.active&&(e[i.threatCardId]="threat",It(t,n,s)&&(e[i.threatCardId]="promotedWinner"))}function ft(e,t){const n=zt(e,t),r=Vt(n,e);for(const a of Oe){const i=n.threatsBySuit[a];i&&(n.threatsBySuit[a]={...i,stopStatus:st(n,r,a)})}const s={};for(const a of Oe)At(s,n,r,e,a);return{threat:n,labels:r,perCardRole:s}}function vt(e,t,n){const r={threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}},s=Jt(e.labels),a={...e.perCardRole};delete a[n];const i=q(n).suit,l=new Set;r.threatsBySuit[i]&&l.add(i);for(const o of l){const f=r.threatsBySuit[o];if(!f)continue;const c=Et(t,f.threatCardId),d=c.length===1&&c[0]===f.establishedOwner;r.threatsBySuit[o]={...f,active:d,threatLength:d?xt(t,f.establishedOwner,o,f.threatRank):0,stopStatus:void 0},Xt(r,t,s,o);const h=r.threatsBySuit[o];h&&(r.threatsBySuit[o]={...h,stopStatus:st(r,s,o)}),At(a,r,s,t,o)}return{threat:r,labels:s,perCardRole:a}}const Zt=["S","H","D","C"],he={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function en(e,t){if(t&&e[t].length>0)return e[t].map(r=>k(t,r));const n=[];for(const r of Zt)for(const s of e[r])n.push(k(r,s));return n}function at(e,t,n){return n[e].idle.has(t)}function Bt(e){return q(e).rank}function Y(e){return q(e).suit}function it(e,t){return!!t.threatsBySuit[e]?.active}function Nt(e,t){const n=t.threatsBySuit[e];return!n||!n.active?null:n.threatRank}function ke(e,t,n){const r=Nt(e,t);if(!r)return null;const s=_t(t,n,e);return s&&he[s]>he[r]?s:r}function wt(e,t,n,r){return at(e,t,n)?!it(Y(t),r):!1}function Lt(e,t,n,r){if(!at(e,t,n))return!1;const s=Y(t),a=ke(s,r,n);return a?he[Bt(t)]<he[a]:!1}function tn(e,t,n,r){return at(e,t,n)?!wt(e,t,n,r)&&!Lt(e,t,n,r):!1}function nn(e,t,n){return n[e].busy.has(t)}function De(e,t,n,r){if(!nn(e,t,n))return!1;const s=Y(t);return it(s,r)}function Wt(e,t,n){const r=n.threatsBySuit[e]?.stopStatus;if(r)return r;if(!it(e,n))return;const s=[...t.E.busy].some(i=>Y(i)===e),a=[...t.W.busy].some(i=>Y(i)===e);return s&&a?"double":s||a?"single":"none"}function pt(e,t,n,r){return Wt(t,n,r)==="double"}function ht(e,t,n,r){return Wt(t,n,r)!=="single"?!1:[...n[e].busy].some(s=>Y(s)===t)}function yt(e,t){const n=Y(e),r=Bt(e),s=Nt(n,t);return s?he[r]<he[s]:!1}function ot(e,t,n,r,s){const a=t.hands[e],i=en(a,n),l=i.filter(p=>wt(e,p,s,r)),o=i.filter(p=>Lt(e,p,s,r)),f=i.filter(p=>tn(e,p,s,r)),c=i.filter(p=>{if(!De(e,p,s,r))return!1;const y=Y(p);return pt(e,y,s,r)&&yt(p,r)}),d=i.filter(p=>{if(!De(e,p,s,r))return!1;const y=Y(p);return pt(e,y,s,r)}),h=i.filter(p=>{if(!De(e,p,s,r))return!1;const y=Y(p);return ht(e,y,s,r)&&yt(p,r)}),u=i.filter(p=>{if(!De(e,p,s,r))return!1;const y=Y(p);return ht(e,y,s,r)});return{legal:i,tier1a:l,tier1b:o,tier1c:f,tier2a:c,tier2b:d,tier3a:h,tier3b:u,tier4:i}}const Dt=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],rn=["N","E","S","W"];function Z(e){return Dt.indexOf(e)}function Tt(e,t){return`${e}${t}`}function sn(e,t){const n=Z(e),r=Z(t);return n<0||r<0||r-n<=1?[]:Dt.slice(n+1,r)}function an(e,t,n,r,s){const a=sn(r,s);if(a.length===0)return!0;const i=rn.filter(l=>l!==t);return a.every(l=>i.every(o=>!e.hands[o][n].includes(l)))}function on(e,t){return Math.abs(Z(e)-Z(t))===1}function Ge(e,t,n){const r=[...e.hands[t][n]].sort((a,i)=>Z(a)-Z(i));if(r.length===0)return[];const s=[[r[0]]];for(let a=1;a<r.length;a+=1){const i=r[a-1],l=r[a];on(i,l)||an(e,t,n,i,l)?s[s.length-1].push(l):s.push([l])}return s}function ln(e,t,n){const r=[...n].sort((i,l)=>Z(i)-Z(l)),s=r[0],a=r[r.length-1];return`${e}:${t}:${s}-${a}`}function cn(e,t){const n=[...t].sort((s,a)=>Z(s)-Z(a)),r=n[n.length-1];return Tt(e,r)}function K(e,t,n){const r=n[0],s=n.slice(1),i=Ge(e,t,r).find(l=>l.includes(s))??[s];return{classId:ln(t,r,i),representative:cn(r,i),members:i.map(l=>Tt(r,l))}}const Ie=["N","E","S","W"],lt=["S","H","D","C"],ce={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function te(e){return{S:[...e.S],H:[...e.H],D:[...e.D],C:[...e.C]}}function dn(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},hands:{N:te(e.hands.N),E:te(e.hands.E),S:te(e.hands.S),W:te(e.hands.W)},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:{enabled:e.replay.enabled,transcript:e.replay.transcript?{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}:null,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId}}}function un(e){const t=Ie.indexOf(e);return Ie[(t+1)%Ie.length]}function fn(e){return e==="N"||e==="S"?"NS":"EW"}function je(e){return Ie.every(t=>lt.every(n=>e[t][n].length===0))}function pn(e,t){return e.type==="minTricks"?t[e.side]>=e.n:!1}function hn(e){let n=e.seed+Math.imul(e.counter,2654435769)>>>0;return n^=n>>>16,n=Math.imul(n,2146121005)>>>0,n^=n>>>15,n=Math.imul(n,2221713035)>>>0,n^=n>>>16,e.counter+=1,n/4294967296}function Je(e,t){return Math.floor(hn(t)*e)}function yn(e,t){const n=e[0].suit,r=t?e.filter(i=>i.suit===t):[],s=r.length>0?r:e.filter(i=>i.suit===n);let a=s[0];for(const i of s)ce[i.rank]>ce[a.rank]&&(a=i);return a.seat}function Cn(e,t,n){const r=e[t].indexOf(n);return r<0?!1:(e[t].splice(r,1),!0)}function xe(e){return e.userControls.includes(e.turn)}function Ee(e){const t=N(e);if(t.length===0)return null;const n=Je(t.length,e.rng);return!Number.isFinite(n)||n<0||n>=t.length?t[0]:t[n]??t[0]}function mn(e){const t=e.turn,n=e.trick[0]?.suit??"-",r=e.contract.strain,s=N(e).map(i=>K(e,i.seat,k(i.suit,i.rank)).classId).sort().join(","),a=e.trickClassIds.join(",");return`seat=${t}|lead=${n}|trump=${r}|legal=${s}|trick=${a}`}function gn(e){const t={};for(const n of Ie){const r=e.preferredDiscards?.[n];r&&(t[n]=Array.isArray(r)?[...r]:[r])}return t}function kn(e){const t=e.turn,n=e.preferredDiscards[t];if(!n||n.length===0)return null;const r=e.trick[0]?.suit??null;if(!r)return{preferred:n,applied:!1,reason:"not-discard"};if(e.hands[t][r].length>0)return{preferred:n,applied:!1,reason:"can-follow-suit"};if(e.preferredDiscardUsed[t])return{preferred:n,applied:!1,reason:"already-used"};const s=N(e).map(i=>k(i.suit,i.rank)),a=new Set;for(const i of lt)for(const l of e.hands[t][i])a.add(k(i,l));for(const i of n)if(a.has(i))return s.includes(i)?{preferred:n,applied:!0,chosen:i,reason:"applied"}:{preferred:n,applied:!1,chosen:i,reason:"not-legal"};return{preferred:n,applied:!1,reason:"not-in-hand"}}function Q(e,t,n,r){if(!r||r.length===0)return;const s={};for(const a of r){const i=K(e,t,a).classId;!n||!n.startsWith("tier")?s[a]=i:n.startsWith("tier1")?s[a]="idle:tier1":n.startsWith("tier2")||n.startsWith("tier3")?s[a]=`busy:${a[0]}`:s[a]=`other:${a[0]}`}return s}function bn(e,t){const n=e.turn==="E"||e.turn==="W",r=n?mn(e):void 0;let s;if(n&&e.replay.enabled&&e.replay.transcript){const m=e.replay.transcript.decisions[e.replay.cursor];if(!m)e.replay.enabled=!1;else if(m.sig!==r)e.replay.enabled=!1,s={action:"disabled",index:m.index,reason:"sig-mismatch",card:m.chosenCard};else{const b=N(e),x=e.replay.divergenceIndex!==null&&e.replay.cursor===e.replay.divergenceIndex,E=b.map(A=>k(A.suit,A.rank)),v=Q(e,e.turn,m.chosenBucket,E);let $,I=m.chosenCard,T=!1;if(x&&e.replay.forcedClassId){const A=b.find(R=>v[k(R.suit,R.rank)]===e.replay.forcedClassId);A?($=A,I=k(A.suit,A.rank)):(e.replay.enabled=!1,s={action:"disabled",index:m.index,reason:"class-not-legal",card:m.chosenCard,forcedClassId:e.replay.forcedClassId},T=!0)}if(!$&&!T&&(I=x&&e.replay.forcedCard?e.replay.forcedCard:m.chosenCard,$=b.find(A=>k(A.suit,A.rank)===I)),!$&&!T){const A=b.find(R=>K(e,R.seat,k(R.suit,R.rank)).classId===m.chosenClassId);if(!A)e.replay.enabled=!1,s={action:"disabled",index:m.index,reason:"card-not-legal",card:I};else{e.replay.cursor+=1;const R=m.chosenBucket,w=[...m.bucketCards],se=Q(e,e.turn,R,w);return x&&(e.replay.enabled=!1),{play:A,decisionSig:r,chosenBucket:R,bucketCards:w,policyClassByCard:se,replay:{action:"forced",index:m.index,card:k(A.suit,A.rank)}}}}else{e.replay.cursor+=1;const A=m.chosenBucket,R=[...m.bucketCards],w=Q(e,e.turn,A,R);return x&&(e.replay.enabled=!1),{play:$,decisionSig:r,chosenBucket:A,bucketCards:R,policyClassByCard:w,replay:{action:"forced",index:m.index,card:I}}}}}const a=kn(e);if(a?.applied&&a.chosen){e.preferredDiscardUsed[e.turn]=!0;const{suit:m,rank:b}=q(a.chosen),x=[a.chosen],E="preferred",v=Q(e,e.turn,E,x);return{play:{seat:e.turn,suit:m,rank:b},preferredDiscard:a,chosenBucket:E,bucketCards:x,policyClassByCard:v,decisionSig:r,replay:s}}if(t.kind==="randomLegal"){const m=N(e),b="legal",x=m.map(v=>k(v.suit,v.rank)),E=n?Q(e,e.turn,b,x):void 0;return{play:Ee(e),preferredDiscard:a??void 0,chosenBucket:b,bucketCards:x,policyClassByCard:E,decisionSig:r,replay:s}}if(t.kind!=="threatAware")return{play:null,preferredDiscard:a??void 0,decisionSig:r,replay:s};if(e.turn!=="E"&&e.turn!=="W")return{play:Ee(e),preferredDiscard:a??void 0,decisionSig:r,replay:s};const i=e.trick[0]?.suit??null;if(!i){const m=N(e),b="lead:none",x=m.map(v=>k(v.suit,v.rank)),E=Q(e,e.turn,b,x);return{play:Ee(e),preferredDiscard:a??void 0,chosenBucket:b,bucketCards:x,policyClassByCard:E,decisionSig:r,replay:s}}if(e.hands[e.turn][i].length>0){const m=N(e);if(!e.threat||!e.threatLabels){const w="follow:baseline",se=m.map($e=>k($e.suit,$e.rank)),Fe=Q(e,e.turn,w,se);return{play:Ee(e),preferredDiscard:a??void 0,chosenBucket:w,bucketCards:se,policyClassByCard:Fe,decisionSig:r,replay:s}}const b=ke(i,e.threat,e.threatLabels);if(!b){const w="follow:baseline",se=m.map($e=>k($e.suit,$e.rank)),Fe=Q(e,e.turn,w,se);return{play:Ee(e),preferredDiscard:a??void 0,chosenBucket:w,bucketCards:se,policyClassByCard:Fe,decisionSig:r,replay:s}}const x=m.filter(w=>ce[w.rank]<ce[b]),E=m.filter(w=>ce[w.rank]>=ce[b]),v=x.length>0?x:E,$=Je(v.length,e.rng),I=v[$]??v[0]??m[0]??null,T=x.length>0?"follow:below":"follow:above",A=v.map(w=>k(w.suit,w.rank)),R=Q(e,e.turn,T,A);return{play:I,preferredDiscard:a??void 0,chosenBucket:T,bucketCards:A,policyClassByCard:R,decisionSig:r,replay:s}}if(!e.threat)return{play:null,preferredDiscard:a??void 0,decisionSig:r,replay:s};const l=e.threatLabels??{E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}},o=ot(e.turn,{hands:e.hands},i,e.threat,l),c=[{name:"tier1a",cards:o.tier1a},{name:"tier1b",cards:o.tier1b},{name:"tier1c",cards:o.tier1c},{name:"tier2a",cards:o.tier2a},{name:"tier2b",cards:o.tier2b},{name:"tier3a",cards:o.tier3a},{name:"tier3b",cards:o.tier3b},{name:"tier4",cards:o.tier4}].find(m=>m.cards.length>0)??{name:"tier4",cards:o.tier4},d=Je(c.cards.length,e.rng),h=c.cards[d]??c.cards[0],{suit:u,rank:p}=q(h),y=Q(e,e.turn,c.name,c.cards)??{};for(const m of[...o.tier2a,...o.tier2b,...o.tier3a,...o.tier3b])y[m]=`busy:${m[0]}`;const S={};return o.tier2a.length>0&&(S.tier2a=[...o.tier2a]),o.tier2b.length>0&&(S.tier2b=[...o.tier2b]),o.tier3a.length>0&&(S.tier3a=[...o.tier3a]),o.tier3b.length>0&&(S.tier3b=[...o.tier3b]),{play:{seat:e.turn,suit:u,rank:p},preferredDiscard:a??void 0,chosenBucket:c.name,bucketCards:[...c.cards],policyClassByCard:y,tierBuckets:S,decisionSig:r,replay:s}}function Ct(e,t,n,r,s,a,i,l,o,f){const c=[],d=k(t.suit,t.rank),h=K(e,t.seat,d).classId;if(!Cn(e.hands[t.seat],t.suit,t.rank))return c.push({type:"illegal",reason:`Card ${t.suit}${t.rank} not in ${t.seat} hand`}),c;if(e.trick.push({...t}),e.trickClassIds.push(`${t.seat}:${h}`),n==="autoplay"?c.push({type:n,play:{...t},preferredDiscard:r,chosenBucket:s,bucketCards:a,policyClassByCard:i,tierBuckets:l,decisionSig:o,replay:f}):c.push({type:n,play:{...t}}),e.threat&&e.threatLabels){const m=vt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},k(t.suit,t.rank));e.threat=m.threat,e.threatLabels=m.labels,e.cardRoles={...m.perCardRole}}if(e.trick.length<4)return e.turn=un(e.turn),c;const p=e.trick.map(m=>({...m})),y=yn(p,e.trumpSuit),S=fn(y);return e.tricksWon[S]+=1,e.trick=[],e.trickClassIds=[],e.leader=y,e.turn=y,c.push({type:"trickComplete",winner:y,trick:p}),je(e.hands)&&(e.phase="end",c.push({type:"handComplete",success:pn(e.goal,e.tricksWon),tricksWon:{...e.tricksWon}})),c}function Ue(e){const t=e.contract.strain==="NT"?null:e.contract.strain,n=Object.values(e.policies).some(l=>l?.kind==="threatAware");let r=null,s=null,a={};if(n){if(!e.threatCardIds||e.threatCardIds.length===0)throw new Error(`Problem ${e.id} uses threatAware policy but has no threatCardIds`);const l=ft({hands:e.hands},e.threatCardIds);r=l.threat,s=l.labels,a={...l.perCardRole}}else if(e.threatCardIds&&e.threatCardIds.length>0){const l=ft({hands:e.hands},e.threatCardIds);r=l.threat,s=l.labels,a={...l.perCardRole}}const i={id:e.id,contract:{...e.contract},trumpSuit:t,threat:r,threatLabels:s,cardRoles:a,hands:{N:te(e.hands.N),E:te(e.hands.E),S:te(e.hands.S),W:te(e.hands.W)},leader:e.leader,turn:e.leader,trick:[],trickClassIds:[],tricksWon:{NS:0,EW:0},phase:"awaitUser",rng:{seed:e.rngSeed>>>0,counter:0},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:gn(e),preferredDiscardUsed:{},replay:{enabled:!1,transcript:null,cursor:0,divergenceIndex:null,forcedCard:null,forcedClassId:null}};return je(i.hands)?i.phase="end":i.phase=xe(i)?"awaitUser":"auto",i}function N(e){if(e.phase==="end")return[];const t=e.hands[e.turn],n=e.trick[0]?.suit,r=n?t[n]??[]:[],s=n&&r.length>0?[n]:lt,a=[];for(const i of s){const l=t[i]??[];for(const o of l)a.push({seat:e.turn,suit:i,rank:o})}return a}function Sn(e,t){const n=dn(e),r=[];if(n.phase==="end")return r.push({type:"illegal",reason:"Hand already complete"}),{state:n,events:r};if(t.seat!==n.turn)return r.push({type:"illegal",reason:`Expected turn ${n.turn}, got ${t.seat}`}),n.phase=xe(n)?"awaitUser":"auto",{state:n,events:r};if(!N(n).some(i=>i.seat===t.seat&&i.suit===t.suit&&i.rank===t.rank))return r.push({type:"illegal",reason:`Illegal play ${t.seat}:${t.suit}${t.rank}`}),n.phase=xe(n)?"awaitUser":"auto",{state:n,events:r};for(r.push(...Ct(n,t,"played"));!xe(n)&&!je(n.hands);){n.phase="auto";const i=n.policies[n.turn];if(!i){r.push({type:"illegal",reason:`No policy configured for auto seat ${n.turn}`});break}const l=bn(n,i);if(!l.play){const o=N(n);r.push({type:"illegal",reason:`Autoplay failed for ${n.turn} (policy=${i?.kind??"none"}, legal=${o.length}${l.replay?.reason?`, replay=${l.replay.reason}`:""})`});break}r.push(...Ct(n,l.play,"autoplay",l.preferredDiscard,l.chosenBucket,l.bucketCards,l.policyClassByCard,l.tierBuckets,l.decisionSig,l.replay))}return je(n.hands)?(n.phase="end",{state:n,events:r}):(n.phase=xe(n)?"awaitUser":"auto",{state:n,events:r})}function $n(e,t){return t.E.busy.has(e)||t.W.busy.has(e)}function En(e,t){if(!t.threatCardIds.includes(e))return!1;const{suit:n}=e.length>=2?{suit:e[0]}:{suit:"S"},r=t.threatsBySuit[n];return!!(r?.active&&r.threatCardId===e)}function xn(e,t,n){const{suit:r}=e.length>=2?{suit:e[0]}:{suit:"S"},s=t.threatsBySuit[r];if(!s||!s.active||s.threatCardId!==e)return!1;const a=[...n.E.busy].some(l=>l.startsWith(r)),i=[...n.W.busy].some(l=>l.startsWith(r));return!a&&!i}function In(e,t,n,r){return r?xn(e,t,n)?"purple":En(e,t)?"green":$n(e,n)?"blue":"black":"black"}function An(e,t){const n=e.triedByIdx.get(t.index)??new Set;n.add(t.chosenAltClassId||t.chosenClassId),e.triedByIdx.set(t.index,n);const r=e.recordedRemainingByIdx.get(t.index)??new Set;for(const a of t.sameBucketAlternativeClassIds)r.add(a);e.recordedRemainingByIdx.set(t.index,r);const s=e.representativeByIdx.get(t.index)??new Map;for(const[a,i]of Object.entries(t.representativeCardByClass))s.set(a,i);s.set(t.chosenAltClassId||t.chosenClassId,t.chosenCard),e.representativeByIdx.set(t.index,s)}function vn(e,t,n){const r=[...e.recordedRemainingByIdx.keys()].sort((a,i)=>a-i),s=[];for(const a of r){if(t&&!t.has(a)||typeof n=="number"&&a>=n)continue;const i=e.recordedRemainingByIdx.get(a)??new Set,l=e.triedByIdx.get(a)??new Set,o=[...i].filter(f=>!l.has(f)).sort();o.length>0&&s.push({index:a,remainingKeys:o})}return s}const Bn={id:"p001",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:[],H:[],D:["A","K","Q"],C:[]},S:{S:["5"],H:[],D:["2"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8"]},Nn={id:"p002",contract:{strain:"C"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:7},hands:{N:{S:["A","Q","9","5","4"],H:["A","K","2"],D:[],C:[]},W:{S:["J","T","8"],H:["Q","T","8"],D:["A","Q"],C:[]},E:{S:["K","7","6"],H:["J","9","7"],D:["K","J"],C:[]},S:{S:[],H:["4","3"],D:["6","5","4"],C:["T","9","8"]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},threatCardIds:["S9","H2","D5"],preferredDiscards:{W:"DA",E:"H7"},rngSeed:202},wn={id:"p003",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:["Q","T"],H:[],D:["A"],C:[]},S:{S:["5"],H:[],D:["8"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8","D8"]},Ln={id:"p004",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:5},hands:{N:{S:["8"],H:["A","8"],D:["5"],C:["3","2"]},E:{S:[],H:["Q","T"],D:["Q","T","6"],C:["4"]},S:{S:[],H:["5"],D:["A","K","8"],C:["A","K"]},W:{S:["A"],H:["K","J"],D:["J","9","7"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:404,threatCardIds:["S8","H8","D8"]},be=[{id:"p001",label:"p001",problem:Bn},{id:"p002",label:"p002",problem:Nn},{id:"p003",label:"p003",problem:wn},{id:"p004",label:"p004",problem:Ln}],Rt=document.querySelector("#app");if(!Rt)throw new Error("Missing #app");const j=Rt,de=["N","E","S","W"],we=["S","H","D","C"],F=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],Pt={S:"♠",H:"♥",D:"♦",C:"♣"},Wn={N:"North",E:"East",S:"South",W:"West"},mt={strict:"Strict",sameLevel:"Same level",allBusy:"All busy"},gt=Math.max(...be.flatMap(({problem:e})=>de.flatMap(t=>we.map(n=>e.hands[t][n].length)))),Dn=12,Tn=4,Rn=9,Pn=4,On=4,jn=6,ct=17,Hn=16,qn=3,Kn=16,Gn=Math.round(ct*.6),Un=Math.round(ct*.6),Mn=Dn+Tn+gt*Rn+Math.max(0,gt-1)*Pn+On,Ot=Hn+qn+ct*4+Kn+jn,jt=Ot+6;j.style.setProperty("--hand-box-w",`${Mn}px`);j.style.setProperty("--hand-box-h",`${Ot}px`);j.style.setProperty("--trick-box-w",`${jt}px`);j.style.setProperty("--trick-box-h",`${jt}px`);j.style.setProperty("--table-gap-y",`${Gn}px`);j.style.setProperty("--table-gap-x",`${Un}px`);j.style.setProperty("--slot-offset","12%");let ue="sameLevel",_=be[0].problem,ee=be[0].id,W=_.rngSeed>>>0,g=Ue({..._,rngSeed:W}),C=[],X=[],U=!1,_e=!0,Qe=!0,He=!0,qe=!1,Ae=null,Xe=null,L=!1,ye=null,oe=null,re=!1,Ce=null,me=null;const Le=[];let z=[],P=null;const M={triedByIdx:new Map,recordedRemainingByIdx:new Map,representativeByIdx:new Map};let ae=[],ge=[],H="running",B=!1,O=null,J=null,fe=0,ne=null,Se=!1;const Ze=new Map,Re=new Map;let Be=0;const Ne=new Map;let et=!1;Me(g);function G(){Ae&&(clearTimeout(Ae),Ae=null),Xe=null}function Yn(e){const t=new Map(F.map((n,r)=>[n,r]));return[...e].sort((n,r)=>(t.get(n)??99)-(t.get(r)??99))}function pe(e){return`${e.seat}:${e.suit}${qt(e.rank)}`}function Ht(e){return{hands:e.hands}}function Fn(e){return Array.isArray(e.threatCardIds)?[...e.threatCardIds]:[]}function qt(e){return e==="T"?"10":e}function tt(e){if(!Ce||!me)return"rank--black";const t=In(e,Ce,me,He);return t==="purple"?"rank--purple":t==="green"?"rank--green":t==="blue"?"rank--blue":"rank--black"}function nt(e,t,n,r=!1){const s=document.createElement("span");if(s.className=`rank ${n}${r?" eq-underline":""}`,t!=="T"){s.textContent=qt(t),e.appendChild(s);return}const a=document.createElement("span");a.className=`rank ten ${n}${r?" eq-underline":""}`;const i=document.createElement("span");i.className="digit-one",i.textContent="1";const l=document.createElement("span");l.className="digit-zero",l.textContent="0",a.append(i,l),e.appendChild(a)}function Qn(e){return e.type==="played"?`played ${pe(e.play)}`:e.type==="autoplay"?`autoplay ${pe(e.play)}`:e.type==="illegal"?`illegal ${e.reason}`:e.type==="trickComplete"?`trickComplete winner=${e.winner} trick=${e.trick.map(pe).join(" ")}`:`handComplete success=${e.success} NS=${e.tricksWon.NS} EW=${e.tricksWon.EW}`}function zn(e){return e==="N"||e==="S"?"NS":"EW"}function Vn(e){const t=de.indexOf(e);return de[(t+1)%de.length]}function le(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,hands:{N:{S:[...e.hands.N.S],H:[...e.hands.N.H],D:[...e.hands.N.D],C:[...e.hands.N.C]},E:{S:[...e.hands.E.S],H:[...e.hands.E.H],D:[...e.hands.E.D],C:[...e.hands.E.C]},S:{S:[...e.hands.S.S],H:[...e.hands.S.H],D:[...e.hands.S.D],C:[...e.hands.S.C]},W:{S:[...e.hands.W.S],H:[...e.hands.W.H],D:[...e.hands.W.D],C:[...e.hands.W.C]}},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:e.replay.transcript?{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}}:{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:null}}}function Kt(e){return e?{threatCardIds:[...e.threatCardIds],threatsBySuit:{...e.threatsBySuit}}:null}function Gt(e){return e?{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}:null}function Ut(e){return e?e.map(t=>({...t})):null}function Jn(e){return{state:le(g),currentProblemId:ee,currentSeed:W,logs:[...C],deferredLogLines:[...X],trickFrozen:L,lastCompletedTrick:Ut(ye),frozenViewState:oe?le(oe):null,canLeadDismiss:re,threatCtx:Kt(Ce),threatLabels:Gt(me),play:{...e},runStatus:H,playAgainAvailable:B,playAgainUnavailableReason:O,playAgainLastCandidateIndex:J,replaySuppressedForRun:Se}}function _n(e){g=le(e.state),ee=e.currentProblemId,_=be.find(t=>t.id===ee)?.problem??_,W=e.currentSeed,C=[...e.logs],X=[...e.deferredLogLines],L=e.trickFrozen,ye=Ut(e.lastCompletedTrick),oe=e.frozenViewState?le(e.frozenViewState):null,re=e.canLeadDismiss,Ce=Kt(e.threatCtx),me=Gt(e.threatLabels),H=e.runStatus,B=e.playAgainAvailable,O=e.playAgainUnavailableReason,J=e.playAgainLastCandidateIndex,Se=e.replaySuppressedForRun}function dt(){Ne.clear(),et=!1}function Xn(){if(!U||et||Ne.size===0)return;const e=[...Ne.values()].sort((t,n)=>t.idx-n.idx||(t.seat<n.seat?-1:t.seat>n.seat?1:0));C=[...C,"","================= DEFENDER EQ (initial snapshot, first EQCs observed) =================",...e.map(t=>`idx=${t.idx} seat=${t.seat} bucket=${t.bucket} classes={${t.classes.join(",")}} remaining={${t.remaining.join(",")}} chosen=${t.chosen}`),"=========================================================================================",""].slice(-500),et=!0}function Zn(e,t){const n=[];for(const r of we)for(const s of Ge(e,t,r))n.push(`${r}${s.join("")}`);return n}function Me(e){Ze.clear(),Re.clear();for(const t of e.userControls)for(const n of we){const r=Ge(e,t,n);for(const s of r){if(s.length===0)continue;const a=k(n,s[0]),l=K(e,t,a).classId;Re.has(l)||Re.set(l,a);for(const o of s){const f=k(n,o);Ze.set(f,l)}}}}function Pe(e,t){return e!=="N"&&e!=="S"?K(g,e,t).classId:Ze.get(t)??K(g,e,t).classId}function er(e,t){return Re.get(e)??t}function tr(e){const t=["","================= USER EQ (initial) ================="];for(const n of e.userControls){const r=Zn(e,n);t.push(`seat=${n} classes: ${r.join("  ")||"-"}`)}return t.push("====================================================="),t.push(""),t}function Mt(e,t,n){if(t.play.seat!=="E"&&t.play.seat!=="W"||!t.decisionSig)return null;const r=k(t.play.suit,t.play.rank),s=t.bucketCards?[...t.bucketCards]:[r],a=t.policyClassByCard??{},i=t.chosenBucket??"unknown",l=t.tierBuckets??{};let o=[...s];if((i.startsWith("tier2")||i.startsWith("tier3"))&&ue!=="strict"){const u=ue==="sameLevel"?[`tier${i.startsWith("tier2")?"2":"3"}a`,`tier${i.startsWith("tier2")?"2":"3"}b`]:["tier2a","tier2b","tier3a","tier3b"],p=[];for(const y of u)for(const S of l[y]??[])p.includes(S)||p.push(S);p.length>0&&(o=p)}const f=u=>{if(i.startsWith("tier1"))return"idle:tier1";if(i.startsWith("tier2")||i.startsWith("tier3"))return`busy:${u[0]}`;if(i==="tier4")return`other:${u[0]}`;const p=e.threatLabels;if(p){if(p[t.play.seat].busy.has(u))return`busy:${u[0]}`;if(p[t.play.seat].idle.has(u))return"idle:tier1"}const y=a[u];return y||K(e,t.play.seat,u).classId},c=[],d=f(r);for(const u of o){const p=f(u);c.includes(p)||c.push(p)}const h=c.filter(u=>u!==d);return{idx:n,seat:t.play.seat,bucket:i,classes:c,remaining:h,chosen:d,eqByTier:sr(e,t)}}function ie(e){const t={S:0,H:1,D:2,C:3};return[...e].sort((n,r)=>{const s=F.indexOf(n[1]),a=F.indexOf(r[1]);return s!==a?s-a:t[n[0]]-t[r[0]]})}function kt(e){const n=["tier1a","tier1b","tier1c","tier2a","tier2b","tier3a","tier3b","tier4","follow:below","follow:above","follow:baseline","lead:none","legal","preferred"].indexOf(e);return n>=0?n:999}function nr(e){return e.startsWith("tier")?e.slice(4):e.startsWith("follow:")?e.slice(7):e==="lead:none"?"lead":e}function rr(e,t){const n=new Map,r=N(e).filter(i=>i.seat===t.play.seat).map(i=>k(i.suit,i.rank)),s=e.trick[0]?.suit??null;if(!s){for(const i of r)n.set(i,"lead:none");return n}if(e.hands[e.turn][s].length===0&&e.threat&&e.threatLabels){const i=ot(e.turn,Ht(e),s,e.threat,e.threatLabels),l=[["tier1a",i.tier1a],["tier1b",i.tier1b],["tier1c",i.tier1c],["tier2a",i.tier2a],["tier2b",i.tier2b],["tier3a",i.tier3a],["tier3b",i.tier3b],["tier4",i.tier4]];for(const[o,f]of l)for(const c of f)n.has(c)||n.set(c,o);return n}if(e.hands[e.turn][s].length>0){const i=N(e).filter(o=>o.seat===e.turn).map(o=>k(o.suit,o.rank));if(!e.threat||!e.threatLabels){for(const o of i)n.set(o,"follow:baseline");return n}const l=ke(s,e.threat,e.threatLabels);if(!l){for(const o of i)n.set(o,"follow:baseline");return n}for(const o of i){const f=o[1];n.set(o,F.indexOf(f)>F.indexOf(l)?"follow:below":"follow:above")}return n}for(const i of r)n.set(i,t.chosenBucket??"unknown");return n}function sr(e,t){const n=rr(e,t),r=new Map;for(const[d,h]of n.entries()){let u=t.policyClassByCard?.[d];u||(h.startsWith("tier1")?u="idle:tier1":h.startsWith("tier2")||h.startsWith("tier3")?u=`busy:${d[0]}`:h==="tier4"?u=`other:${d[0]}`:u=K(e,t.play.seat,d).classId);const p=r.get(u)??new Map,y=p.get(h)??[];y.push(d),p.set(h,y),r.set(u,p)}const s=["busy:S","busy:H","busy:D","busy:C"],a=[...r.entries()],i=a.find(([d])=>d.startsWith("idle")),l=s.map(d=>a.find(([h])=>h===d)).filter(d=>!!d),o=a.filter(([d])=>!d.startsWith("idle")&&!s.includes(d)).sort((d,h)=>d[0].localeCompare(h[0])),f=(d,h)=>{const u=[...h.entries()].sort((p,y)=>kt(p[0])-kt(y[0])).map(([p,y])=>`${nr(p)}:{${ie(y).join(" ")}}`).join(" ");return`${d}(${u})`},c=[];i?c.push(f(i[0],i[1])):c.push("idle:None");for(const[d,h]of[...l,...o])c.push(f(d,h));return c.join(", ")}function Yt(e,t){const n=e[1];return F.indexOf(n)>F.indexOf(t)}function ar(e){const t=e.threat,n=e.threatLabels,r=[],s=["E","W"],a=["C","D","H","S"],i=["S","H","D","C"],l=["tier2a","tier2b","tier3a","tier3b"];for(const o of s){const f=i.filter(u=>!!t?.threatsBySuit[u]),c=[];for(const u of a){if(f.includes(u))continue;const p=ie(e.hands[o][u].map(y=>k(u,y)));p.length>0&&c.push(`idle:${u}{${p.join(" ")}}`)}const d=c.length>0?c.join(" "):"idle:(None)",h=[];for(const u of f){const p=ie(e.hands[o][u].map(E=>k(u,E)));if(p.length===0){h.push(`busy:${u}(None)`);continue}const y=t&&n?ke(u,t,n):null,m=t?.threatsBySuit[u]?.stopStatus==="double"?"2":"3",b=new Map;for(const E of p){const v=y&&Yt(E,y)?`tier${m}a`:`tier${m}b`,$=b.get(v)??[];$.push(E),b.set(v,$)}const x=l.filter(E=>(b.get(E)?.length??0)>0).map(E=>`${E.slice(4)}:{${ie(b.get(E)??[]).join(" ")}}`);h.push(`busy:${u}(${x.join(" ")||"None"})`)}r.push(`seat=${o} | ${d} | ${h.join(" | ")||"busy:(None)"}`)}return["","================= DEFENDER INVENTORY EQ (initial) =================",...r,"===================================================================",""]}function ir(e,t){const n=e.threat,r=e.threatLabels,s=["C","D","H","S"],a=["S","H","D","C"],i=["tier2a","tier2b","tier3a","tier3b"],l=a.filter(d=>!!n?.threatsBySuit[d]),o=[];for(const d of s){const h=ie([...r?.[t].idle??new Set].filter(u=>u[0]===d));h.length>0&&o.push(`idle:${d}{${h.join(" ")}}`)}const f=o.length>0?o.join(" "):"idle:(None)",c=[];for(const d of l){const h=ie([...r?.[t].busy??new Set].filter(b=>b[0]===d));if(h.length===0){c.push(`busy:${d}(None)`);continue}const u=n&&r?ke(d,n,r):null,y=n?.threatsBySuit[d]?.stopStatus==="double"?"2":"3",S=new Map;for(const b of h){const x=u&&Yt(b,u)?`tier${y}a`:`tier${y}b`,E=S.get(x)??[];E.push(b),S.set(x,E)}const m=i.filter(b=>(S.get(b)?.length??0)>0).map(b=>`${b.slice(4)}:{${ie(S.get(b)??[]).join(" ")}}`);c.push(`busy:${d}(${m.join(" ")||"None"})`)}return`${f} | ${c.join(" | ")||"busy:(None)"}`}function Ke(e,t){if(t.type==="played"||t.type==="autoplay"){const n=k(t.play.suit,t.play.rank),r=K(e,t.play.seat,n).classId,s=e.hands[t.play.seat][t.play.suit],a=s.indexOf(t.play.rank);if(a>=0&&s.splice(a,1),e.trick.push({...t.play}),e.trickClassIds.push(`${t.play.seat}:${r}`),e.threat&&e.threatLabels){const i=vt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},k(t.play.suit,t.play.rank));e.threat=i.threat,e.threatLabels=i.labels,e.cardRoles={...i.perCardRole}}e.turn=Vn(e.turn);return}if(t.type==="trickComplete"){e.trick=[],e.trickClassIds=[],e.leader=t.winner,e.turn=t.winner,e.tricksWon[zn(t.winner)]+=1;return}t.type==="handComplete"&&(e.phase="end",e.tricksWon={...t.tricksWon})}function ze(e,t,n,r){const s=[],a=le(e);for(const i of n){if(i.type==="played"||i.type==="autoplay"){fe>0&&s.push(""),fe+=1,s.push(`----- PLAY ${fe} -----`);const l=k(i.play.suit,i.play.rank);let o=`play ${i.play.seat}:${l} (${i.type==="played"?"user":"auto"})`;if(i.type==="played"){const f=Pe(i.play.seat,l);o+=` | eq=${f}`}else{const f=Mt(a,i,-1);if(f)o+=` | eq=${f.chosen} (card=${l}; bucket=${f.bucket}; remaining=${f.remaining.join(",")||"-"})`;else{const c=K(a,i.play.seat,l).classId;o+=` | eq=${c}${i.chosenBucket?` (card=${l}; bucket=${i.chosenBucket})`:""}`}}s.push(o)}if(U&&i.type==="autoplay"){if(i.replay?.action==="forced"&&s.push(`[PLAYAGAIN] forcing index=${i.replay.index??"?"} card=${i.replay.card??`${i.play.suit}${i.play.rank}`}`),i.replay?.action==="disabled"&&(i.replay.reason==="class-not-legal"?s.push(`[PLAYAGAIN] force failed idx=${i.replay.index??"?"} forcedClass=${i.replay.forcedClassId??"-"} reason=class-not-legal; continuing unforced`):s.push(`[PLAYAGAIN] replay disabled due to ${i.replay.reason??"mismatch"}`)),i.preferredDiscard){const o=i.preferredDiscard;o.applied&&o.chosen?s.push(`[PREFDISC] seat=${i.play.seat} applied preferred discard=${o.chosen}`):s.push(`[PREFDISC] seat=${i.play.seat} preferred=${o.preferred.join("/")} not-applied reason=${o.reason}`)}if(a.policies[a.turn]?.kind==="threatAware"&&a.trick.length>0&&a.hands[a.turn][a.trick[0].suit].length>0){const o=a.trick[0].suit,f=N(a).map(d=>`${d.suit}${d.rank}`),c=a.threat&&a.threatLabels?ke(o,a.threat,a.threatLabels):null;if(c){const d=N(a).filter(u=>F.indexOf(u.rank)>F.indexOf(c)),h=N(a).filter(u=>F.indexOf(u.rank)<=F.indexOf(c));s.push(`[THREAT] follow seat=${a.turn} ledSuit=${o} threshold=${c} inSuit=${f.length} chosen=${i.play.suit}${i.play.rank} below=${d.length} above=${h.length}`)}else s.push(`[THREAT] follow seat=${a.turn} ledSuit=${o} threshold=- inSuit=${f.length} chosen=${i.play.suit}${i.play.rank} mode=baseline`)}if((a.turn==="E"||a.turn==="W")&&a.trick.length>0&&a.hands[a.turn][a.trick[0].suit].length===0&&a.threat&&a.threatLabels){const o=a.trick[0].suit,f=a.threat,c=a.threatLabels,d=ot(a.turn,Ht(a),o,f,c),h=[["t2a",d.tier2a.length],["t2b",d.tier2b.length],["t3a",d.tier3a.length],["t3b",d.tier3b.length]].filter(([,u])=>u>0).map(([u,p])=>`${u}:${p}`).join(" ");s.push(`[THREAT] discard seat=${a.turn} ledSuit=${o} legal=${d.legal.length} chosen=${i.play.suit}${i.play.rank} bucket=${i.chosenBucket??"-"} tiers=${h||"-"}`)}}if((i.type==="illegal"||i.type==="handComplete")&&s.push(Qn(i)),Ke(a,i),U&&i.type==="illegal"){const l=a.trick[0]?.suit??"none",o=N(a).slice(0,10).map(pe).join(" ");s.push(`illegalContext attempted=${pe(t)} turn=${a.turn} leadSuit=${l} legal=${o||"-"}`)}i.type==="trickComplete"&&(s.push(`----- TRICK COMPLETE ----- winner=${i.winner} trick=${i.trick.map(pe).join(" ")}`),s.push(""))}return s}function or(e,t){const n=le(e);for(const r of t){if(r.type==="autoplay"&&(r.play.seat==="E"||r.play.seat==="W")&&r.decisionSig){Be+=1,U&&(C=[...C,`[INV_EQ:atDecision] idx=${z.length} seat=${r.play.seat} invEq=${ir(n,r.play.seat)}`].slice(-500));const s=Mt(n,r,z.length);if(!s){Ke(n,r);continue}const a=k(r.play.suit,r.play.rank),i=K(n,r.play.seat,a).classId,l=s.chosen,o=[...s.classes],f=[...s.remaining],c=r.bucketCards?[...r.bucketCards]:[a],d=$=>{if(s.bucket.startsWith("tier1"))return"idle:tier1";if(s.bucket.startsWith("tier2")||s.bucket.startsWith("tier3"))return`busy:${$[0]}`;if(s.bucket==="tier4")return`other:${$[0]}`;const I=n.threatLabels;if(I){if(I[r.play.seat].busy.has($))return`busy:${$[0]}`;if(I[r.play.seat].idle.has($))return"idle:tier1"}return r.policyClassByCard?.[$]??K(n,r.play.seat,$).classId},h={};for(const $ of c){const I=d($);h[I]||(h[I]=$)}o.includes(l)&&(h[l]=a);const u=n.threatLabels,p=o.filter($=>{if($.startsWith("idle"))return!0;const I=c.filter(T=>d(T)===$);return I.length>0&&!!u&&I.every(T=>u[r.play.seat].idle.has(T))}),y=r.replay?.action==="forced"&&n.replay.transcript&&typeof r.replay.index=="number"?n.replay.transcript.decisions[r.replay.index]:null,S=[...s.remaining],m=null;if(y&&y.seat===r.play.seat){const $=[y.chosenAltClassId??y.chosenClassId,...y.sameBucketAlternativeClassIds].filter((I,T,A)=>I&&A.indexOf(I)===T);o.splice(0,o.length,...$);for(const[I,T]of Object.entries(y.representativeCardByClass))h[I]=T;if(o.includes(l)||o.push(l),h[l]=a,U&&(S&&S.join(",")!==y.sameBucketAlternativeClassIds.join(",")||!S&&m)){const I=S?S.join(",")||"-":"unavailable:unknown";C=[...C,`[EQC:replay] idx=${r.replay.index} recordedRemaining=${y.sameBucketAlternativeClassIds.join(",")||"-"} runtimeRemaining=${I}`].slice(-500)}}const b=c.filter($=>d($)===l);U&&(C=[...C,`[EQC] idx=${z.length} seat=${r.play.seat} scope=${ue} bucket=${s.bucket} classes=${o.join(",")||"-"} chosen=${l} covers=${b.join(",")||"-"} remaining=${f.join(",")||"-"} invEqVersion=${Be}`].slice(-500));const x=z.length,E=r.play.seat,v=`${x}:${E}`;Ne.has(v)||Ne.set(v,{idx:x,seat:E,bucket:s.bucket,classes:[...o],remaining:[...f],chosen:l,eqByTier:s.eqByTier}),Xn(),z.push({index:z.length,seat:r.play.seat,nodeKey:ge.join(" > "),sig:r.decisionSig,chosenCard:a,chosenClassId:i,chosenAltClassId:l,invEqIdleClasses:p,chosenBucket:s.bucket,bucketCards:c,sameBucketAlternativeClassIds:o.filter($=>$!==l),representativeCardByClass:h}),ge.push(l)}Ke(n,r)}}function lr(e){const t=e.goal;return t.type==="minTricks"?`${t.side} ${t.n} tricks`:"Unknown goal"}function cr(){return L&&oe?oe:g}function We(e){L=!1,ye=null,oe=null,re=!1,e&&X.length>0&&(C=[...C,...X].slice(-500),X=[])}function ve(e,t){return t.startsWith("idle")||e.invEqIdleClasses.includes(t)}function Ft(e,t,n,r){const s=new Set(e.decisions.map(o=>o.index)),a=vn(t,s,n),i=[],l=[];for(const o of e.decisions){const f=[o.chosenAltClassId??o.chosenClassId,...o.sameBucketAlternativeClassIds].filter((y,S,m)=>!!y&&m.indexOf(y)===S),c=f.filter(y=>ve(o,y)),d=f.filter(y=>!ve(o,y)),u=(a.find(y=>y.index===o.index)?.remainingKeys??[]).filter(y=>!ve(o,y)),p=d.length>=2&&u.length>0;i.push(`[PLAYAGAIN] candCheck idx=${o.index} seat=${o.seat} nodeKey=${o.nodeKey||"-"} avail={${f.join(",")||"-"}} invEqIdle={${c.join(",")||"-"}} -> branchableAvail={${d.join(",")||"-"}} branchable=${p} reason=${p?r:"idleFiltered"}`),p&&l.push({index:o.index,seat:o.seat,nodeKey:o.nodeKey||"-",avail:f,invEqIdle:c,branchableAvail:d,remainingKeys:u})}return{candidates:l,logsOut:i}}function bt(e,t){const n=de.map(s=>`${s}:${we.map(a=>e.hands[s][a].join("")).join("/")}`).join("|"),r=e.trick.map(s=>`${s.seat}${s.suit}${s.rank}`).join(",");return`${e.phase}|${e.turn}|${e.leader}|${r}|${n}|${t.seat}${t.suit}${t.rank}`}function St(){const n=g.userControls.includes(g.turn)&&(!L&&g.phase==="awaitUser"||L&&re&&g.phase!=="end");if(!qe||!n){G();return}const r=N(g).filter(i=>i.seat===g.turn);if(r.length!==1){G();return}const s=r[0],a=bt(g,s);Ae&&Xe===a||(G(),Xe=a,Ae=setTimeout(()=>{const o=g.userControls.includes(g.turn)&&(!L&&g.phase==="awaitUser"||L&&re&&g.phase!=="end");if(!qe||!o){G();return}const f=N(g).filter(d=>d.seat===g.turn);if(f.length!==1){G();return}const c=f[0];if(bt(g,c)!==a){G();return}G(),Qt(c)},500))}function Ye(e,t){t&&(C=[]);const n=Fn(_);Ce=g.threat??null,me=g.threatLabels??null,n.length!==0&&U&&(C=[...C,`[THREAT:init] problem=${e} raw=${n.join(",")} validation=OK`].slice(-500),C=[...C,...tr(g)].slice(-500),C=[...C,...ar(g)].slice(-500))}function Ve(e,t){G();const n=e>>>0;n!==W>>>0&&(M.triedByIdx.clear(),M.recordedRemainingByIdx.clear(),M.representativeByIdx.clear()),W=n,g=Ue({..._,rngSeed:W}),C=[...C,`${t} seed=${W}`].slice(-500),H="running",fe=0,Be=0,ne=null,Se=!1,B=!1,O=null,J=null,z=[],ae=[],ge=[],Me(g),dt(),Le.length=0,X=[],We(!1),Ye(ee,!1),D()}function dr(e){G();const t=be.find(n=>n.id===e);t&&(_=t.problem,ee=t.id,W=_.rngSeed>>>0,g=Ue({..._,rngSeed:W}),H="running",fe=0,Be=0,ne=null,Se=!1,B=!1,O=null,J=null,z=[],ae=[],ge=[],Me(g),dt(),P=null,M.triedByIdx.clear(),M.recordedRemainingByIdx.clear(),M.representativeByIdx.clear(),Le.length=0,X=[],We(!1),Ye(ee,!0),D())}function ur(){G();const e=Le.pop();e&&(_n(e),C=[...C,`[UNDO] restored snapshot before user play: ${e.play.seat}:${k(e.play.suit,e.play.rank)}`].slice(-500),D())}function Qt(e){if(G(),g.replay.enabled&&g.replay.transcript&&(e.seat==="N"||e.seat==="S")){const a=k(e.suit,e.rank),i=Pe(e.seat,a),l=g.replay.transcript.userPlays[ae.length];if(l&&l.playClassId!==i){const o=g.replay.cursor;g.replay.enabled=!1,Se=!0,C=[...C,`[PLAYAGAIN] user diverged at decisionIdx=${o} expectedClass=${l.playClassId} actualClass=${i}; continuing without forcing further decisions`].slice(-500)}else if(U){const o=Pe(e.seat,a),f=er(o,a);C=[...C,`[EQ] seat=${e.seat} played=${a} class=${o} rep=${f}`].slice(-500)}}if(e.seat==="N"||e.seat==="S"){const a=k(e.suit,e.rank),i=Pe(e.seat,a);ae.push({index:ae.length,seat:e.seat,playClassId:i}),ge.push(i)}Le.push(Jn(e)),L&&We(!0);const t=g,n=Sn(g,e);g=n.state,Ce=g.threat??null,me=g.threatLabels??null;const r=n.events.findIndex(a=>a.type==="trickComplete");if(or(t,n.events),r>=0){const a=n.events.slice(0,r+1),i=n.events.slice(r+1),l=le(t);for(const c of a)Ke(l,c);L=!0,oe=l;const o=a[a.length-1];o.type==="trickComplete"&&(ye=o.trick.map(c=>({...c}))),re=g.phase!=="end"&&g.trick.length===0&&g.userControls.includes(g.turn);const f=ze(t,e,a);if(C=[...C,...f].slice(-500),i.length>0){const c=ze(l,e,i);X=[...X,...c].slice(-500)}}else{const a=ze(t,e,n.events);C=[...C,...a].slice(-500)}const s=n.events.find(a=>a.type==="handComplete");if(s?.type==="handComplete"&&s.success){P={problemId:ee,seed:W,decisions:z.map(o=>({...o,bucketCards:[...o.bucketCards],sameBucketAlternativeClassIds:[...o.sameBucketAlternativeClassIds],representativeCardByClass:{...o.representativeCardByClass}})),userPlays:ae.map(o=>({...o}))},C=[...C,`[PLAYAGAIN] recorded transcript ${P.decisions.length} decisions`].slice(-500);for(const o of P.decisions)An(M,o);const{candidates:a,logsOut:i}=Ft(P,M,ne,"endOfRunSuccess");B=a.length>0,O=B?null:ne!==null?"user-mismatch-exhausted":"exhausted-all-variations",J=B?a[a.length-1].index:null;const l=B?(()=>{const o=a[a.length-1],f=o.remainingKeys[0]??"-",c=M.representativeByIdx.get(o.index)?.get(f)??"-";return`[PLAYAGAIN] offer available=true candidates=[${a.map(d=>d.index).join(",")}] chosenCandidate=${o.index} forcedClass=${f} forcedCard=${c} reason=endOfRunSuccess`})():null;C=[...C,...i,`[PLAYAGAIN] candidates=[${a.map(o=>o.index).join(",")}] cutoffIdx=${ne??"-"}`,...a.map(o=>`[PLAYAGAIN] idx=${o.index} remainingUntried=${o.remainingKeys.length} keys=${o.remainingKeys.join(",")}`),...l?[l]:[],B?`[PLAYAGAIN] availability ok=true lastCandidateIndex=${J}`:`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500)}if(s?.type==="handComplete"){const a=s.success?"success":"failure";U&&(C=[...C,`[GOAL] endOfRun=true NSwon=${s.tricksWon.NS} EWwon=${s.tricksWon.EW} required${g.goal.side}>=${g.goal.n} success=${s.success}`,`[RUNSTATUS] ${H} -> ${a}`].slice(-500)),H=a}D()}function fr(e="autoplay"){if(G(),!P){B=!1,O="exhausted-all-variations",J=null,C=[...C,`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500),D();return}const{candidates:t,logsOut:n}=Ft(P,M,ne,e==="manual"?"manualRequest":"offerCheck");if(B=t.length>0,O=B?null:ne!==null?"user-mismatch-exhausted":"exhausted-all-variations",J=B?t[t.length-1].index:null,C=[...C,...n,`[PLAYAGAIN] candidates=[${t.map(c=>c.index).join(",")}] cutoffIdx=${ne??"-"}`,...t.map(c=>`[PLAYAGAIN] idx=${c.index} remainingUntried=${c.remainingKeys.length} keys=${c.remainingKeys.join(",")}`)].slice(-500),B){const c=t[t.length-1],d=c.remainingKeys[0]??"-",h=M.representativeByIdx.get(c.index)?.get(d)??"-";C=[...C,`[PLAYAGAIN] offer shown candidates=[${t.map(u=>u.index).join(",")}] reason=${e==="manual"?"manualRequest":"other"}`,`[PLAYAGAIN] offer available=true candidates=[${t.map(u=>u.index).join(",")}] chosenCandidate=${c.index} forcedClass=${d} forcedCard=${h} reason=${e==="manual"?"manualRequest":"other"}`].slice(-500)}if(!B){C=[...C,`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500),D();return}const r=P?.seed??W;g=Ue({..._,rngSeed:r});let s=null,a=null,i=null;const l=[];for(const c of t)c.remainingKeys.length>0&&l.push(`[EQC:playagain] idx=${c.index} remaining=${c.remainingKeys.join(",")||"-"}`);const o=t[t.length-1];if(s=o.index,a=o.remainingKeys[0]??null,a&&(i=M.representativeByIdx.get(s)?.get(a)??null,C=[...C,`[PLAYAGAIN] candidates=[${t.map(d=>d.index).join(",")}] chosen=${s}`].slice(-500),C=[...C,`[PLAYAGAIN] divergenceIndex=${s} forcedClass=${a} forcedCard=${i??"-"}`].slice(-500)),U&&(C=[...C,"----- PLAY AGAIN COVERAGE -----",...l.length>0?l:["[EQC:playagain] none"]].slice(-500)),!a||s===null){B=!1,O="exhausted-all-variations",J=null,C=[...C,`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500),D();return}C=[...C,`[PLAYAGAIN] offer selected chosenCandidate=${s} divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"} source=${e==="manual"?"uiClick":"other"}`,`[PLAYAGAIN] ${e==="manual"?"manual":"autoplay"} selected=true source=${e==="manual"?"uiClick":"other"} -> starting replay divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"}`].slice(-500),g.replay={enabled:!0,transcript:{problemId:P.problemId,seed:P.seed,decisions:P.decisions.map(c=>({...c,bucketCards:[...c.bucketCards],sameBucketAlternativeClassIds:[...c.sameBucketAlternativeClassIds],representativeCardByClass:{...c.representativeCardByClass}})),userPlays:P.userPlays.map(c=>({...c}))},cursor:0,divergenceIndex:s,forcedCard:i,forcedClassId:a},W=r,H="running",fe=0,Be=0,Se=!1,B=!1,O=null,J=null,z=[],ae=[],ge=[],Me(g),dt(),X=[],We(!1);const f=["[PLAYAGAIN] replayStart candidates summary:"];for(const c of P.decisions){const d=[c.chosenAltClassId??c.chosenClassId,...c.sameBucketAlternativeClassIds].filter((p,y,S)=>!!p&&S.indexOf(p)===y),h=d.filter(p=>!ve(c,p));if(h.length<2)continue;const u=c.index===s?` FORCING=${a}`:"";f.push(`[PLAYAGAIN] idx=${c.index} seat=${c.seat} nodeKey=${c.nodeKey||"-"} avail={${d.join(",")}} branchableAvail={${h.join(",")}} chosen=${c.chosenAltClassId} remaining={${c.sameBucketAlternativeClassIds.filter(p=>!ve(c,p)).join(",")||"-"}}${u}`)}C=[...C,`[PLAYAGAIN] replayStart plan divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"} source=${e}`,...f,`===== PLAY AGAIN REPLAY ===== divergenceIdx=${s} forced=${i??"-"} forcedClass=${a}`,"[PLAYAGAIN] replay enabled",""].slice(-500),Ye(ee,!1),D()}function pr(e,t,n,r,s){const a=document.createElement("div");a.className="suit-row";const i=document.createElement("span");i.className=`suit-symbol suit-${n}`,i.textContent=Pt[n],a.appendChild(i);const l=document.createElement("div");l.className="cards";const o=Yn(e.hands[t][n]),f=new Set;if(He){for(const c of Ge(e,t,n))if(c.length>1)for(const d of c)f.add(d)}if(o.length>0)for(const c of o){const d=`${n}${c}`,h=s&&r.has(d),u=f.has(c);if(h){const p=document.createElement("button");p.type="button",p.className="rank-text legal",nt(p,c,tt(k(n,c)),u),p.onclick=()=>Qt({seat:t,suit:n,rank:c}),l.appendChild(p)}else{const p=document.createElement("span");p.className="rank-text muted",nt(p,c,tt(k(n,c)),u),l.appendChild(p)}}return a.appendChild(l),a}function Te(e,t){const n=document.createElement("section"),r=e.turn===t;n.className=`hand seat-${t}`;const s=document.createElement("div");s.className="hand-head",s.innerHTML=`<strong class="seat-name${r?" active-seat-name":""}">${Wn[t]}</strong>`,n.appendChild(s);const a=!L&&r?N(e):[],i=new Set(a.map(f=>`${f.suit}${f.rank}`)),l=!L&&e.phase!=="end"&&e.userControls.includes(t)&&r;if(L&&re&&g.userControls.includes(g.turn)&&t===g.turn){const f=N(g);for(const c of f)i.add(`${c.suit}${c.rank}`)}const o=l||L&&re&&t===g.turn;for(const f of we)n.appendChild(pr(e,t,f,i,o));return n}function hr(e){const t=document.createElement("section");t.className=`trick-table${L?" frozen":""}`,L&&(t.title="Click to dismiss trick",t.onclick=()=>{We(!0),D()});const n=L&&ye?ye:e.trick,r=new Map(n.map(s=>[s.seat,s]));for(const s of de){const a=document.createElement("div");a.className=`trick-slot slot-${s}`;const i=r.get(s);if(i){const l=document.createElement("span");l.className="played-text";const o=document.createElement("span");o.className=`played-suit suit-${i.suit}`,o.textContent=Pt[i.suit];const f=document.createElement("span");f.className="played-rank",nt(f,i.rank,tt(k(i.suit,i.rank))),l.append(o,f),a.appendChild(l)}t.appendChild(a)}return t}function yr(e){const t=document.createElement("section");t.className="status-panel";const n=document.createElement("div");n.className="status-head";const r=document.createElement("strong");r.textContent="Status",n.appendChild(r);const s=document.createElement("div");s.className="controls";const a=document.createElement("button");a.type="button",a.textContent="Reset",a.onclick=()=>Ve(W,"reset"),s.appendChild(a);const i=document.createElement("button");i.type="button",i.textContent="Backup",i.disabled=Le.length===0,i.onclick=()=>ur(),s.appendChild(i);const l=document.createElement("button");l.type="button",l.textContent="New seed",l.onclick=()=>Ve(Date.now()>>>0,"newSeed"),s.appendChild(l);const o=document.createElement("label"),f=document.createElement("input");f.type="checkbox",f.checked=_e,f.onchange=()=>{_e=f.checked,D()},o.append(f," Show log"),s.appendChild(o);const c=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=U,d.onchange=()=>{U=d.checked,D()},c.append(d," Verbose log"),s.appendChild(c),n.appendChild(s),t.appendChild(n);const h=document.createElement("div");h.className="status-facts",h.innerHTML=`
    <div><span class="k">Contract</span><span class="v">${e.contract.strain}</span></div>
    <div><span class="k">Goal</span><span class="v">${lr(e)}</span></div>
    <div class="tricks"><span class="k">Tricks</span><span class="v heavy">NS ${e.tricksWon.NS} - EW ${e.tricksWon.EW}</span></div>
    <div class="meta-row"><span class="k">Leader</span><span class="v turn-meta">${e.leader}</span></div>
    <div class="meta-row"><span class="k">Turn</span><span class="v turn-meta turn-emph">${e.turn}</span></div>
    <div class="meta-row"><span class="k">Seed</span><span class="v seed">${W}</span></div>
  `;const u=document.createElement("div");u.className="meta-row";const p=document.createElement("span");p.className="k",p.textContent="Variations";const y=document.createElement("span");y.className="v turn-meta";const S=document.createElement("select");return["strict","sameLevel","allBusy"].forEach(m=>{const b=document.createElement("option");b.value=m,b.textContent=mt[m],m===ue&&(b.selected=!0),S.appendChild(b)}),S.onchange=()=>{const m=S.value;m!==ue&&(ue=m,Ve(W,`Variation mode changed: ${mt[m]}`))},y.appendChild(S),u.append(p,y),h.appendChild(u),t.appendChild(h),t}function D(){const e=cr();j.innerHTML="";const t=document.createElement("section");t.className="board-shell";const n=document.createElement("div");n.className="table-host";const r=document.createElement("div");r.className="table-tools";const s=document.createElement("label");s.textContent="Puzzle: ";const a=document.createElement("select");for(const u of be){const p=document.createElement("option");p.value=u.id,p.textContent=u.label,p.selected=u.id===ee,a.appendChild(p)}a.onchange=()=>{dr(a.value)},s.appendChild(a),r.appendChild(s);const i=document.createElement("label"),l=document.createElement("input");l.type="checkbox",l.checked=Qe,l.onchange=()=>{Qe=l.checked,D()},i.append(l," Show guides"),r.appendChild(i);const o=document.createElement("label"),f=document.createElement("input");f.type="checkbox",f.checked=He,f.onchange=()=>{He=f.checked,D()},o.append(f," Teaching mode"),r.appendChild(o);const c=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=qe,d.onchange=()=>{qe=d.checked,St(),D()},c.append(d," Autoplay singletons"),r.appendChild(c),n.appendChild(r);const h=document.createElement("main");if(h.className=`table-canvas${Qe?" show-guides":""}`,h.appendChild(hr(e)),h.appendChild(Te(e,"N")),h.appendChild(Te(e,"W")),h.appendChild(Te(e,"E")),h.appendChild(Te(e,"S")),n.appendChild(h),t.appendChild(n),t.appendChild(yr(e)),j.appendChild(t),H==="success"||H==="failure"){const u=document.createElement("div");u.className=`banner ${H==="success"?"ok":"fail"}`,u.textContent=H==="success"?"Success - goal achieved":"Not enough tricks - try again",j.appendChild(u)}if(H==="success"&&B){const u=document.createElement("button");u.type="button",u.textContent="Play Again",u.onclick=()=>fr("manual"),j.appendChild(u)}if(H==="success"&&!B){const u=document.createElement("div");u.className="banner",u.textContent="No 'Play Again' variations available: defenders had no same-tier alternatives to explore.",j.appendChild(u)}if(_e){const u=document.createElement("section");u.className="log-panel";const p=document.createElement("strong");p.textContent="Log",u.appendChild(p);const y=document.createElement("div");y.className="log",y.textContent=C.length>0?C.join(`
`):"No events yet",u.appendChild(y),j.appendChild(u),y.scrollTop=y.scrollHeight}St()}Ye(ee,!1);D();
