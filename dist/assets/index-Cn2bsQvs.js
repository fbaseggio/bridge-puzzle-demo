(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const Fe=["S","H","D","C"],mt=["E","W"],Ot={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function H(e){const t=e.slice(0,1),n=e.slice(1);if(!Fe.includes(t)||!(n in Ot))throw new Error(`Invalid CardId: ${e}`);return{suit:t,rank:n}}function k(e,t){return`${e}${t}`}function _(e){return Ot[e]}function jt(e,t){const{suit:n,rank:r}=H(t),s=[],a=["N","E","S","W"];for(const i of a)e.hands[i][n].includes(r)&&s.push(i);return s}function Kt(e,t,n,r){return e.hands[t][n].filter(s=>_(s)>=_(r)).length}function pn(e,t){const n={};for(const r of t){const{suit:s,rank:a}=H(r);if(n[s])throw new Error(`Duplicate threat suit: ${s}`);const i=jt(e,r);if(i.length!==1)throw new Error(`Threat card ${r} must exist in exactly one hand (found ${i.length})`);const l=i[0];n[s]={suit:s,threatCardId:r,threatRank:a,establishedOwner:l,active:!0,threatLength:Kt(e,l,s,a)}}return{threatsBySuit:n,threatCardIds:[...t]}}function hn(e,t){const n={E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}};for(const r of mt)for(const s of Fe){for(const c of t.hands[r][s])n[r].idle.add(k(s,c));const a=e.threatsBySuit[s];if(!a||!a.active||a.threatLength<=0)continue;const i=t.hands[r][s],l=i.some(c=>_(c)>_(a.threatRank)),o=i.length>=a.threatLength;if(!l||!o)continue;const d=[...i].sort((c,u)=>_(u)-_(c)).slice(0,a.threatLength);for(const c of d){const u=k(s,c);n[r].idle.delete(u),n[r].busy.add(u)}}return n}function yn(e){return{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}}function It(e,t,n){return[...e[t].busy].some(r=>H(r).suit===n)}function Ct(e,t,n){const r=e.threatsBySuit[n];if(!r||!r.active)return;const s=It(t,"E",n),a=It(t,"W",n);return s&&a?"double":s||a?"single":"none"}function Ht(e,t,n){const r=e.threatsBySuit[n];return!r||!r.active?!1:(r.stopStatus??Ct(e,t,n))==="none"}function mn(e,t,n){return Ht(e,t,n)?e.threatsBySuit[n]?.threatRank??null:null}function Cn(e,t,n,r){for(const s of mt){for(const c of[...n[s].busy])H(c).suit===r&&n[s].busy.delete(c);for(const c of[...n[s].idle])H(c).suit===r&&n[s].idle.delete(c);for(const c of t.hands[s][r])n[s].idle.add(k(r,c));const a=e.threatsBySuit[r];if(!a||!a.active||a.threatLength<=0)continue;const i=t.hands[s][r],l=i.some(c=>_(c)>_(a.threatRank)),o=i.length>=a.threatLength;if(!l||!o)continue;const d=[...i].sort((c,u)=>_(u)-_(c)).slice(0,a.threatLength);for(const c of d){const u=k(r,c);n[s].idle.delete(u),n[s].busy.add(u)}}}function qt(e,t,n,r,s){for(const l of Object.keys(e))H(l).suit===s&&delete e[l];const a=["N","E","S","W"];for(const l of a)for(const o of r.hands[l][s]){const d=k(s,o);e[d]="default"}for(const l of mt){for(const o of n[l].idle)H(o).suit===s&&(e[o]="idle");for(const o of n[l].busy)H(o).suit===s&&(e[o]="busy")}const i=t.threatsBySuit[s];i?.active&&(e[i.threatCardId]="threat",Ht(t,n,s)&&(e[i.threatCardId]="promotedWinner"))}function vt(e,t){const n=pn(e,t),r=hn(n,e);for(const a of Fe){const i=n.threatsBySuit[a];i&&(n.threatsBySuit[a]={...i,stopStatus:Ct(n,r,a)})}const s={};for(const a of Fe)qt(s,n,r,e,a);return{threat:n,labels:r,perCardRole:s}}function Mt(e,t,n){const r={threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}},s=yn(e.labels),a={...e.perCardRole};delete a[n];const i=H(n).suit,l=new Set;r.threatsBySuit[i]&&l.add(i);for(const o of l){const d=r.threatsBySuit[o];if(!d)continue;const c=jt(t,d.threatCardId),u=c.length===1&&c[0]===d.establishedOwner;r.threatsBySuit[o]={...d,active:u,threatLength:u?Kt(t,d.establishedOwner,o,d.threatRank):0,stopStatus:void 0},Cn(r,t,s,o);const h=r.threatsBySuit[o];h&&(r.threatsBySuit[o]={...h,stopStatus:Ct(r,s,o)}),qt(a,r,s,t,o)}return{threat:r,labels:s,perCardRole:a}}const gn=["S","H","D","C"],ke={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function kn(e,t){if(t&&e[t].length>0)return e[t].map(r=>k(t,r));const n=[];for(const r of gn)for(const s of e[r])n.push(k(r,s));return n}function gt(e,t,n){return n[e].idle.has(t)}function Ut(e){return H(e).rank}function Y(e){return H(e).suit}function kt(e,t){return!!t.threatsBySuit[e]?.active}function Gt(e,t){const n=t.threatsBySuit[e];return!n||!n.active?null:n.threatRank}function Ie(e,t,n){const r=Gt(e,t);if(!r)return null;const s=mn(t,n,e);return s&&ke[s]>ke[r]?s:r}function Yt(e,t,n,r){return gt(e,t,n)?!kt(Y(t),r):!1}function Ft(e,t,n,r){if(!gt(e,t,n))return!1;const s=Y(t),a=Ie(s,r,n);return a?ke[Ut(t)]<ke[a]:!1}function bn(e,t,n,r){return gt(e,t,n)?!Yt(e,t,n,r)&&!Ft(e,t,n,r):!1}function $n(e,t,n){return n[e].busy.has(t)}function qe(e,t,n,r){if(!$n(e,t,n))return!1;const s=Y(t);return kt(s,r)}function Qt(e,t,n){const r=n.threatsBySuit[e]?.stopStatus;if(r)return r;if(!kt(e,n))return;const s=[...t.E.busy].some(i=>Y(i)===e),a=[...t.W.busy].some(i=>Y(i)===e);return s&&a?"double":s||a?"single":"none"}function At(e,t,n,r){return Qt(t,n,r)==="double"}function Bt(e,t,n,r){return Qt(t,n,r)!=="single"?!1:[...n[e].busy].some(s=>Y(s)===t)}function wt(e,t){const n=Y(e),r=Ut(e),s=Gt(n,t);return s?ke[r]<ke[s]:!1}function bt(e,t,n,r,s){const a=t.hands[e],i=kn(a,n),l=i.filter(f=>Yt(e,f,s,r)),o=i.filter(f=>Ft(e,f,s,r)),d=i.filter(f=>bn(e,f,s,r)),c=i.filter(f=>{if(!qe(e,f,s,r))return!1;const C=Y(f);return At(e,C,s,r)&&wt(f,r)}),u=i.filter(f=>{if(!qe(e,f,s,r))return!1;const C=Y(f);return At(e,C,s,r)}),h=i.filter(f=>{if(!qe(e,f,s,r))return!1;const C=Y(f);return Bt(e,C,s,r)&&wt(f,r)}),p=i.filter(f=>{if(!qe(e,f,s,r))return!1;const C=Y(f);return Bt(e,C,s,r)});return{legal:i,tier1a:l,tier1b:o,tier1c:d,tier2a:c,tier2b:u,tier3a:h,tier3b:p,tier4:i}}const Vt=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],Sn=["N","E","S","W"];function te(e){return Vt.indexOf(e)}function zt(e,t){return`${e}${t}`}function En(e,t){const n=te(e),r=te(t);return n<0||r<0||r-n<=1?[]:Vt.slice(n+1,r)}function xn(e,t,n,r,s){const a=En(r,s);if(a.length===0)return!0;const i=Sn.filter(l=>l!==t);return a.every(l=>i.every(o=>!e.hands[o][n].includes(l)))}function In(e,t){return Math.abs(te(e)-te(t))===1}function ze(e,t,n){const r=[...e.hands[t][n]].sort((a,i)=>te(a)-te(i));if(r.length===0)return[];const s=[[r[0]]];for(let a=1;a<r.length;a+=1){const i=r[a-1],l=r[a];In(i,l)||xn(e,t,n,i,l)?s[s.length-1].push(l):s.push([l])}return s}function vn(e,t,n){const r=[...n].sort((i,l)=>te(i)-te(l)),s=r[0],a=r[r.length-1];return`${e}:${t}:${s}-${a}`}function An(e,t){const n=[...t].sort((s,a)=>te(s)-te(a)),r=n[n.length-1];return zt(e,r)}function q(e,t,n){const r=n[0],s=n.slice(1),i=ze(e,t,r).find(l=>l.includes(s))??[s];return{classId:vn(t,r,i),representative:An(r,i),members:i.map(l=>zt(r,l))}}const We=["N","E","S","W"],$t=["S","H","D","C"],ye={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function ae(e){return{S:[...e.S],H:[...e.H],D:[...e.D],C:[...e.C]}}function Bn(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},hands:{N:ae(e.hands.N),E:ae(e.hands.E),S:ae(e.hands.S),W:ae(e.hands.W)},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:{enabled:e.replay.enabled,transcript:e.replay.transcript?{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}:null,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId}}}function wn(e){const t=We.indexOf(e);return We[(t+1)%We.length]}function Nn(e){return e==="N"||e==="S"?"NS":"EW"}function Qe(e){return We.every(t=>$t.every(n=>e[t][n].length===0))}function Ln(e,t){return e.type==="minTricks"?t[e.side]>=e.n:!1}function Wn(e){let n=e.seed+Math.imul(e.counter,2654435769)>>>0;return n^=n>>>16,n=Math.imul(n,2146121005)>>>0,n^=n>>>15,n=Math.imul(n,2221713035)>>>0,n^=n>>>16,e.counter+=1,n/4294967296}function at(e,t){return Math.floor(Wn(t)*e)}function Dn(e,t){const n=e[0].suit,r=t?e.filter(i=>i.suit===t):[],s=r.length>0?r:e.filter(i=>i.suit===n);let a=s[0];for(const i of s)ye[i.rank]>ye[a.rank]&&(a=i);return a.seat}function Tn(e,t,n){const r=e[t].indexOf(n);return r<0?!1:(e[t].splice(r,1),!0)}function Le(e){return e.userControls.includes(e.turn)}function Ne(e){const t=N(e);if(t.length===0)return null;const n=at(t.length,e.rng);return!Number.isFinite(n)||n<0||n>=t.length?t[0]:t[n]??t[0]}function Rn(e){const t=e.turn,n=e.trick[0]?.suit??"-",r=e.contract.strain,s=N(e).map(i=>q(e,i.seat,k(i.suit,i.rank)).classId).sort().join(","),a=e.trickClassIds.join(",");return`seat=${t}|lead=${n}|trump=${r}|legal=${s}|trick=${a}`}function Pn(e){const t={};for(const n of We){const r=e.preferredDiscards?.[n];r&&(t[n]=Array.isArray(r)?[...r]:[r])}return t}function On(e){const t=e.turn,n=e.preferredDiscards[t];if(!n||n.length===0)return null;const r=e.trick[0]?.suit??null;if(!r)return{preferred:n,applied:!1,reason:"not-discard"};if(e.hands[t][r].length>0)return{preferred:n,applied:!1,reason:"can-follow-suit"};if(e.preferredDiscardUsed[t])return{preferred:n,applied:!1,reason:"already-used"};const s=N(e).map(i=>k(i.suit,i.rank)),a=new Set;for(const i of $t)for(const l of e.hands[t][i])a.add(k(i,l));for(const i of n)if(a.has(i))return s.includes(i)?{preferred:n,applied:!0,chosen:i,reason:"applied"}:{preferred:n,applied:!1,chosen:i,reason:"not-legal"};return{preferred:n,applied:!1,reason:"not-in-hand"}}function V(e,t,n,r){if(!r||r.length===0)return;const s={};for(const a of r){const i=q(e,t,a).classId;!n||!n.startsWith("tier")?s[a]=i:n.startsWith("tier1")?s[a]="idle:tier1":n.startsWith("tier2")||n.startsWith("tier3")?s[a]=`busy:${a[0]}`:s[a]=`other:${a[0]}`}return s}function jn(e,t){const n=e.turn==="E"||e.turn==="W",r=n?Rn(e):void 0;let s;if(n&&e.replay.enabled&&e.replay.transcript){const y=e.replay.transcript.decisions[e.replay.cursor];if(!y)e.replay.enabled=!1;else if(y.sig!==r)e.replay.enabled=!1,s={action:"disabled",index:y.index,reason:"sig-mismatch",card:y.chosenCard};else{const $=N(e),I=e.replay.divergenceIndex!==null&&e.replay.cursor===e.replay.divergenceIndex,x=$.map(S=>k(S.suit,S.rank)),A=V(e,e.turn,y.chosenBucket,x);let P,E=y.chosenCard,v=!1;if(I&&e.replay.forcedClassId){const S=$.find(L=>A[k(L.suit,L.rank)]===e.replay.forcedClassId);S?(P=S,E=k(S.suit,S.rank)):(e.replay.enabled=!1,s={action:"disabled",index:y.index,reason:"class-not-legal",card:y.chosenCard,forcedClassId:e.replay.forcedClassId},v=!0)}if(!P&&!v&&(E=I&&e.replay.forcedCard?e.replay.forcedCard:y.chosenCard,P=$.find(S=>k(S.suit,S.rank)===E)),!P&&!v){const S=$.find(L=>q(e,L.seat,k(L.suit,L.rank)).classId===y.chosenClassId);if(!S)e.replay.enabled=!1,s={action:"disabled",index:y.index,reason:"card-not-legal",card:E};else{e.replay.cursor+=1;const L=y.chosenBucket,B=[...y.bucketCards],re=V(e,e.turn,L,B);return I&&(e.replay.enabled=!1),{play:S,decisionSig:r,chosenBucket:L,bucketCards:B,policyClassByCard:re,replay:{action:"forced",index:y.index,card:k(S.suit,S.rank)}}}}else{e.replay.cursor+=1;const S=y.chosenBucket,L=[...y.bucketCards],B=V(e,e.turn,S,L);return I&&(e.replay.enabled=!1),{play:P,decisionSig:r,chosenBucket:S,bucketCards:L,policyClassByCard:B,replay:{action:"forced",index:y.index,card:E}}}}}const a=On(e);if(a?.applied&&a.chosen){e.preferredDiscardUsed[e.turn]=!0;const{suit:y,rank:$}=H(a.chosen),I=[a.chosen],x="preferred",A=V(e,e.turn,x,I);return{play:{seat:e.turn,suit:y,rank:$},preferredDiscard:a,chosenBucket:x,bucketCards:I,policyClassByCard:A,decisionSig:r,replay:s}}if(t.kind==="randomLegal"){const y=N(e),$="legal",I=y.map(A=>k(A.suit,A.rank)),x=n?V(e,e.turn,$,I):void 0;return{play:Ne(e),preferredDiscard:a??void 0,chosenBucket:$,bucketCards:I,policyClassByCard:x,decisionSig:r,replay:s}}if(t.kind!=="threatAware")return{play:null,preferredDiscard:a??void 0,decisionSig:r,replay:s};if(e.turn!=="E"&&e.turn!=="W")return{play:Ne(e),preferredDiscard:a??void 0,decisionSig:r,replay:s};const i=e.trick[0]?.suit??null;if(!i){const y=N(e),$="lead:none",I=y.map(A=>k(A.suit,A.rank)),x=V(e,e.turn,$,I);return{play:Ne(e),preferredDiscard:a??void 0,chosenBucket:$,bucketCards:I,policyClassByCard:x,decisionSig:r,replay:s}}if(e.hands[e.turn][i].length>0){const y=N(e);if(!e.threat||!e.threatLabels){const B="follow:baseline",re=y.map(we=>k(we.suit,we.rank)),he=V(e,e.turn,B,re);return{play:Ne(e),preferredDiscard:a??void 0,chosenBucket:B,bucketCards:re,policyClassByCard:he,decisionSig:r,replay:s}}const $=Ie(i,e.threat,e.threatLabels);if(!$){const B="follow:baseline",re=y.map(we=>k(we.suit,we.rank)),he=V(e,e.turn,B,re);return{play:Ne(e),preferredDiscard:a??void 0,chosenBucket:B,bucketCards:re,policyClassByCard:he,decisionSig:r,replay:s}}const I=y.filter(B=>ye[B.rank]<ye[$]),x=y.filter(B=>ye[B.rank]>=ye[$]),A=I.length>0?I:x,P=at(A.length,e.rng),E=A[P]??A[0]??y[0]??null,v=I.length>0?"follow:below":"follow:above",S=A.map(B=>k(B.suit,B.rank)),L=V(e,e.turn,v,S);return{play:E,preferredDiscard:a??void 0,chosenBucket:v,bucketCards:S,policyClassByCard:L,decisionSig:r,replay:s}}if(!e.threat)return{play:null,preferredDiscard:a??void 0,decisionSig:r,replay:s};const l=e.threatLabels??{E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}},o=bt(e.turn,{hands:e.hands},i,e.threat,l),c=[{name:"tier1a",cards:o.tier1a},{name:"tier1b",cards:o.tier1b},{name:"tier1c",cards:o.tier1c},{name:"tier2a",cards:o.tier2a},{name:"tier2b",cards:o.tier2b},{name:"tier3a",cards:o.tier3a},{name:"tier3b",cards:o.tier3b},{name:"tier4",cards:o.tier4}].find(y=>y.cards.length>0)??{name:"tier4",cards:o.tier4},u=at(c.cards.length,e.rng),h=c.cards[u]??c.cards[0],{suit:p,rank:f}=H(h),C=V(e,e.turn,c.name,c.cards)??{};for(const y of[...o.tier2a,...o.tier2b,...o.tier3a,...o.tier3b])C[y]=`busy:${y[0]}`;const b={};return o.tier2a.length>0&&(b.tier2a=[...o.tier2a]),o.tier2b.length>0&&(b.tier2b=[...o.tier2b]),o.tier3a.length>0&&(b.tier3a=[...o.tier3a]),o.tier3b.length>0&&(b.tier3b=[...o.tier3b]),{play:{seat:e.turn,suit:p,rank:f},preferredDiscard:a??void 0,chosenBucket:c.name,bucketCards:[...c.cards],policyClassByCard:C,tierBuckets:b,decisionSig:r,replay:s}}function Nt(e,t,n,r,s,a,i,l,o,d){const c=[],u=k(t.suit,t.rank),h=q(e,t.seat,u).classId;if(!Tn(e.hands[t.seat],t.suit,t.rank))return c.push({type:"illegal",reason:`Card ${t.suit}${t.rank} not in ${t.seat} hand`}),c;if(e.trick.push({...t}),e.trickClassIds.push(`${t.seat}:${h}`),n==="autoplay"?c.push({type:n,play:{...t},preferredDiscard:r,chosenBucket:s,bucketCards:a,policyClassByCard:i,tierBuckets:l,decisionSig:o,replay:d}):c.push({type:n,play:{...t}}),e.threat&&e.threatLabels){const y=Mt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},k(t.suit,t.rank));e.threat=y.threat,e.threatLabels=y.labels,e.cardRoles={...y.perCardRole}}if(e.trick.length<4)return e.turn=wn(e.turn),c;const f=e.trick.map(y=>({...y})),C=Dn(f,e.trumpSuit),b=Nn(C);return e.tricksWon[b]+=1,e.trick=[],e.trickClassIds=[],e.leader=C,e.turn=C,c.push({type:"trickComplete",winner:C,trick:f}),Qe(e.hands)&&(e.phase="end",c.push({type:"handComplete",success:Ln(e.goal,e.tricksWon),tricksWon:{...e.tricksWon}})),c}function Je(e){const t=e.contract.strain==="NT"?null:e.contract.strain,n=Object.values(e.policies).some(l=>l?.kind==="threatAware");let r=null,s=null,a={};if(n){if(!e.threatCardIds||e.threatCardIds.length===0)throw new Error(`Problem ${e.id} uses threatAware policy but has no threatCardIds`);const l=vt({hands:e.hands},e.threatCardIds);r=l.threat,s=l.labels,a={...l.perCardRole}}else if(e.threatCardIds&&e.threatCardIds.length>0){const l=vt({hands:e.hands},e.threatCardIds);r=l.threat,s=l.labels,a={...l.perCardRole}}const i={id:e.id,contract:{...e.contract},trumpSuit:t,threat:r,threatLabels:s,cardRoles:a,hands:{N:ae(e.hands.N),E:ae(e.hands.E),S:ae(e.hands.S),W:ae(e.hands.W)},leader:e.leader,turn:e.leader,trick:[],trickClassIds:[],tricksWon:{NS:0,EW:0},phase:"awaitUser",rng:{seed:e.rngSeed>>>0,counter:0},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:Pn(e),preferredDiscardUsed:{},replay:{enabled:!1,transcript:null,cursor:0,divergenceIndex:null,forcedCard:null,forcedClassId:null}};return Qe(i.hands)?i.phase="end":i.phase=Le(i)?"awaitUser":"auto",i}function N(e){if(e.phase==="end")return[];const t=e.hands[e.turn],n=e.trick[0]?.suit,r=n?t[n]??[]:[],s=n&&r.length>0?[n]:$t,a=[];for(const i of s){const l=t[i]??[];for(const o of l)a.push({seat:e.turn,suit:i,rank:o})}return a}function Kn(e,t){const n=Bn(e),r=[];if(n.phase==="end")return r.push({type:"illegal",reason:"Hand already complete"}),{state:n,events:r};if(t.seat!==n.turn)return r.push({type:"illegal",reason:`Expected turn ${n.turn}, got ${t.seat}`}),n.phase=Le(n)?"awaitUser":"auto",{state:n,events:r};if(!N(n).some(i=>i.seat===t.seat&&i.suit===t.suit&&i.rank===t.rank))return r.push({type:"illegal",reason:`Illegal play ${t.seat}:${t.suit}${t.rank}`}),n.phase=Le(n)?"awaitUser":"auto",{state:n,events:r};for(r.push(...Nt(n,t,"played"));!Le(n)&&!Qe(n.hands);){n.phase="auto";const i=n.policies[n.turn];if(!i){r.push({type:"illegal",reason:`No policy configured for auto seat ${n.turn}`});break}const l=jn(n,i);if(!l.play){const o=N(n);r.push({type:"illegal",reason:`Autoplay failed for ${n.turn} (policy=${i?.kind??"none"}, legal=${o.length}${l.replay?.reason?`, replay=${l.replay.reason}`:""})`});break}r.push(...Nt(n,l.play,"autoplay",l.preferredDiscard,l.chosenBucket,l.bucketCards,l.policyClassByCard,l.tierBuckets,l.decisionSig,l.replay))}return Qe(n.hands)?(n.phase="end",{state:n,events:r}):(n.phase=Le(n)?"awaitUser":"auto",{state:n,events:r})}function Hn(e,t){return t.E.busy.has(e)||t.W.busy.has(e)}function qn(e,t){if(!t.threatCardIds.includes(e))return!1;const{suit:n}=e.length>=2?{suit:e[0]}:{suit:"S"},r=t.threatsBySuit[n];return!!(r?.active&&r.threatCardId===e)}function Mn(e,t,n){const{suit:r}=e.length>=2?{suit:e[0]}:{suit:"S"},s=t.threatsBySuit[r];if(!s||!s.active||s.threatCardId!==e)return!1;const a=[...n.E.busy].some(l=>l.startsWith(r)),i=[...n.W.busy].some(l=>l.startsWith(r));return!a&&!i}function Jt(e,t,n,r){return r?Mn(e,t,n)?"purple":qn(e,t)?"green":Hn(e,n)?"blue":"black":"black"}function Un(e,t){const n=e.triedByIdx.get(t.index)??new Set;n.add(t.chosenAltClassId||t.chosenClassId),e.triedByIdx.set(t.index,n);const r=e.recordedRemainingByIdx.get(t.index)??new Set;for(const a of t.sameBucketAlternativeClassIds)r.add(a);e.recordedRemainingByIdx.set(t.index,r);const s=e.representativeByIdx.get(t.index)??new Map;for(const[a,i]of Object.entries(t.representativeCardByClass))s.set(a,i);s.set(t.chosenAltClassId||t.chosenClassId,t.chosenCard),e.representativeByIdx.set(t.index,s)}function Gn(e,t,n){const r=[...e.recordedRemainingByIdx.keys()].sort((a,i)=>a-i),s=[];for(const a of r){if(t&&!t.has(a)||typeof n=="number"&&a>=n)continue;const i=e.recordedRemainingByIdx.get(a)??new Set,l=e.triedByIdx.get(a)??new Set,o=[...i].filter(d=>!l.has(d)).sort();o.length>0&&s.push({index:a,remainingKeys:o})}return s}const Yn={id:"p001",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:[],H:[],D:["A","K","Q"],C:[]},S:{S:["5"],H:[],D:["2"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8"]},Fn={id:"p002",contract:{strain:"C"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:7},hands:{N:{S:["A","Q","9","5","4"],H:["A","K","2"],D:[],C:[]},W:{S:["J","T","8"],H:["Q","T","8"],D:["A","Q"],C:[]},E:{S:["K","7","6"],H:["J","9","7"],D:["K","J"],C:[]},S:{S:[],H:["4","3"],D:["6","5","4"],C:["T","9","8"]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},threatCardIds:["S9","H2","D5"],preferredDiscards:{W:"DA",E:"H7"},rngSeed:202},Qn={id:"p003",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:["Q","T"],H:[],D:["A"],C:[]},S:{S:["5"],H:[],D:["8"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8","D8"]},Vn={id:"p004",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:5},hands:{N:{S:["8"],H:["A","8"],D:["5"],C:["3","2"]},E:{S:[],H:["Q","T"],D:["Q","T","6"],C:["4"]},S:{S:[],H:["5"],D:["A","K","8"],C:["A","K"]},W:{S:["A"],H:["K","J"],D:["J","9","7"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:404,threatCardIds:["S8","H8","D8"]},ve=[{id:"p001",label:"p001",problem:Yn},{id:"p002",label:"p002",problem:Fn},{id:"p003",label:"p003",problem:Qn},{id:"p004",label:"p004",problem:Vn}],_t=document.querySelector("#app");if(!_t)throw new Error("Missing #app");const R=_t,de=["N","E","S","W"],Ae=["S","H","D","C"],F=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],St={S:"♠",H:"♥",D:"♦",C:"♣"},Xt={N:"North",E:"East",S:"South",W:"West"},Lt={strict:"Strict",sameLevel:"Same level",allBusy:"All busy"},Wt=Math.max(...ve.flatMap(({problem:e})=>de.flatMap(t=>Ae.map(n=>e.hands[t][n].length)))),zn=12,Jn=4,_n=9,Xn=4,Zn=4,er=6,Et=17,tr=16,nr=3,rr=16,sr=Math.round(Et*.6),ar=Math.round(Et*.6),ir=zn+Jn+Wt*_n+Math.max(0,Wt-1)*Xn+Zn,Zt=tr+nr+Et*4+rr+er,en=Zt+6;R.style.setProperty("--hand-box-w",`${ir}px`);R.style.setProperty("--hand-box-h",`${Zt}px`);R.style.setProperty("--trick-box-w",`${en}px`);R.style.setProperty("--trick-box-h",`${en}px`);R.style.setProperty("--table-gap-y",`${sr}px`);R.style.setProperty("--table-gap-x",`${ar}px`);R.style.setProperty("--slot-offset","12%");let ue="sameLevel",Z=ve[0].problem,ne=ve[0].id,T=Z.rngSeed>>>0,g=Je({...Z,rngSeed:T}),m=[],ee=[],U=!1,it=!0,ot=!0,Pe=!0,Ve=!1,De=null,lt=null,W=!1,be=null,pe=null,oe=!1,$e=null,Se=null;const Ke=[];let J=[],O=null;const G={triedByIdx:new Map,recordedRemainingByIdx:new Map,representativeByIdx:new Map};let ce=[],Ee=[],K="running",w=!1,j=null,X=null,Ce=0,ie=null,Be=!1,Q=[],_e=1,se=new Map,Ue=null;const or=360,ct=new Map,Ge=new Map;let Oe=0,Xe=0,dt=!1;const Dt=new Map,je=new Map;let ut=!1;nt(g);function M(){De&&(clearTimeout(De),De=null),lt=null}function ft(e,t){return`${e}:${t}`}function lr(){return typeof window<"u"&&!!window.matchMedia?.("(prefers-reduced-motion: reduce)").matches}function Ze(){Ue&&(clearTimeout(Ue),Ue=null)}function tn(){Ze();const e=Date.now();let t=1/0;for(const r of se.values())r>e&&r<t&&(t=r);if(!Number.isFinite(t))return;const n=Math.max(16,t-e+8);Ue=setTimeout(()=>{const r=Date.now();for(const[s,a]of se.entries())a<=r&&se.delete(s);D(),tn()},n)}function cr(e,t){lr()||(se.set(ft(e,t),Date.now()+or),tn())}function Te(e){Q.push({...e,id:_e++}),Q.length>120&&(Q=Q.slice(-120))}function et(){Q=[],_e=1}function nn(){Xe+=1}function dr(e){const t=`${Xe}|${e}`,n=(Dt.get(t)??0)+1;return Dt.set(t,n),n}function z(e){return`run=${Xe} ${e}`}function me(e,t){return`run=${Xe} visit=${dr(e)} ${t}`}function ur(e){const t=new Map(F.map((n,r)=>[n,r]));return[...e].sort((n,r)=>(t.get(n)??99)-(t.get(r)??99))}function ge(e){return`${e.seat}:${e.suit}${tt(e.rank)}`}function rn(e){return{hands:e.hands}}function fr(e){return Array.isArray(e.threatCardIds)?[...e.threatCardIds]:[]}function tt(e){return e==="T"?"10":e}function pt(e){if(!$e||!Se)return"rank--black";const t=Jt(e,$e,Se,Pe);return t==="purple"?"rank--purple":t==="green"?"rank--green":t==="blue"?"rank--blue":"rank--black"}function ht(e,t,n,r=!1){const s=document.createElement("span");if(s.className=`rank ${n}${r?" eq-underline":""}`,t!=="T"){s.textContent=tt(t),e.appendChild(s);return}const a=document.createElement("span");a.className=`rank ten ${n}${r?" eq-underline":""}`;const i=document.createElement("span");i.className="digit-one",i.textContent="1";const l=document.createElement("span");l.className="digit-zero",l.textContent="0",a.append(i,l),e.appendChild(a)}function pr(e){return e.type==="played"?`played ${ge(e.play)}`:e.type==="autoplay"?`autoplay ${ge(e.play)}`:e.type==="illegal"?`illegal ${e.reason}`:e.type==="trickComplete"?`trickComplete winner=${e.winner} trick=${e.trick.map(ge).join(" ")}`:`handComplete success=${e.success} NS=${e.tricksWon.NS} EW=${e.tricksWon.EW}`}function hr(e){return e==="N"||e==="S"?"NS":"EW"}function yr(e){const t=de.indexOf(e);return de[(t+1)%de.length]}function le(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,hands:{N:{S:[...e.hands.N.S],H:[...e.hands.N.H],D:[...e.hands.N.D],C:[...e.hands.N.C]},E:{S:[...e.hands.E.S],H:[...e.hands.E.H],D:[...e.hands.E.D],C:[...e.hands.E.C]},S:{S:[...e.hands.S.S],H:[...e.hands.S.H],D:[...e.hands.S.D],C:[...e.hands.S.C]},W:{S:[...e.hands.W.S],H:[...e.hands.W.H],D:[...e.hands.W.D],C:[...e.hands.W.C]}},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:e.replay.transcript?{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}}:{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:null}}}function sn(e){return e?{threatCardIds:[...e.threatCardIds],threatsBySuit:{...e.threatsBySuit}}:null}function an(e){return e?{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}:null}function on(e){return e?e.map(t=>({...t})):null}function mr(e){return{state:le(g),currentProblemId:ne,currentSeed:T,logs:[...m],deferredLogLines:[...ee],trickFrozen:W,lastCompletedTrick:on(be),frozenViewState:pe?le(pe):null,canLeadDismiss:oe,threatCtx:sn($e),threatLabels:an(Se),play:{...e},runStatus:K,playAgainAvailable:w,playAgainUnavailableReason:j,playAgainLastCandidateIndex:X,replaySuppressedForRun:Be,teachingEvents:Q.map(t=>({...t})),nextTeachingEventId:_e}}function Cr(e){g=le(e.state),ne=e.currentProblemId,Z=ve.find(t=>t.id===ne)?.problem??Z,T=e.currentSeed,m=[...e.logs],ee=[...e.deferredLogLines],W=e.trickFrozen,be=on(e.lastCompletedTrick),pe=e.frozenViewState?le(e.frozenViewState):null,oe=e.canLeadDismiss,$e=sn(e.threatCtx),Se=an(e.threatLabels),K=e.runStatus,w=e.playAgainAvailable,j=e.playAgainUnavailableReason,X=e.playAgainLastCandidateIndex,Be=e.replaySuppressedForRun,Q=e.teachingEvents.map(t=>({...t})),_e=e.nextTeachingEventId}function xt(){je.clear(),ut=!1}function gr(){if(!U||ut||je.size===0)return;const e=[...je.values()].sort((t,n)=>t.idx-n.idx||(t.seat<n.seat?-1:t.seat>n.seat?1:0));m=[...m,"","================= DEFENDER EQ (initial snapshot, first EQCs observed) =================",...e.map(t=>`idx=${t.idx} seat=${t.seat} bucket=${t.bucket} classes={${t.classes.join(",")}} remaining={${t.remaining.join(",")}} chosen=${t.chosen}`),"=========================================================================================",""].slice(-500),ut=!0}function kr(e,t){const n=[];for(const r of Ae)for(const s of ze(e,t,r))n.push(`${r}${s.join("")}`);return n}function nt(e){ct.clear(),Ge.clear();for(const t of e.userControls)for(const n of Ae){const r=ze(e,t,n);for(const s of r){if(s.length===0)continue;const a=k(n,s[0]),l=q(e,t,a).classId;Ge.has(l)||Ge.set(l,a);for(const o of s){const d=k(n,o);ct.set(d,l)}}}}function Ye(e,t){return e!=="N"&&e!=="S"?q(g,e,t).classId:ct.get(t)??q(g,e,t).classId}function br(e,t){return Ge.get(e)??t}function $r(e){const t=["","================= USER EQ (initial) ================="];for(const n of e.userControls){const r=kr(e,n);t.push(`seat=${n} classes: ${r.join("  ")||"-"}`)}return t.push("====================================================="),t.push(""),t}function ln(e,t,n){if(t.play.seat!=="E"&&t.play.seat!=="W"||!t.decisionSig)return null;const r=k(t.play.suit,t.play.rank),s=t.bucketCards?[...t.bucketCards]:[r],a=t.policyClassByCard??{},i=t.chosenBucket??"unknown",l=t.tierBuckets??{};let o=[...s];if((i.startsWith("tier2")||i.startsWith("tier3"))&&ue!=="strict"){const p=ue==="sameLevel"?[`tier${i.startsWith("tier2")?"2":"3"}a`,`tier${i.startsWith("tier2")?"2":"3"}b`]:["tier2a","tier2b","tier3a","tier3b"],f=[];for(const C of p)for(const b of l[C]??[])f.includes(b)||f.push(b);f.length>0&&(o=f)}const d=p=>{if(i.startsWith("tier1"))return"idle:tier1";if(i.startsWith("tier2")||i.startsWith("tier3"))return`busy:${p[0]}`;if(i==="tier4")return`other:${p[0]}`;const f=e.threatLabels;if(f){if(f[t.play.seat].busy.has(p))return`busy:${p[0]}`;if(f[t.play.seat].idle.has(p))return"idle:tier1"}const C=a[p];return C||q(e,t.play.seat,p).classId},c=[],u=d(r);for(const p of o){const f=d(p);c.includes(f)||c.push(f)}const h=c.filter(p=>p!==u);return{idx:n,seat:t.play.seat,bucket:i,classes:c,remaining:h,chosen:u,eqByTier:xr(e,t)}}function fe(e){const t={S:0,H:1,D:2,C:3};return[...e].sort((n,r)=>{const s=F.indexOf(n[1]),a=F.indexOf(r[1]);return s!==a?s-a:t[n[0]]-t[r[0]]})}function Tt(e){const n=["tier1a","tier1b","tier1c","tier2a","tier2b","tier3a","tier3b","tier4","follow:below","follow:above","follow:baseline","lead:none","legal","preferred"].indexOf(e);return n>=0?n:999}function Sr(e){return e.startsWith("tier")?e.slice(4):e.startsWith("follow:")?e.slice(7):e==="lead:none"?"lead":e}function Er(e,t){const n=new Map,r=N(e).filter(i=>i.seat===t.play.seat).map(i=>k(i.suit,i.rank)),s=e.trick[0]?.suit??null;if(!s){for(const i of r)n.set(i,"lead:none");return n}if(e.hands[e.turn][s].length===0&&e.threat&&e.threatLabels){const i=bt(e.turn,rn(e),s,e.threat,e.threatLabels),l=[["tier1a",i.tier1a],["tier1b",i.tier1b],["tier1c",i.tier1c],["tier2a",i.tier2a],["tier2b",i.tier2b],["tier3a",i.tier3a],["tier3b",i.tier3b],["tier4",i.tier4]];for(const[o,d]of l)for(const c of d)n.has(c)||n.set(c,o);return n}if(e.hands[e.turn][s].length>0){const i=N(e).filter(o=>o.seat===e.turn).map(o=>k(o.suit,o.rank));if(!e.threat||!e.threatLabels){for(const o of i)n.set(o,"follow:baseline");return n}const l=Ie(s,e.threat,e.threatLabels);if(!l){for(const o of i)n.set(o,"follow:baseline");return n}for(const o of i){const d=o[1];n.set(o,F.indexOf(d)>F.indexOf(l)?"follow:below":"follow:above")}return n}for(const i of r)n.set(i,t.chosenBucket??"unknown");return n}function xr(e,t){const n=Er(e,t),r=new Map;for(const[u,h]of n.entries()){let p=t.policyClassByCard?.[u];p||(h.startsWith("tier1")?p="idle:tier1":h.startsWith("tier2")||h.startsWith("tier3")?p=`busy:${u[0]}`:h==="tier4"?p=`other:${u[0]}`:p=q(e,t.play.seat,u).classId);const f=r.get(p)??new Map,C=f.get(h)??[];C.push(u),f.set(h,C),r.set(p,f)}const s=["busy:S","busy:H","busy:D","busy:C"],a=[...r.entries()],i=a.find(([u])=>u.startsWith("idle")),l=s.map(u=>a.find(([h])=>h===u)).filter(u=>!!u),o=a.filter(([u])=>!u.startsWith("idle")&&!s.includes(u)).sort((u,h)=>u[0].localeCompare(h[0])),d=(u,h)=>{const p=[...h.entries()].sort((f,C)=>Tt(f[0])-Tt(C[0])).map(([f,C])=>`${Sr(f)}:{${fe(C).join(" ")}}`).join(" ");return`${u}(${p})`},c=[];i?c.push(d(i[0],i[1])):c.push("idle:None");for(const[u,h]of[...l,...o])c.push(d(u,h));return c.join(", ")}function cn(e,t){const n=e[1];return F.indexOf(n)>F.indexOf(t)}function Ir(e){const t=e.threat,n=e.threatLabels,r=[],s=["E","W"],a=["C","D","H","S"],i=["S","H","D","C"],l=["tier2a","tier2b","tier3a","tier3b"];for(const o of s){const d=i.filter(p=>!!t?.threatsBySuit[p]),c=[];for(const p of a){if(d.includes(p))continue;const f=fe(e.hands[o][p].map(C=>k(p,C)));f.length>0&&c.push(`idle:${p}{${f.join(" ")}}`)}const u=c.length>0?c.join(" "):"idle:(None)",h=[];for(const p of d){const f=fe(e.hands[o][p].map(x=>k(p,x)));if(f.length===0){h.push(`busy:${p}(None)`);continue}const C=t&&n?Ie(p,t,n):null,y=t?.threatsBySuit[p]?.stopStatus==="double"?"2":"3",$=new Map;for(const x of f){const A=C&&cn(x,C)?`tier${y}a`:`tier${y}b`,P=$.get(A)??[];P.push(x),$.set(A,P)}const I=l.filter(x=>($.get(x)?.length??0)>0).map(x=>`${x.slice(4)}:{${fe($.get(x)??[]).join(" ")}}`);h.push(`busy:${p}(${I.join(" ")||"None"})`)}r.push(`seat=${o} | ${u} | ${h.join(" | ")||"busy:(None)"}`)}return["","================= DEFENDER INVENTORY EQ (initial) =================",...r,"===================================================================",""]}function vr(e,t){const n=e.threat,r=e.threatLabels,s=["C","D","H","S"],a=["S","H","D","C"],i=["tier2a","tier2b","tier3a","tier3b"],l=a.filter(u=>!!n?.threatsBySuit[u]),o=[];for(const u of s){const h=fe([...r?.[t].idle??new Set].filter(p=>p[0]===u));h.length>0&&o.push(`idle:${u}{${h.join(" ")}}`)}const d=o.length>0?o.join(" "):"idle:(None)",c=[];for(const u of l){const h=fe([...r?.[t].busy??new Set].filter($=>$[0]===u));if(h.length===0){c.push(`busy:${u}(None)`);continue}const p=n&&r?Ie(u,n,r):null,C=n?.threatsBySuit[u]?.stopStatus==="double"?"2":"3",b=new Map;for(const $ of h){const I=p&&cn($,p)?`tier${C}a`:`tier${C}b`,x=b.get(I)??[];x.push($),b.set(I,x)}const y=i.filter($=>(b.get($)?.length??0)>0).map($=>`${$.slice(4)}:{${fe(b.get($)??[]).join(" ")}}`);c.push(`busy:${u}(${y.join(" ")||"None"})`)}return`${d} | ${c.join(" | ")||"busy:(None)"}`}function Rt(e,t,n){const r=new Map;for(const s of de)for(const a of Ae)for(const i of e.hands[s][a]){const l=k(a,i),o=t&&n?Jt(l,t,n,Pe):"black",d=e.cardRoles[l]??"default";r.set(l,{color:o,role:d,seat:s})}return r}function Ar(e,t,n){const r=[],s=l=>`${l[0]}${tt(l.slice(1))}`;for(const[l,o]of t.entries()){const d=n.get(l);if(d&&!(o.color===d.color&&o.role===d.role)){if(o.color!==d.color&&cr(o.seat,l),d.role==="idle"&&o.role!=="idle"){r.push(`${s(l)} idle`);continue}if(d.role==="promotedWinner"&&o.role!=="promotedWinner"){r.push(`${s(l)} promoted`);continue}d.role==="busy"&&o.role!=="busy"&&r.push(`${s(l)} busy`)}}if(r.length===0)return;const a=r.slice(0,6),i=r.length-a.length;Te({kind:"recolor",label:`${s(e)} -> ${a.join(", ")}${i>0?` (+${i} more)`:""}`})}function Br(e,t){const n=le(e);for(const r of t){if(r.type==="played"||r.type==="autoplay"){const s=Rt(n,n.threat??null,n.threatLabels??null);xe(n,r);const a=Rt(n,n.threat??null,n.threatLabels??null),i=k(r.play.suit,r.play.rank);Ar(i,s,a);continue}xe(n,r)}}function wr(e){const t=e.threat,n=e.threatLabels;if(!t||!n){Te({kind:"info",at:"Start",label:"No teaching events yet."});return}const r=["S","H","D","C"],s=[];for(const a of r){const i=t.threatsBySuit[a];if(!i)continue;const l=Xt[i.establishedOwner],o=`${St[a]}${tt(i.threatRank)}`,d=[...n.E.busy].some(h=>h[0]===a),c=[...n.W.busy].some(h=>h[0]===a);let u="unstopped";d&&c?u="stopped by both":c?u="stopped by West only":d&&(u="stopped by East only"),s.push(`${l} has ${o}, ${u}.`)}if(s.length===0){Te({kind:"info",at:"Start",label:"No teaching events yet."});return}Te({kind:"threatSummary",at:"Start",label:"Threats:",detail:s.join(`
`)})}function xe(e,t){if(t.type==="played"||t.type==="autoplay"){const n=k(t.play.suit,t.play.rank),r=q(e,t.play.seat,n).classId,s=e.hands[t.play.seat][t.play.suit],a=s.indexOf(t.play.rank);if(a>=0&&s.splice(a,1),e.trick.push({...t.play}),e.trickClassIds.push(`${t.play.seat}:${r}`),e.threat&&e.threatLabels){const i=Mt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},k(t.play.suit,t.play.rank));e.threat=i.threat,e.threatLabels=i.labels,e.cardRoles={...i.perCardRole}}e.turn=yr(e.turn);return}if(t.type==="trickComplete"){e.trick=[],e.trickClassIds=[],e.leader=t.winner,e.turn=t.winner,e.tricksWon[hr(t.winner)]+=1;return}t.type==="handComplete"&&(e.phase="end",e.tricksWon={...t.tricksWon})}function st(e,t,n,r){const s=[],a=le(e);for(const i of n){if(i.type==="played"||i.type==="autoplay"){Ce>0&&s.push(""),Ce+=1,s.push(`----- PLAY ${Ce} -----`);const l=k(i.play.suit,i.play.rank);let o=`play ${i.play.seat}:${l} (${i.type==="played"?"user":"auto"})`;if(i.type==="played"){const d=Ye(i.play.seat,l);o+=` | eq=${d}`}else{const d=ln(a,i,-1);if(d)o+=` | eq=${d.chosen} (card=${l}; bucket=${d.bucket}; remaining=${d.remaining.join(",")||"-"})`;else{const c=q(a,i.play.seat,l).classId;o+=` | eq=${c}${i.chosenBucket?` (card=${l}; bucket=${i.chosenBucket})`:""}`}}s.push(o)}if(U&&i.type==="autoplay"){if(i.replay?.action==="forced"&&s.push(`[PLAYAGAIN] forcing index=${i.replay.index??"?"} card=${i.replay.card??`${i.play.suit}${i.play.rank}`}`),i.replay?.action==="disabled"&&(i.replay.reason==="class-not-legal"?s.push(`[PLAYAGAIN] force failed idx=${i.replay.index??"?"} forcedClass=${i.replay.forcedClassId??"-"} reason=class-not-legal; continuing unforced`):s.push(`[PLAYAGAIN] replay disabled due to ${i.replay.reason??"mismatch"}`)),i.preferredDiscard){const o=i.preferredDiscard;o.applied&&o.chosen?s.push(`[PREFDISC] seat=${i.play.seat} applied preferred discard=${o.chosen}`):s.push(`[PREFDISC] seat=${i.play.seat} preferred=${o.preferred.join("/")} not-applied reason=${o.reason}`)}if(a.policies[a.turn]?.kind==="threatAware"&&a.trick.length>0&&a.hands[a.turn][a.trick[0].suit].length>0){const o=a.trick[0].suit,d=N(a).map(u=>`${u.suit}${u.rank}`),c=a.threat&&a.threatLabels?Ie(o,a.threat,a.threatLabels):null;if(c){const u=N(a).filter(p=>F.indexOf(p.rank)>F.indexOf(c)),h=N(a).filter(p=>F.indexOf(p.rank)<=F.indexOf(c));s.push(`[THREAT] follow seat=${a.turn} ledSuit=${o} threshold=${c} inSuit=${d.length} chosen=${i.play.suit}${i.play.rank} below=${u.length} above=${h.length}`)}else s.push(`[THREAT] follow seat=${a.turn} ledSuit=${o} threshold=- inSuit=${d.length} chosen=${i.play.suit}${i.play.rank} mode=baseline`)}if((a.turn==="E"||a.turn==="W")&&a.trick.length>0&&a.hands[a.turn][a.trick[0].suit].length===0&&a.threat&&a.threatLabels){const o=a.trick[0].suit,d=a.threat,c=a.threatLabels,u=bt(a.turn,rn(a),o,d,c),h=[["t2a",u.tier2a.length],["t2b",u.tier2b.length],["t3a",u.tier3a.length],["t3b",u.tier3b.length]].filter(([,p])=>p>0).map(([p,f])=>`${p}:${f}`).join(" ");s.push(`[THREAT] discard seat=${a.turn} ledSuit=${o} legal=${u.legal.length} chosen=${i.play.suit}${i.play.rank} bucket=${i.chosenBucket??"-"} tiers=${h||"-"}`)}}if((i.type==="illegal"||i.type==="handComplete")&&s.push(pr(i)),xe(a,i),U&&i.type==="illegal"){const l=a.trick[0]?.suit??"none",o=N(a).slice(0,10).map(ge).join(" ");s.push(`illegalContext attempted=${ge(t)} turn=${a.turn} leadSuit=${l} legal=${o||"-"}`)}i.type==="trickComplete"&&(s.push(`----- TRICK COMPLETE ----- winner=${i.winner} trick=${i.trick.map(ge).join(" ")}`),s.push(""))}return s}function Nr(e,t){const n=le(e);for(const r of t){if(r.type==="autoplay"&&(r.play.seat==="E"||r.play.seat==="W")&&r.decisionSig){Oe+=1;const s=Ee.join(" > ");U&&(m=[...m,me(s||"-",`[INV_EQ:atDecision] idx=${J.length} seat=${r.play.seat} nodeKey=${s||"-"} invEq=${vr(n,r.play.seat)}`)].slice(-500));const a=ln(n,r,J.length);if(!a){xe(n,r);continue}const i=k(r.play.suit,r.play.rank),l=q(n,r.play.seat,i).classId,o=a.chosen,d=[...a.classes],c=[...a.remaining],u=r.bucketCards?[...r.bucketCards]:[i],h=E=>{if(a.bucket.startsWith("tier1"))return"idle:tier1";if(a.bucket.startsWith("tier2")||a.bucket.startsWith("tier3"))return`busy:${E[0]}`;if(a.bucket==="tier4")return`other:${E[0]}`;const v=n.threatLabels;if(v){if(v[r.play.seat].busy.has(E))return`busy:${E[0]}`;if(v[r.play.seat].idle.has(E))return"idle:tier1"}return r.policyClassByCard?.[E]??q(n,r.play.seat,E).classId},p={};for(const E of u){const v=h(E);p[v]||(p[v]=E)}d.includes(o)&&(p[o]=i);const f=n.threatLabels,C=d.filter(E=>{if(E.startsWith("idle"))return!0;const v=u.filter(S=>h(S)===E);return v.length>0&&!!f&&v.every(S=>f[r.play.seat].idle.has(S))}),b=r.replay?.action==="forced"&&n.replay.transcript&&typeof r.replay.index=="number"?n.replay.transcript.decisions[r.replay.index]:null,y=[...a.remaining],$=null;if(b&&b.seat===r.play.seat){const E=[b.chosenAltClassId??b.chosenClassId,...b.sameBucketAlternativeClassIds].filter((v,S,L)=>v&&L.indexOf(v)===S);d.splice(0,d.length,...E);for(const[v,S]of Object.entries(b.representativeCardByClass))p[v]=S;if(d.includes(o)||d.push(o),p[o]=i,U&&(y&&y.join(",")!==b.sameBucketAlternativeClassIds.join(",")||!y&&$)){const v=y?y.join(",")||"-":"unavailable:unknown",S=a.classes,L=new Set(b.invEqIdleClasses),B=S.filter(he=>!he.startsWith("idle")&&!L.has(he)),re=y&&y.length>0?"ok":"singleton";m=[...m,me(b.nodeKey||"-",`[EQC:replay] idx=${r.replay.index} recordedRemaining=${b.sameBucketAlternativeClassIds.join(",")||"-"} runtimeRemaining=${v}`),me(b.nodeKey||"-",`[EQC:replayRemaining] idx=${r.replay.index} seat=${r.play.seat} nodeKey=${b.nodeKey||"-"} policyScope=${ue} availClasses={${S.join(",")||"-"}} branchableAvail={${B.join(",")||"-"}} chosenClass=${o} computedRemaining={${y?.join(",")||"-"}} reason=${re}`)].slice(-500)}}const I=u.filter(E=>h(E)===o);U&&(m=[...m,me(s||"-",`[EQC] idx=${J.length} seat=${r.play.seat} nodeKey=${s||"-"} scope=${ue} bucket=${a.bucket} classes=${d.join(",")||"-"} chosen=${o} covers=${I.join(",")||"-"} remaining=${c.join(",")||"-"} invEqVersion=${Oe}`)].slice(-500));const x=J.length,A=r.play.seat,P=`${x}:${A}`;je.has(P)||je.set(P,{idx:x,seat:A,bucket:a.bucket,classes:[...d],remaining:[...c],chosen:o,eqByTier:a.eqByTier}),gr(),J.push({index:J.length,seat:r.play.seat,nodeKey:s,sig:r.decisionSig,chosenCard:i,chosenClassId:l,chosenAltClassId:o,invEqIdleClasses:C,chosenBucket:a.bucket,bucketCards:u,sameBucketAlternativeClassIds:d.filter(E=>E!==o),representativeCardByClass:p}),Ee.push(o)}xe(n,r)}}function Lr(e){const t=e.goal;return t.type==="minTricks"?`${t.side} ${t.n} tricks`:"Unknown goal"}function Wr(){return W&&pe?pe:g}function He(e){W=!1,be=null,pe=null,oe=!1,e&&ee.length>0&&(m=[...m,...ee].slice(-500),ee=[])}function Re(e,t){return t.startsWith("idle")||e.invEqIdleClasses.includes(t)}function dn(e,t,n,r){const s=new Set(e.decisions.map(o=>o.index)),a=Gn(t,s,n),i=[],l=[];for(const o of e.decisions){const d=[o.chosenAltClassId??o.chosenClassId,...o.sameBucketAlternativeClassIds].filter((C,b,y)=>!!C&&y.indexOf(C)===b),c=d.filter(C=>Re(o,C)),u=d.filter(C=>!Re(o,C)),p=(a.find(C=>C.index===o.index)?.remainingKeys??[]).filter(C=>!Re(o,C)),f=u.length>=2&&p.length>0;i.push(me(o.nodeKey||"-",`[PLAYAGAIN] candCheck idx=${o.index} seat=${o.seat} nodeKey=${o.nodeKey||"-"} avail={${d.join(",")||"-"}} invEqIdle={${c.join(",")||"-"}} -> branchableAvail={${u.join(",")||"-"}} branchable=${f} reason=${f?r:"idleFiltered"}`)),f&&l.push({index:o.index,seat:o.seat,nodeKey:o.nodeKey||"-",avail:d,invEqIdle:c,branchableAvail:u,remainingKeys:p})}return{candidates:l,logsOut:i}}function Pt(e,t){const n=de.map(s=>`${s}:${Ae.map(a=>e.hands[s][a].join("")).join("/")}`).join("|"),r=e.trick.map(s=>`${s.seat}${s.suit}${s.rank}`).join(",");return`${e.phase}|${e.turn}|${e.leader}|${r}|${n}|${t.seat}${t.suit}${t.rank}`}function un(){const n=g.userControls.includes(g.turn)&&(!W&&g.phase==="awaitUser"||W&&oe&&g.phase!=="end");if(!Ve||!n){M();return}const r=N(g).filter(i=>i.seat===g.turn);if(r.length!==1){M();return}const s=r[0],a=Pt(g,s);De&&lt===a||(M(),lt=a,De=setTimeout(()=>{const o=g.userControls.includes(g.turn)&&(!W&&g.phase==="awaitUser"||W&&oe&&g.phase!=="end");if(!Ve||!o){M();return}const d=N(g).filter(u=>u.seat===g.turn);if(d.length!==1){M();return}const c=d[0];if(Pt(g,c)!==a){M();return}M(),fn(c)},500))}function rt(e,t){t&&(m=[]);const n=fr(Z);if($e=g.threat??null,Se=g.threatLabels??null,t&&et(),n.length===0){Q.length===0&&Te({kind:"info",at:"Start",label:"No teaching events yet."});return}Q.some(r=>r.kind==="threatSummary")||wr(g),U&&(dt||nn(),dt=!1,m=[...m,`[THREAT:init] problem=${e} raw=${n.join(",")} validation=OK`].slice(-500),m=[...m,...$r(g)].slice(-500),m=[...m,...Ir(g)].slice(-500))}function yt(e,t){M(),Ze(),se.clear();const n=e>>>0;n!==T>>>0&&(G.triedByIdx.clear(),G.recordedRemainingByIdx.clear(),G.representativeByIdx.clear()),T=n,g=Je({...Z,rngSeed:T}),m=[...m,`${t} seed=${T}`].slice(-500),K="running",Ce=0,Oe=0,ie=null,Be=!1,w=!1,j=null,X=null,J=[],ce=[],Ee=[],et(),nt(g),xt(),Ke.length=0,ee=[],He(!1),rt(ne,!1),D()}function Dr(e){M(),Ze(),se.clear();const t=ve.find(n=>n.id===e);t&&(Z=t.problem,ne=t.id,T=Z.rngSeed>>>0,g=Je({...Z,rngSeed:T}),K="running",Ce=0,Oe=0,ie=null,Be=!1,w=!1,j=null,X=null,J=[],ce=[],Ee=[],et(),nt(g),xt(),O=null,G.triedByIdx.clear(),G.recordedRemainingByIdx.clear(),G.representativeByIdx.clear(),Ke.length=0,ee=[],He(!1),rt(ne,!0),D())}function Tr(){M();const e=Ke.pop();e&&(Cr(e),Ze(),se.clear(),m=[...m,`[UNDO] restored snapshot before user play: ${e.play.seat}:${k(e.play.suit,e.play.rank)}`].slice(-500),D())}function fn(e){if(M(),g.replay.enabled&&g.replay.transcript&&(e.seat==="N"||e.seat==="S")){const a=k(e.suit,e.rank),i=Ye(e.seat,a),l=g.replay.transcript.userPlays[ce.length];if(l&&l.playClassId!==i){const o=g.replay.cursor;g.replay.enabled=!1,Be=!0,m=[...m,`[PLAYAGAIN] user diverged at decisionIdx=${o} expectedClass=${l.playClassId} actualClass=${i}; continuing without forcing further decisions`].slice(-500)}else if(U){const o=Ye(e.seat,a),d=br(o,a);m=[...m,`[EQ] seat=${e.seat} played=${a} class=${o} rep=${d}`].slice(-500)}}if(e.seat==="N"||e.seat==="S"){const a=k(e.suit,e.rank),i=Ye(e.seat,a);ce.push({index:ce.length,seat:e.seat,playClassId:i}),Ee.push(i)}Ke.push(mr(e)),W&&He(!0);const t=g,n=Kn(g,e);g=n.state,$e=g.threat??null,Se=g.threatLabels??null,Br(t,n.events);const r=n.events.findIndex(a=>a.type==="trickComplete");if(Nr(t,n.events),r>=0){const a=n.events.slice(0,r+1),i=n.events.slice(r+1),l=le(t);for(const c of a)xe(l,c);W=!0,pe=l;const o=a[a.length-1];o.type==="trickComplete"&&(be=o.trick.map(c=>({...c}))),oe=g.phase!=="end"&&g.trick.length===0&&g.userControls.includes(g.turn);const d=st(t,e,a);if(m=[...m,...d].slice(-500),i.length>0){const c=st(l,e,i);ee=[...ee,...c].slice(-500)}}else{const a=st(t,e,n.events);m=[...m,...a].slice(-500)}const s=n.events.find(a=>a.type==="handComplete");if(s?.type==="handComplete"&&s.success){O={problemId:ne,seed:T,decisions:J.map(o=>({...o,bucketCards:[...o.bucketCards],sameBucketAlternativeClassIds:[...o.sameBucketAlternativeClassIds],representativeCardByClass:{...o.representativeCardByClass}})),userPlays:ce.map(o=>({...o}))},m=[...m,`[PLAYAGAIN] recorded transcript ${O.decisions.length} decisions`].slice(-500);for(const o of O.decisions)Un(G,o);const{candidates:a,logsOut:i}=dn(O,G,ie,"endOfRunSuccess");w=a.length>0,j=w?null:ie!==null?"user-mismatch-exhausted":"exhausted-all-variations",X=w?a[a.length-1].index:null;const l=w?(()=>{const o=a[a.length-1],d=o.remainingKeys[0]??"-",c=G.representativeByIdx.get(o.index)?.get(d)??"-";return z(`[PLAYAGAIN] offer available=true candidates=[${a.map(u=>u.index).join(",")}] chosenCandidate=${o.index} forcedClass=${d} forcedCard=${c} reason=endOfRunSuccess`)})():null;m=[...m,...i,`[PLAYAGAIN] candidates=[${a.map(o=>o.index).join(",")}] cutoffIdx=${ie??"-"}`,...a.map(o=>`[PLAYAGAIN] idx=${o.index} remainingUntried=${o.remainingKeys.length} keys=${o.remainingKeys.join(",")}`),...l?[l]:[],w?`[PLAYAGAIN] availability ok=true lastCandidateIndex=${X}`:`[PLAYAGAIN] availability ok=false reason=${j}`].slice(-500)}if(s?.type==="handComplete"){const a=s.success?"success":"failure";U&&(m=[...m,`[GOAL] endOfRun=true NSwon=${s.tricksWon.NS} EWwon=${s.tricksWon.EW} required${g.goal.side}>=${g.goal.n} success=${s.success}`,`[RUNSTATUS] ${K} -> ${a}`].slice(-500)),K=a}D()}function Rr(e="autoplay"){if(M(),!O){w=!1,j="exhausted-all-variations",X=null,m=[...m,`[PLAYAGAIN] availability ok=false reason=${j}`].slice(-500),D();return}const{candidates:t,logsOut:n}=dn(O,G,ie,e==="manual"?"manualRequest":"offerCheck");if(w=t.length>0,j=w?null:ie!==null?"user-mismatch-exhausted":"exhausted-all-variations",X=w?t[t.length-1].index:null,m=[...m,...n,z(`[PLAYAGAIN] candidates=[${t.map(c=>c.index).join(",")}] cutoffIdx=${ie??"-"}`),...t.map(c=>`[PLAYAGAIN] idx=${c.index} remainingUntried=${c.remainingKeys.length} keys=${c.remainingKeys.join(",")}`)].slice(-500),w){const c=t[t.length-1],u=c.remainingKeys[0]??"-",h=G.representativeByIdx.get(c.index)?.get(u)??"-";m=[...m,z(`[PLAYAGAIN] offer shown candidates=[${t.map(p=>p.index).join(",")}] reason=${e==="manual"?"manualRequest":"other"}`),z(`[PLAYAGAIN] offer available=true candidates=[${t.map(p=>p.index).join(",")}] chosenCandidate=${c.index} forcedClass=${u} forcedCard=${h} reason=${e==="manual"?"manualRequest":"other"}`)].slice(-500)}if(!w){m=[...m,`[PLAYAGAIN] availability ok=false reason=${j}`].slice(-500),D();return}const r=O?.seed??T;g=Je({...Z,rngSeed:r});let s=null,a=null,i=null;const l=[];for(const c of t)c.remainingKeys.length>0&&l.push(`[EQC:playagain] idx=${c.index} remaining=${c.remainingKeys.join(",")||"-"}`);const o=t[t.length-1];if(s=o.index,a=o.remainingKeys[0]??null,a&&(i=G.representativeByIdx.get(s)?.get(a)??null,m=[...m,`[PLAYAGAIN] candidates=[${t.map(u=>u.index).join(",")}] chosen=${s}`].slice(-500),m=[...m,`[PLAYAGAIN] divergenceIndex=${s} forcedClass=${a} forcedCard=${i??"-"}`].slice(-500)),U&&(m=[...m,"----- PLAY AGAIN COVERAGE -----",...l.length>0?l:["[EQC:playagain] none"]].slice(-500)),!a||s===null){w=!1,j="exhausted-all-variations",X=null,m=[...m,`[PLAYAGAIN] availability ok=false reason=${j}`].slice(-500),D();return}nn(),dt=!0,m=[...m,z(`[PLAYAGAIN] offer selected chosenCandidate=${s} divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"} source=${e==="manual"?"uiClick":"other"}`),z(`[PLAYAGAIN] ${e==="manual"?"manual":"autoplay"} selected=true source=${e==="manual"?"uiClick":"other"} -> starting replay divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"}`)].slice(-500),g.replay={enabled:!0,transcript:{problemId:O.problemId,seed:O.seed,decisions:O.decisions.map(c=>({...c,bucketCards:[...c.bucketCards],sameBucketAlternativeClassIds:[...c.sameBucketAlternativeClassIds],representativeCardByClass:{...c.representativeCardByClass}})),userPlays:O.userPlays.map(c=>({...c}))},cursor:0,divergenceIndex:s,forcedCard:i,forcedClassId:a},T=r,K="running",Ce=0,Oe=0,Be=!1,w=!1,j=null,X=null,J=[],ce=[],Ee=[],et(),nt(g),xt(),ee=[],He(!1);const d=[z("[PLAYAGAIN] replayStart candidates summary:")];for(const c of O.decisions){const u=[c.chosenAltClassId??c.chosenClassId,...c.sameBucketAlternativeClassIds].filter((f,C,b)=>!!f&&b.indexOf(f)===C),h=u.filter(f=>!Re(c,f));if(h.length<2)continue;const p=c.index===s?` FORCING=${a}`:"";d.push(me(c.nodeKey||"-",`[PLAYAGAIN] idx=${c.index} seat=${c.seat} nodeKey=${c.nodeKey||"-"} avail={${u.join(",")}} branchableAvail={${h.join(",")}} chosen=${c.chosenAltClassId} remaining={${c.sameBucketAlternativeClassIds.filter(f=>!Re(c,f)).join(",")||"-"}}${p}`))}m=[...m,z(`[PLAYAGAIN] replayStart plan divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"} source=${e}`),...d,z(`===== PLAY AGAIN REPLAY ===== divergenceIdx=${s} forced=${i??"-"} forcedClass=${a}`),z("[PLAYAGAIN] replay enabled"),""].slice(-500),rt(ne,!1),D()}function Pr(e,t,n,r,s){const a=document.createElement("div");a.className="suit-row";const i=document.createElement("span");i.className=`suit-symbol suit-${n}`,i.textContent=St[n],a.appendChild(i);const l=document.createElement("div");l.className="cards";const o=ur(e.hands[t][n]),d=new Set;if(Pe){for(const c of ze(e,t,n))if(c.length>1)for(const u of c)d.add(u)}if(o.length>0)for(const c of o){const u=`${n}${c}`,h=s&&r.has(u),p=d.has(c);if(h){const f=document.createElement("button");f.type="button",f.className="rank-text legal",(se.get(ft(t,k(n,c)))??0)>Date.now()&&f.classList.add("card-pulse"),ht(f,c,pt(k(n,c)),p),f.onclick=()=>fn({seat:t,suit:n,rank:c}),l.appendChild(f)}else{const f=document.createElement("span");f.className="rank-text muted",(se.get(ft(t,k(n,c)))??0)>Date.now()&&f.classList.add("card-pulse"),ht(f,c,pt(k(n,c)),p),l.appendChild(f)}}return a.appendChild(l),a}function Me(e,t){const n=document.createElement("section"),r=e.turn===t;n.className=`hand seat-${t}`;const s=document.createElement("div");s.className="hand-head",s.innerHTML=`<strong class="seat-name${r?" active-seat-name":""}">${Xt[t]}</strong>`,n.appendChild(s);const a=!W&&r?N(e):[],i=new Set(a.map(d=>`${d.suit}${d.rank}`)),l=!W&&e.phase!=="end"&&e.userControls.includes(t)&&r;if(W&&oe&&g.userControls.includes(g.turn)&&t===g.turn){const d=N(g);for(const c of d)i.add(`${c.suit}${c.rank}`)}const o=l||W&&oe&&t===g.turn;for(const d of Ae)n.appendChild(Pr(e,t,d,i,o));return n}function Or(e){const t=document.createElement("section");t.className=`trick-table${W?" frozen":""}`,W&&(t.title="Click to dismiss trick",t.onclick=()=>{He(!0),D()});const n=W&&be?be:e.trick,r=new Map(n.map(s=>[s.seat,s]));for(const s of de){const a=document.createElement("div");a.className=`trick-slot slot-${s}`;const i=r.get(s);if(i){const l=document.createElement("span");l.className="played-text";const o=document.createElement("span");o.className=`played-suit suit-${i.suit}`,o.textContent=St[i.suit];const d=document.createElement("span");d.className="played-rank",ht(d,i.rank,pt(k(i.suit,i.rank))),l.append(o,d),a.appendChild(l)}t.appendChild(a)}return t}function jr(e){const t=document.createElement("section");t.className="status-panel";const n=document.createElement("strong");n.textContent="Status",t.appendChild(n);const r=document.createElement("div");r.className="status-facts",r.innerHTML=`
    <div><span class="k">Contract</span><span class="v">${e.contract.strain}</span></div>
    <div><span class="k">Goal</span><span class="v">${Lr(e)}</span></div>
    <div class="tricks"><span class="k">Tricks</span><span class="v heavy">NS ${e.tricksWon.NS} - EW ${e.tricksWon.EW}</span></div>
    <div class="meta-row"><span class="k">Leader</span><span class="v turn-meta">${e.leader}</span></div>
    <div class="meta-row"><span class="k">Turn</span><span class="v turn-meta turn-emph">${e.turn}</span></div>
    <div class="meta-row"><span class="k">Seed</span><span class="v seed">${T}</span></div>
  `;const s=document.createElement("div");s.className="meta-row";const a=document.createElement("span");a.className="k",a.textContent="Variations";const i=document.createElement("span");i.className="v turn-meta";const l=document.createElement("select");return["strict","sameLevel","allBusy"].forEach(o=>{const d=document.createElement("option");d.value=o,d.textContent=Lt[o],o===ue&&(d.selected=!0),l.appendChild(d)}),l.onchange=()=>{const o=l.value;o!==ue&&(ue=o,yt(T,`Variation mode changed: ${Lt[o]}`))},i.appendChild(l),s.append(a,i),r.appendChild(s),t.appendChild(r),t}function Kr(){const e=document.createElement("section");e.className="controls-banner";const t=document.createElement("div");t.className="controls";const n=document.createElement("label");n.textContent="Puzzle: ";const r=document.createElement("select");for(const y of ve){const $=document.createElement("option");$.value=y.id,$.textContent=y.label,$.selected=y.id===ne,r.appendChild($)}r.onchange=()=>{Dr(r.value)},n.appendChild(r),t.appendChild(n);const s=document.createElement("button");s.type="button",s.textContent="Reset",s.onclick=()=>yt(T,"reset"),t.appendChild(s);const a=document.createElement("button");a.type="button",a.textContent="Backup",a.disabled=Ke.length===0,a.onclick=()=>Tr(),t.appendChild(a);const i=document.createElement("button");i.type="button",i.textContent="New seed",i.onclick=()=>yt(Date.now()>>>0,"newSeed"),t.appendChild(i);const l=document.createElement("label"),o=document.createElement("input");o.type="checkbox",o.checked=ot,o.onchange=()=>{ot=o.checked,D()},l.append(o," Show boxes"),t.appendChild(l);const d=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.checked=Pe,c.onchange=()=>{Pe=c.checked,D()},d.append(c," Teaching mode"),t.appendChild(d);const u=document.createElement("label"),h=document.createElement("input");h.type="checkbox",h.checked=Ve,h.onchange=()=>{Ve=h.checked,un(),D()},u.append(h," Autoplay singletons"),t.appendChild(u);const p=document.createElement("label"),f=document.createElement("input");f.type="checkbox",f.checked=it,f.onchange=()=>{it=f.checked,D()},p.append(f," Show log"),t.appendChild(p);const C=document.createElement("label"),b=document.createElement("input");return b.type="checkbox",b.checked=U,b.onchange=()=>{U=b.checked,D()},C.append(b," Verbose log"),t.appendChild(C),e.appendChild(t),e}function Hr(){const e=document.createElement("aside");e.className="teaching-pane";const t=document.createElement("strong");t.textContent="Key teaching events",e.appendChild(t);const n=document.createElement("div");n.className="teaching-events";const r=Q.length>0?Q:[{id:0,kind:"info",label:"No teaching events yet."}];for(const s of r){const a=document.createElement("div");a.className=`teaching-event teaching-${s.kind}`;const i=document.createElement("span");i.className="teaching-at",i.textContent=s.at??"",a.appendChild(i);const l=document.createElement("span");if(l.className="teaching-text",l.textContent=s.label,a.appendChild(l),s.detail){const o=document.createElement("pre");o.className="teaching-detail",o.textContent=s.detail,a.appendChild(o)}n.appendChild(a)}return e.appendChild(n),e}function D(){const e=Wr();R.innerHTML="",R.appendChild(Kr());const t=document.createElement("section");t.className="main-row";const n=document.createElement("div");n.className="table-host";const r=document.createElement("main");if(r.className=`table-canvas${ot?" show-guides":""}`,r.appendChild(Or(e)),r.appendChild(Me(e,"N")),r.appendChild(Me(e,"W")),r.appendChild(Me(e,"E")),r.appendChild(Me(e,"S")),n.appendChild(r),t.appendChild(Hr()),t.appendChild(n),t.appendChild(jr(e)),R.appendChild(t),K==="success"||K==="failure"){const s=document.createElement("div");s.className=`banner ${K==="success"?"ok":"fail"}`,s.textContent=K==="success"?"Success - goal achieved":"Not enough tricks - try again",R.appendChild(s)}if(K==="success"&&w){const s=document.createElement("button");s.type="button",s.textContent="Play Again",s.onclick=()=>Rr("manual"),R.appendChild(s)}if(K==="success"&&!w){const s=document.createElement("div");s.className="banner",s.textContent="No 'Play Again' variations available: defenders had no same-tier alternatives to explore.",R.appendChild(s)}if(it){const s=document.createElement("section");s.className="log-panel";const a=document.createElement("strong");a.textContent="Log",s.appendChild(a);const i=document.createElement("div");i.className="log",i.textContent=m.length>0?m.join(`
`):"No events yet",s.appendChild(i),R.appendChild(s),i.scrollTop=i.scrollHeight}un()}rt(ne,!1);D();
