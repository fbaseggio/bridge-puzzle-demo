(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const Fe=["S","H","D","C"],mt=["E","W"],Kt={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function R(e){const t=e.slice(0,1),n=e.slice(1);if(!Fe.includes(t)||!(n in Kt))throw new Error(`Invalid CardId: ${e}`);return{suit:t,rank:n}}function k(e,t){return`${e}${t}`}function q(e){return Kt[e]}function Ot(e,t){const{suit:n,rank:r}=R(t),s=[],a=["N","E","S","W"];for(const i of a)e.hands[i][n].includes(r)&&s.push(i);return s}function hn(e){return e==="N"?"S":e==="S"?"N":e==="E"?"W":"E"}function yn(e){return e==="N"||e==="S"?["E","W"]:["N","S"]}function jt(e,t,n,r){const s=e.hands[t][n],a=q(r),i=s.filter(h=>q(h)>=a).length,l=s.filter(h=>q(h)<a).length,o=yn(t);let d=0;for(const h of o)for(const f of e.hands[h][n])d=Math.max(d,q(f));const c=hn(t),u=e.hands[c][n].filter(h=>q(h)>d).length;return i+Math.min(l,u)}function mn(e,t){const n={};for(const r of t){const{suit:s,rank:a}=R(r);if(n[s])throw new Error(`Duplicate threat suit: ${s}`);const i=Ot(e,r);if(i.length!==1)throw new Error(`Threat card ${r} must exist in exactly one hand (found ${i.length})`);const l=i[0];n[s]={suit:s,threatCardId:r,threatRank:a,establishedOwner:l,active:!0,threatLength:jt(e,l,s,a)}}return{threatsBySuit:n,threatCardIds:[...t]}}function Cn(e,t){const n={E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}};for(const r of mt)for(const s of Fe){for(const c of t.hands[r][s])n[r].idle.add(k(s,c));const a=e.threatsBySuit[s];if(!a||!a.active||a.threatLength<=0)continue;const i=t.hands[r][s],l=i.some(c=>q(c)>q(a.threatRank)),o=i.length>=a.threatLength;if(!l||!o)continue;const d=[...i].sort((c,u)=>q(u)-q(c)).slice(0,a.threatLength);for(const c of d){const u=k(s,c);n[r].idle.delete(u),n[r].busy.add(u)}}return n}function gn(e){return{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}}function At(e,t,n){return[...e[t].busy].some(r=>R(r).suit===n)}function Ct(e,t,n){const r=e.threatsBySuit[n];if(!r||!r.active)return;const s=At(t,"E",n),a=At(t,"W",n);return s&&a?"double":s||a?"single":"none"}function qt(e,t,n){const r=e.threatsBySuit[n];return!r||!r.active?!1:(r.stopStatus??Ct(e,t,n))==="none"}function kn(e,t,n){return qt(e,t,n)?e.threatsBySuit[n]?.threatRank??null:null}function bn(e,t,n,r){for(const s of mt){for(const c of[...n[s].busy])R(c).suit===r&&n[s].busy.delete(c);for(const c of[...n[s].idle])R(c).suit===r&&n[s].idle.delete(c);for(const c of t.hands[s][r])n[s].idle.add(k(r,c));const a=e.threatsBySuit[r];if(!a||!a.active||a.threatLength<=0)continue;const i=t.hands[s][r],l=i.some(c=>q(c)>q(a.threatRank)),o=i.length>=a.threatLength;if(!l||!o)continue;const d=[...i].sort((c,u)=>q(u)-q(c)).slice(0,a.threatLength);for(const c of d){const u=k(r,c);n[s].idle.delete(u),n[s].busy.add(u)}}}function Mt(e,t,n,r,s){for(const l of Object.keys(e))R(l).suit===s&&delete e[l];const a=["N","E","S","W"];for(const l of a)for(const o of r.hands[l][s]){const d=k(s,o);e[d]="default"}for(const l of mt){for(const o of n[l].idle)R(o).suit===s&&(e[o]="idle");for(const o of n[l].busy)R(o).suit===s&&(e[o]="busy")}const i=t.threatsBySuit[s];i?.active&&(e[i.threatCardId]="threat",qt(t,n,s)&&(e[i.threatCardId]="promotedWinner"))}function It(e,t){const n=mn(e,t),r=Cn(n,e);for(const a of Fe){const i=n.threatsBySuit[a];i&&(n.threatsBySuit[a]={...i,stopStatus:Ct(n,r,a)})}const s={};for(const a of Fe)Mt(s,n,r,e,a);return{threat:n,labels:r,perCardRole:s}}function Ut(e,t,n){const r={threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}},s=gn(e.labels),a={...e.perCardRole};delete a[n];const i=R(n).suit,l=new Set;r.threatsBySuit[i]&&l.add(i);for(const o of l){const d=r.threatsBySuit[o];if(!d)continue;const c=Ot(t,d.threatCardId),u=c.length===1&&c[0]===d.establishedOwner;r.threatsBySuit[o]={...d,active:u,threatLength:u?jt(t,d.establishedOwner,o,d.threatRank):0,stopStatus:void 0},bn(r,t,s,o);const h=r.threatsBySuit[o];h&&(r.threatsBySuit[o]={...h,stopStatus:Ct(r,s,o)}),Mt(a,r,s,t,o)}return{threat:r,labels:s,perCardRole:a}}const Sn=["S","H","D","C"],be={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function $n(e,t){if(t&&e[t].length>0)return e[t].map(r=>k(t,r));const n=[];for(const r of Sn)for(const s of e[r])n.push(k(r,s));return n}function gt(e,t,n){return n[e].idle.has(t)}function Gt(e){return R(e).rank}function F(e){return R(e).suit}function kt(e,t){return!!t.threatsBySuit[e]?.active}function Yt(e,t){const n=t.threatsBySuit[e];return!n||!n.active?null:n.threatRank}function Ie(e,t,n){const r=Yt(e,t);if(!r)return null;const s=kn(t,n,e);return s&&be[s]>be[r]?s:r}function Ft(e,t,n,r){return gt(e,t,n)?!kt(F(t),r):!1}function Qt(e,t,n,r){if(!gt(e,t,n))return!1;const s=F(t),a=Ie(s,r,n);return a?be[Gt(t)]<be[a]:!1}function En(e,t,n,r){return gt(e,t,n)?!Ft(e,t,n,r)&&!Qt(e,t,n,r):!1}function xn(e,t,n){return n[e].busy.has(t)}function qe(e,t,n,r){if(!xn(e,t,n))return!1;const s=F(t);return kt(s,r)}function Vt(e,t,n){const r=n.threatsBySuit[e]?.stopStatus;if(r)return r;if(!kt(e,n))return;const s=[...t.E.busy].some(i=>F(i)===e),a=[...t.W.busy].some(i=>F(i)===e);return s&&a?"double":s||a?"single":"none"}function vt(e,t,n,r){return Vt(t,n,r)==="double"}function Nt(e,t,n,r){return Vt(t,n,r)!=="single"?!1:[...n[e].busy].some(s=>F(s)===t)}function wt(e,t){const n=F(e),r=Gt(e),s=Yt(n,t);return s?be[r]<be[s]:!1}function bt(e,t,n,r,s){const a=t.hands[e],i=$n(a,n),l=i.filter(p=>Ft(e,p,s,r)),o=i.filter(p=>Qt(e,p,s,r)),d=i.filter(p=>En(e,p,s,r)),c=i.filter(p=>{if(!qe(e,p,s,r))return!1;const C=F(p);return vt(e,C,s,r)&&wt(p,r)}),u=i.filter(p=>{if(!qe(e,p,s,r))return!1;const C=F(p);return vt(e,C,s,r)}),h=i.filter(p=>{if(!qe(e,p,s,r))return!1;const C=F(p);return Nt(e,C,s,r)&&wt(p,r)}),f=i.filter(p=>{if(!qe(e,p,s,r))return!1;const C=F(p);return Nt(e,C,s,r)});return{legal:i,tier1a:l,tier1b:o,tier1c:d,tier2a:c,tier2b:u,tier3a:h,tier3b:f,tier4:i}}const zt=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],An=["N","E","S","W"];function te(e){return zt.indexOf(e)}function Jt(e,t){return`${e}${t}`}function In(e,t){const n=te(e),r=te(t);return n<0||r<0||r-n<=1?[]:zt.slice(n+1,r)}function vn(e,t,n,r,s){const a=In(r,s);if(a.length===0)return!0;const i=An.filter(l=>l!==t);return a.every(l=>i.every(o=>!e.hands[o][n].includes(l)))}function Nn(e,t){return Math.abs(te(e)-te(t))===1}function ze(e,t,n){const r=[...e.hands[t][n]].sort((a,i)=>te(a)-te(i));if(r.length===0)return[];const s=[[r[0]]];for(let a=1;a<r.length;a+=1){const i=r[a-1],l=r[a];Nn(i,l)||vn(e,t,n,i,l)?s[s.length-1].push(l):s.push([l])}return s}function wn(e,t,n){const r=[...n].sort((i,l)=>te(i)-te(l)),s=r[0],a=r[r.length-1];return`${e}:${t}:${s}-${a}`}function Bn(e,t){const n=[...t].sort((s,a)=>te(s)-te(a)),r=n[n.length-1];return Jt(e,r)}function M(e,t,n){const r=n[0],s=n.slice(1),i=ze(e,t,r).find(l=>l.includes(s))??[s];return{classId:wn(t,r,i),representative:Bn(r,i),members:i.map(l=>Jt(r,l))}}const Ce=["N","E","S","W"],St=["S","H","D","C"],ye={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function ae(e){return{S:[...e.S],H:[...e.H],D:[...e.D],C:[...e.C]}}function Ln(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},hands:{N:ae(e.hands.N),E:ae(e.hands.E),S:ae(e.hands.S),W:ae(e.hands.W)},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:{enabled:e.replay.enabled,transcript:e.replay.transcript?{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}:null,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId}}}function Dn(e){const t=Ce.indexOf(e);return Ce[(t+1)%Ce.length]}function Tn(e){return e==="N"||e==="S"?"NS":"EW"}function Qe(e){return Ce.every(t=>St.every(n=>e[t][n].length===0))}function Wn(e,t){const{suit:n,rank:r}=R(t);let s=0;for(const a of Ce)e[a][n].includes(r)&&(s+=1);return s}function Bt(e){const t=e.threatCardIds;if(!t||t.length===0)throw new Error("ThreatProblem requires explicit threatCardIds.");const n=[];for(const r of t)try{const{suit:s,rank:a}=R(r),i=k(s,a);Wn(e.hands,i)!==1&&n.push(r)}catch{n.push(r)}if(n.length>0)throw new Error(`Invalid threatCardIds: ${n.join(", ")}`);return[...t]}function Rn(e,t){return e.type==="minTricks"?t[e.side]>=e.n:!1}function Pn(e){let n=e.seed+Math.imul(e.counter,2654435769)>>>0;return n^=n>>>16,n=Math.imul(n,2146121005)>>>0,n^=n>>>15,n=Math.imul(n,2221713035)>>>0,n^=n>>>16,e.counter+=1,n/4294967296}function at(e,t){return Math.floor(Pn(t)*e)}function Hn(e,t){const n=e[0].suit,r=t?e.filter(i=>i.suit===t):[],s=r.length>0?r:e.filter(i=>i.suit===n);let a=s[0];for(const i of s)ye[i.rank]>ye[a.rank]&&(a=i);return a.seat}function Kn(e,t,n){const r=e[t].indexOf(n);return r<0?!1:(e[t].splice(r,1),!0)}function De(e){return e.userControls.includes(e.turn)}function Le(e){const t=B(e);if(t.length===0)return null;const n=at(t.length,e.rng);return!Number.isFinite(n)||n<0||n>=t.length?t[0]:t[n]??t[0]}function On(e){const t=e.turn,n=e.trick[0]?.suit??"-",r=e.contract.strain,s=B(e).map(i=>M(e,i.seat,k(i.suit,i.rank)).classId).sort().join(","),a=e.trickClassIds.join(",");return`seat=${t}|lead=${n}|trump=${r}|legal=${s}|trick=${a}`}function jn(e){const t={};for(const n of Ce){const r=e.preferredDiscards?.[n];r&&(t[n]=Array.isArray(r)?[...r]:[r])}return t}function qn(e){const t=e.turn,n=e.preferredDiscards[t];if(!n||n.length===0)return null;const r=e.trick[0]?.suit??null;if(!r)return{preferred:n,applied:!1,reason:"not-discard"};if(e.hands[t][r].length>0)return{preferred:n,applied:!1,reason:"can-follow-suit"};if(e.preferredDiscardUsed[t])return{preferred:n,applied:!1,reason:"already-used"};const s=B(e).map(i=>k(i.suit,i.rank)),a=new Set;for(const i of St)for(const l of e.hands[t][i])a.add(k(i,l));for(const i of n)if(a.has(i))return s.includes(i)?{preferred:n,applied:!0,chosen:i,reason:"applied"}:{preferred:n,applied:!1,chosen:i,reason:"not-legal"};return{preferred:n,applied:!1,reason:"not-in-hand"}}function z(e,t,n,r){if(!r||r.length===0)return;const s={};for(const a of r){const i=M(e,t,a).classId;!n||!n.startsWith("tier")?s[a]=i:n.startsWith("tier1")?s[a]="idle:tier1":n.startsWith("tier2")||n.startsWith("tier3")?s[a]=`busy:${a[0]}`:s[a]=`other:${a[0]}`}return s}function Mn(e,t){const n=e.turn==="E"||e.turn==="W",r=n?On(e):void 0;let s;if(n&&e.replay.enabled&&e.replay.transcript){const y=e.replay.transcript.decisions[e.replay.cursor];if(!y)e.replay.enabled=!1;else if(y.sig!==r)e.replay.enabled=!1,s={action:"disabled",index:y.index,reason:"sig-mismatch",card:y.chosenCard};else{const b=B(e),E=e.replay.divergenceIndex!==null&&e.replay.cursor===e.replay.divergenceIndex,A=b.map($=>k($.suit,$.rank)),v=z(e,e.turn,y.chosenBucket,A);let H,x=y.chosenCard,I=!1;if(E&&e.replay.forcedClassId){const $=b.find(L=>v[k(L.suit,L.rank)]===e.replay.forcedClassId);$?(H=$,x=k($.suit,$.rank)):(e.replay.enabled=!1,s={action:"disabled",index:y.index,reason:"class-not-legal",card:y.chosenCard,forcedClassId:e.replay.forcedClassId},I=!0)}if(!H&&!I&&(x=E&&e.replay.forcedCard?e.replay.forcedCard:y.chosenCard,H=b.find($=>k($.suit,$.rank)===x)),!H&&!I){const $=b.find(L=>M(e,L.seat,k(L.suit,L.rank)).classId===y.chosenClassId);if(!$)e.replay.enabled=!1,s={action:"disabled",index:y.index,reason:"card-not-legal",card:x};else{e.replay.cursor+=1;const L=y.chosenBucket,N=[...y.bucketCards],re=z(e,e.turn,L,N);return E&&(e.replay.enabled=!1),{play:$,decisionSig:r,chosenBucket:L,bucketCards:N,policyClassByCard:re,replay:{action:"forced",index:y.index,card:k($.suit,$.rank)}}}}else{e.replay.cursor+=1;const $=y.chosenBucket,L=[...y.bucketCards],N=z(e,e.turn,$,L);return E&&(e.replay.enabled=!1),{play:H,decisionSig:r,chosenBucket:$,bucketCards:L,policyClassByCard:N,replay:{action:"forced",index:y.index,card:x}}}}}const a=qn(e);if(a?.applied&&a.chosen){e.preferredDiscardUsed[e.turn]=!0;const{suit:y,rank:b}=R(a.chosen),E=[a.chosen],A="preferred",v=z(e,e.turn,A,E);return{play:{seat:e.turn,suit:y,rank:b},preferredDiscard:a,chosenBucket:A,bucketCards:E,policyClassByCard:v,decisionSig:r,replay:s}}if(t.kind==="randomLegal"){const y=B(e),b="legal",E=y.map(v=>k(v.suit,v.rank)),A=n?z(e,e.turn,b,E):void 0;return{play:Le(e),preferredDiscard:a??void 0,chosenBucket:b,bucketCards:E,policyClassByCard:A,decisionSig:r,replay:s}}if(t.kind!=="threatAware")return{play:null,preferredDiscard:a??void 0,decisionSig:r,replay:s};if(e.turn!=="E"&&e.turn!=="W")return{play:Le(e),preferredDiscard:a??void 0,decisionSig:r,replay:s};const i=e.trick[0]?.suit??null;if(!i){const y=B(e),b="lead:none",E=y.map(v=>k(v.suit,v.rank)),A=z(e,e.turn,b,E);return{play:Le(e),preferredDiscard:a??void 0,chosenBucket:b,bucketCards:E,policyClassByCard:A,decisionSig:r,replay:s}}if(e.hands[e.turn][i].length>0){const y=B(e);if(!e.threat||!e.threatLabels){const N="follow:baseline",re=y.map(Be=>k(Be.suit,Be.rank)),he=z(e,e.turn,N,re);return{play:Le(e),preferredDiscard:a??void 0,chosenBucket:N,bucketCards:re,policyClassByCard:he,decisionSig:r,replay:s}}const b=Ie(i,e.threat,e.threatLabels);if(!b){const N="follow:baseline",re=y.map(Be=>k(Be.suit,Be.rank)),he=z(e,e.turn,N,re);return{play:Le(e),preferredDiscard:a??void 0,chosenBucket:N,bucketCards:re,policyClassByCard:he,decisionSig:r,replay:s}}const E=y.filter(N=>ye[N.rank]<ye[b]),A=y.filter(N=>ye[N.rank]>=ye[b]),v=E.length>0?E:A,H=at(v.length,e.rng),x=v[H]??v[0]??y[0]??null,I=E.length>0?"follow:below":"follow:above",$=v.map(N=>k(N.suit,N.rank)),L=z(e,e.turn,I,$);return{play:x,preferredDiscard:a??void 0,chosenBucket:I,bucketCards:$,policyClassByCard:L,decisionSig:r,replay:s}}if(!e.threat)return{play:null,preferredDiscard:a??void 0,decisionSig:r,replay:s};const l=e.threatLabels??{E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}},o=bt(e.turn,{hands:e.hands},i,e.threat,l),c=[{name:"tier1a",cards:o.tier1a},{name:"tier1b",cards:o.tier1b},{name:"tier1c",cards:o.tier1c},{name:"tier2a",cards:o.tier2a},{name:"tier2b",cards:o.tier2b},{name:"tier3a",cards:o.tier3a},{name:"tier3b",cards:o.tier3b},{name:"tier4",cards:o.tier4}].find(y=>y.cards.length>0)??{name:"tier4",cards:o.tier4},u=at(c.cards.length,e.rng),h=c.cards[u]??c.cards[0],{suit:f,rank:p}=R(h),C=z(e,e.turn,c.name,c.cards)??{};for(const y of[...o.tier2a,...o.tier2b,...o.tier3a,...o.tier3b])C[y]=`busy:${y[0]}`;const S={};return o.tier2a.length>0&&(S.tier2a=[...o.tier2a]),o.tier2b.length>0&&(S.tier2b=[...o.tier2b]),o.tier3a.length>0&&(S.tier3a=[...o.tier3a]),o.tier3b.length>0&&(S.tier3b=[...o.tier3b]),{play:{seat:e.turn,suit:f,rank:p},preferredDiscard:a??void 0,chosenBucket:c.name,bucketCards:[...c.cards],policyClassByCard:C,tierBuckets:S,decisionSig:r,replay:s}}function Lt(e,t,n,r,s,a,i,l,o,d){const c=[],u=k(t.suit,t.rank),h=M(e,t.seat,u).classId;if(!Kn(e.hands[t.seat],t.suit,t.rank))return c.push({type:"illegal",reason:`Card ${t.suit}${t.rank} not in ${t.seat} hand`}),c;if(e.trick.push({...t}),e.trickClassIds.push(`${t.seat}:${h}`),n==="autoplay"?c.push({type:n,play:{...t},preferredDiscard:r,chosenBucket:s,bucketCards:a,policyClassByCard:i,tierBuckets:l,decisionSig:o,replay:d}):c.push({type:n,play:{...t}}),e.threat&&e.threatLabels){const y=Ut({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},k(t.suit,t.rank));e.threat=y.threat,e.threatLabels=y.labels,e.cardRoles={...y.perCardRole}}if(e.trick.length<4)return e.turn=Dn(e.turn),c;const p=e.trick.map(y=>({...y})),C=Hn(p,e.trumpSuit),S=Tn(C);return e.tricksWon[S]+=1,e.trick=[],e.trickClassIds=[],e.leader=C,e.turn=C,c.push({type:"trickComplete",winner:C,trick:p}),Qe(e.hands)&&(e.phase="end",c.push({type:"handComplete",success:Rn(e.goal,e.tricksWon),tricksWon:{...e.tricksWon}})),c}function Je(e){const t=e.contract.strain==="NT"?null:e.contract.strain,n=Object.values(e.policies).some(l=>l?.kind==="threatAware");let r=null,s=null,a={};if(n){const l=Bt(e),o=It({hands:e.hands},l);r=o.threat,s=o.labels,a={...o.perCardRole}}else if(e.threatCardIds&&e.threatCardIds.length>0){const l=Bt(e),o=It({hands:e.hands},l);r=o.threat,s=o.labels,a={...o.perCardRole}}const i={id:e.id,contract:{...e.contract},trumpSuit:t,threat:r,threatLabels:s,cardRoles:a,hands:{N:ae(e.hands.N),E:ae(e.hands.E),S:ae(e.hands.S),W:ae(e.hands.W)},leader:e.leader,turn:e.leader,trick:[],trickClassIds:[],tricksWon:{NS:0,EW:0},phase:"awaitUser",rng:{seed:e.rngSeed>>>0,counter:0},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:jn(e),preferredDiscardUsed:{},replay:{enabled:!1,transcript:null,cursor:0,divergenceIndex:null,forcedCard:null,forcedClassId:null}};return Qe(i.hands)?i.phase="end":i.phase=De(i)?"awaitUser":"auto",i}function B(e){if(e.phase==="end")return[];const t=e.hands[e.turn],n=e.trick[0]?.suit,r=n?t[n]??[]:[],s=n&&r.length>0?[n]:St,a=[];for(const i of s){const l=t[i]??[];for(const o of l)a.push({seat:e.turn,suit:i,rank:o})}return a}function Un(e,t){const n=Ln(e),r=[];if(n.phase==="end")return r.push({type:"illegal",reason:"Hand already complete"}),{state:n,events:r};if(t.seat!==n.turn)return r.push({type:"illegal",reason:`Expected turn ${n.turn}, got ${t.seat}`}),n.phase=De(n)?"awaitUser":"auto",{state:n,events:r};if(!B(n).some(i=>i.seat===t.seat&&i.suit===t.suit&&i.rank===t.rank))return r.push({type:"illegal",reason:`Illegal play ${t.seat}:${t.suit}${t.rank}`}),n.phase=De(n)?"awaitUser":"auto",{state:n,events:r};for(r.push(...Lt(n,t,"played"));!De(n)&&!Qe(n.hands);){n.phase="auto";const i=n.policies[n.turn];if(!i){r.push({type:"illegal",reason:`No policy configured for auto seat ${n.turn}`});break}const l=Mn(n,i);if(!l.play){const o=B(n);r.push({type:"illegal",reason:`Autoplay failed for ${n.turn} (policy=${i?.kind??"none"}, legal=${o.length}${l.replay?.reason?`, replay=${l.replay.reason}`:""})`});break}r.push(...Lt(n,l.play,"autoplay",l.preferredDiscard,l.chosenBucket,l.bucketCards,l.policyClassByCard,l.tierBuckets,l.decisionSig,l.replay))}return Qe(n.hands)?(n.phase="end",{state:n,events:r}):(n.phase=De(n)?"awaitUser":"auto",{state:n,events:r})}function Gn(e,t){return t.E.busy.has(e)||t.W.busy.has(e)}function Yn(e,t){if(!t.threatCardIds.includes(e))return!1;const{suit:n}=e.length>=2?{suit:e[0]}:{suit:"S"},r=t.threatsBySuit[n];return!!(r?.active&&r.threatCardId===e)}function Fn(e,t,n){const{suit:r}=e.length>=2?{suit:e[0]}:{suit:"S"},s=t.threatsBySuit[r];if(!s||!s.active||s.threatCardId!==e)return!1;const a=[...n.E.busy].some(l=>l.startsWith(r)),i=[...n.W.busy].some(l=>l.startsWith(r));return!a&&!i}function _t(e,t,n,r){return r?Fn(e,t,n)?"purple":Yn(e,t)?"green":Gn(e,n)?"blue":"black":"black"}function Qn(e,t){const n=e.triedByIdx.get(t.index)??new Set;n.add(t.chosenAltClassId||t.chosenClassId),e.triedByIdx.set(t.index,n);const r=e.recordedRemainingByIdx.get(t.index)??new Set;for(const a of t.sameBucketAlternativeClassIds)r.add(a);e.recordedRemainingByIdx.set(t.index,r);const s=e.representativeByIdx.get(t.index)??new Map;for(const[a,i]of Object.entries(t.representativeCardByClass))s.set(a,i);s.set(t.chosenAltClassId||t.chosenClassId,t.chosenCard),e.representativeByIdx.set(t.index,s)}function Vn(e,t,n){const r=[...e.recordedRemainingByIdx.keys()].sort((a,i)=>a-i),s=[];for(const a of r){if(t&&!t.has(a)||typeof n=="number"&&a>=n)continue;const i=e.recordedRemainingByIdx.get(a)??new Set,l=e.triedByIdx.get(a)??new Set,o=[...i].filter(d=>!l.has(d)).sort();o.length>0&&s.push({index:a,remainingKeys:o})}return s}const zn={id:"p001",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:[],H:[],D:["A","K","Q"],C:[]},S:{S:["5"],H:[],D:["2"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8"]},Jn=!0,_n={id:"p002",contract:{strain:"C"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:7},hands:{N:{S:["A","Q","9","5","4"],H:["A","K","2"],D:[],C:[]},W:{S:["J","T","8"],H:["Q","T","8"],D:["A","Q"],C:[]},E:{S:["K","7","6"],H:["J","9","7"],D:["K","J"],C:[]},S:{S:[],H:["4","3"],D:["6","5","4"],C:["T","9","8"]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},threatCardIds:["S9","H2","D5"],preferredDiscards:{W:"DA",E:"H7"},rngSeed:202},Xn={id:"p003",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:["Q","T"],H:[],D:["A"],C:[]},S:{S:["5"],H:[],D:["8"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8","D8"]},Zn={id:"p004",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:5},hands:{N:{S:["8"],H:["A","8"],D:["5"],C:["3","2"]},E:{S:[],H:["Q","T"],D:["Q","T","6"],C:["4"]},S:{S:[],H:["5"],D:["A","K","8"],C:["A","K"]},W:{S:["A"],H:["K","J"],D:["J","9","7"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:404,threatCardIds:["S8","H8","D8"]},er={id:"p005",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:4},hands:{N:{S:["A","8"],H:[],D:[],C:["A","2"]},E:{S:["K","J"],H:["A"],D:["A"],C:[]},S:{S:["5"],H:["8"],D:[],C:["K","3"]},W:{S:["9"],H:["5"],D:["K","Q"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:405,threatCardIds:["S8","H8"]},tr={id:"p006",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","5"],H:["8"],D:[],C:[]},E:{S:["7","6"],H:["7"],D:[],C:[]},S:{S:["8","2"],H:[],D:[],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:406,threatCardIds:["H8","S8"]},nr={id:"p007",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:5},hands:{N:{S:["A","8","4"],H:["A","2"],D:[],C:["2"]},E:{S:["6"],H:["Q","J","T","9"],D:[],C:["K"]},S:{S:["K","5"],H:["5","4"],D:["8"],C:["A"]},W:{S:["Q","T","7"],H:["7","6"],D:["A"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:407,threatCardIds:["S8","D8"]},rr={id:"p008",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:5},hands:{N:{S:["8"],H:["8"],D:["5"],C:["A","2"]},E:{S:["K"],H:["7"],D:["J","9","7"],C:[]},S:{S:[],H:[],D:["A","K","8"],C:["K","3"]},W:{S:["7"],H:["K"],D:["Q","T","6"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:408,threatCardIds:["S8","H8","D8"]},sr={id:"p009",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:4},hands:{N:{S:["A"],H:["8","5"],D:[],C:["A"]},E:{S:["7"],H:["7"],D:["A","K"],C:[]},S:{S:["8","5"],H:["A"],D:[],C:["2"]},W:{S:["K","J"],H:["K","J"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:409,threatCardIds:["H8","S8"]},ve=[{id:"p001",label:"p001",problem:zn},{id:"p002",label:"p002",problem:_n,experimental:Jn},{id:"p003",label:"p003",problem:Xn},{id:"p004",label:"p004",problem:Zn},{id:"p005",label:"p005",problem:er},{id:"p006",label:"p006",problem:tr},{id:"p007",label:"p007",problem:nr},{id:"p008",label:"p008",problem:rr},{id:"p009",label:"p009",problem:sr}],Xt=document.querySelector("#app");if(!Xt)throw new Error("Missing #app");const P=Xt,de=["N","E","S","W"],Ne=["S","H","D","C"],Q=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],$t={S:"♠",H:"♥",D:"♦",C:"♣"},Zt={N:"North",E:"East",S:"South",W:"West"},Dt={strict:"Strict",sameLevel:"Same level",allBusy:"All busy"},Tt=Math.max(...ve.flatMap(({problem:e})=>de.flatMap(t=>Ne.map(n=>e.hands[t][n].length)))),ar=12,ir=4,or=9,lr=4,cr=4,dr=6,Et=17,ur=16,fr=3,pr=16,hr=Math.round(Et*.6),yr=Math.round(Et*.6),mr=ar+ir+Tt*or+Math.max(0,Tt-1)*lr+cr,en=ur+fr+Et*4+pr+dr,tn=en+6;P.style.setProperty("--hand-box-w",`${mr}px`);P.style.setProperty("--hand-box-h",`${en}px`);P.style.setProperty("--trick-box-w",`${tn}px`);P.style.setProperty("--trick-box-h",`${tn}px`);P.style.setProperty("--table-gap-y",`${hr}px`);P.style.setProperty("--table-gap-x",`${yr}px`);P.style.setProperty("--slot-offset","12%");let ue="sameLevel",Z=ve[0].problem,ne=ve[0].id,W=Z.rngSeed>>>0,g=Je({...Z,rngSeed:W}),m=[],ee=[],G=!1,it=!0,ot=!0,Pe=!0,Ve=!1,Te=null,lt=null,D=!1,Se=null,pe=null,oe=!1,$e=null,Ee=null;const Oe=[];let _=[],K=null;const Y={triedByIdx:new Map,recordedRemainingByIdx:new Map,representativeByIdx:new Map};let ce=[],xe=[],j="running",w=!1,O=null,X=null,ge=0,ie=null,we=!1,V=[],_e=1,se=new Map,Ue=null;const Cr=360,ct=new Map,Ge=new Map;let He=0,Xe=0,dt=!1;const Wt=new Map,Ke=new Map;let ut=!1;nt(g);function U(){Te&&(clearTimeout(Te),Te=null),lt=null}function ft(e,t){return`${e}:${t}`}function gr(){return typeof window<"u"&&!!window.matchMedia?.("(prefers-reduced-motion: reduce)").matches}function Ze(){Ue&&(clearTimeout(Ue),Ue=null)}function nn(){Ze();const e=Date.now();let t=1/0;for(const r of se.values())r>e&&r<t&&(t=r);if(!Number.isFinite(t))return;const n=Math.max(16,t-e+8);Ue=setTimeout(()=>{const r=Date.now();for(const[s,a]of se.entries())a<=r&&se.delete(s);T(),nn()},n)}function kr(e,t){gr()||(se.set(ft(e,t),Date.now()+Cr),nn())}function We(e){V.push({...e,id:_e++}),V.length>120&&(V=V.slice(-120))}function et(){V=[],_e=1}function rn(){Xe+=1}function br(e){const t=`${Xe}|${e}`,n=(Wt.get(t)??0)+1;return Wt.set(t,n),n}function J(e){return`run=${Xe} ${e}`}function me(e,t){return`run=${Xe} visit=${br(e)} ${t}`}function Sr(e){const t=new Map(Q.map((n,r)=>[n,r]));return[...e].sort((n,r)=>(t.get(n)??99)-(t.get(r)??99))}function ke(e){return`${e.seat}:${e.suit}${tt(e.rank)}`}function sn(e){return{hands:e.hands}}function $r(e){return Array.isArray(e.threatCardIds)?[...e.threatCardIds]:[]}function tt(e){return e==="T"?"10":e}function pt(e){if(!$e||!Ee)return"rank--black";const t=_t(e,$e,Ee,Pe);return t==="purple"?"rank--purple":t==="green"?"rank--green":t==="blue"?"rank--blue":"rank--black"}function ht(e,t,n,r=!1){const s=document.createElement("span");if(s.className=`rank ${n}${r?" eq-underline":""}`,t!=="T"){s.textContent=tt(t),e.appendChild(s);return}const a=document.createElement("span");a.className=`rank ten ${n}${r?" eq-underline":""}`;const i=document.createElement("span");i.className="digit-one",i.textContent="1";const l=document.createElement("span");l.className="digit-zero",l.textContent="0",a.append(i,l),e.appendChild(a)}function Er(e){return e.type==="played"?`played ${ke(e.play)}`:e.type==="autoplay"?`autoplay ${ke(e.play)}`:e.type==="illegal"?`illegal ${e.reason}`:e.type==="trickComplete"?`trickComplete winner=${e.winner} trick=${e.trick.map(ke).join(" ")}`:`handComplete success=${e.success} NS=${e.tricksWon.NS} EW=${e.tricksWon.EW}`}function xr(e){return e==="N"||e==="S"?"NS":"EW"}function Ar(e){const t=de.indexOf(e);return de[(t+1)%de.length]}function le(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,hands:{N:{S:[...e.hands.N.S],H:[...e.hands.N.H],D:[...e.hands.N.D],C:[...e.hands.N.C]},E:{S:[...e.hands.E.S],H:[...e.hands.E.H],D:[...e.hands.E.D],C:[...e.hands.E.C]},S:{S:[...e.hands.S.S],H:[...e.hands.S.H],D:[...e.hands.S.D],C:[...e.hands.S.C]},W:{S:[...e.hands.W.S],H:[...e.hands.W.H],D:[...e.hands.W.D],C:[...e.hands.W.C]}},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:e.replay.transcript?{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}}:{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:null}}}function an(e){return e?{threatCardIds:[...e.threatCardIds],threatsBySuit:{...e.threatsBySuit}}:null}function on(e){return e?{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}:null}function ln(e){return e?e.map(t=>({...t})):null}function Ir(e){return{state:le(g),currentProblemId:ne,currentSeed:W,logs:[...m],deferredLogLines:[...ee],trickFrozen:D,lastCompletedTrick:ln(Se),frozenViewState:pe?le(pe):null,canLeadDismiss:oe,threatCtx:an($e),threatLabels:on(Ee),play:{...e},runStatus:j,playAgainAvailable:w,playAgainUnavailableReason:O,playAgainLastCandidateIndex:X,replaySuppressedForRun:we,teachingEvents:V.map(t=>({...t})),nextTeachingEventId:_e}}function vr(e){g=le(e.state),ne=e.currentProblemId,Z=ve.find(t=>t.id===ne)?.problem??Z,W=e.currentSeed,m=[...e.logs],ee=[...e.deferredLogLines],D=e.trickFrozen,Se=ln(e.lastCompletedTrick),pe=e.frozenViewState?le(e.frozenViewState):null,oe=e.canLeadDismiss,$e=an(e.threatCtx),Ee=on(e.threatLabels),j=e.runStatus,w=e.playAgainAvailable,O=e.playAgainUnavailableReason,X=e.playAgainLastCandidateIndex,we=e.replaySuppressedForRun,V=e.teachingEvents.map(t=>({...t})),_e=e.nextTeachingEventId}function xt(){Ke.clear(),ut=!1}function Nr(){if(!G||ut||Ke.size===0)return;const e=[...Ke.values()].sort((t,n)=>t.idx-n.idx||(t.seat<n.seat?-1:t.seat>n.seat?1:0));m=[...m,"","================= DEFENDER EQ (initial snapshot, first EQCs observed) =================",...e.map(t=>`idx=${t.idx} seat=${t.seat} bucket=${t.bucket} classes={${t.classes.join(",")}} remaining={${t.remaining.join(",")}} chosen=${t.chosen}`),"=========================================================================================",""].slice(-500),ut=!0}function wr(e,t){const n=[];for(const r of Ne)for(const s of ze(e,t,r))n.push(`${r}${s.join("")}`);return n}function nt(e){ct.clear(),Ge.clear();for(const t of e.userControls)for(const n of Ne){const r=ze(e,t,n);for(const s of r){if(s.length===0)continue;const a=k(n,s[0]),l=M(e,t,a).classId;Ge.has(l)||Ge.set(l,a);for(const o of s){const d=k(n,o);ct.set(d,l)}}}}function Ye(e,t){return e!=="N"&&e!=="S"?M(g,e,t).classId:ct.get(t)??M(g,e,t).classId}function Br(e,t){return Ge.get(e)??t}function Lr(e){const t=["","================= USER EQ (initial) ================="];for(const n of e.userControls){const r=wr(e,n);t.push(`seat=${n} classes: ${r.join("  ")||"-"}`)}return t.push("====================================================="),t.push(""),t}function cn(e,t,n){if(t.play.seat!=="E"&&t.play.seat!=="W"||!t.decisionSig)return null;const r=k(t.play.suit,t.play.rank),s=t.bucketCards?[...t.bucketCards]:[r],a=t.policyClassByCard??{},i=t.chosenBucket??"unknown",l=t.tierBuckets??{};let o=[...s];if((i.startsWith("tier2")||i.startsWith("tier3"))&&ue!=="strict"){const f=ue==="sameLevel"?[`tier${i.startsWith("tier2")?"2":"3"}a`,`tier${i.startsWith("tier2")?"2":"3"}b`]:["tier2a","tier2b","tier3a","tier3b"],p=[];for(const C of f)for(const S of l[C]??[])p.includes(S)||p.push(S);p.length>0&&(o=p)}const d=f=>{if(i.startsWith("tier1"))return"idle:tier1";if(i.startsWith("tier2")||i.startsWith("tier3"))return`busy:${f[0]}`;if(i==="tier4")return`other:${f[0]}`;const p=e.threatLabels;if(p){if(p[t.play.seat].busy.has(f))return`busy:${f[0]}`;if(p[t.play.seat].idle.has(f))return"idle:tier1"}const C=a[f];return C||M(e,t.play.seat,f).classId},c=[],u=d(r);for(const f of o){const p=d(f);c.includes(p)||c.push(p)}const h=c.filter(f=>f!==u);return{idx:n,seat:t.play.seat,bucket:i,classes:c,remaining:h,chosen:u,eqByTier:Wr(e,t)}}function fe(e){const t={S:0,H:1,D:2,C:3};return[...e].sort((n,r)=>{const s=Q.indexOf(n[1]),a=Q.indexOf(r[1]);return s!==a?s-a:t[n[0]]-t[r[0]]})}function Rt(e){const n=["tier1a","tier1b","tier1c","tier2a","tier2b","tier3a","tier3b","tier4","follow:below","follow:above","follow:baseline","lead:none","legal","preferred"].indexOf(e);return n>=0?n:999}function Dr(e){return e.startsWith("tier")?e.slice(4):e.startsWith("follow:")?e.slice(7):e==="lead:none"?"lead":e}function Tr(e,t){const n=new Map,r=B(e).filter(i=>i.seat===t.play.seat).map(i=>k(i.suit,i.rank)),s=e.trick[0]?.suit??null;if(!s){for(const i of r)n.set(i,"lead:none");return n}if(e.hands[e.turn][s].length===0&&e.threat&&e.threatLabels){const i=bt(e.turn,sn(e),s,e.threat,e.threatLabels),l=[["tier1a",i.tier1a],["tier1b",i.tier1b],["tier1c",i.tier1c],["tier2a",i.tier2a],["tier2b",i.tier2b],["tier3a",i.tier3a],["tier3b",i.tier3b],["tier4",i.tier4]];for(const[o,d]of l)for(const c of d)n.has(c)||n.set(c,o);return n}if(e.hands[e.turn][s].length>0){const i=B(e).filter(o=>o.seat===e.turn).map(o=>k(o.suit,o.rank));if(!e.threat||!e.threatLabels){for(const o of i)n.set(o,"follow:baseline");return n}const l=Ie(s,e.threat,e.threatLabels);if(!l){for(const o of i)n.set(o,"follow:baseline");return n}for(const o of i){const d=o[1];n.set(o,Q.indexOf(d)>Q.indexOf(l)?"follow:below":"follow:above")}return n}for(const i of r)n.set(i,t.chosenBucket??"unknown");return n}function Wr(e,t){const n=Tr(e,t),r=new Map;for(const[u,h]of n.entries()){let f=t.policyClassByCard?.[u];f||(h.startsWith("tier1")?f="idle:tier1":h.startsWith("tier2")||h.startsWith("tier3")?f=`busy:${u[0]}`:h==="tier4"?f=`other:${u[0]}`:f=M(e,t.play.seat,u).classId);const p=r.get(f)??new Map,C=p.get(h)??[];C.push(u),p.set(h,C),r.set(f,p)}const s=["busy:S","busy:H","busy:D","busy:C"],a=[...r.entries()],i=a.find(([u])=>u.startsWith("idle")),l=s.map(u=>a.find(([h])=>h===u)).filter(u=>!!u),o=a.filter(([u])=>!u.startsWith("idle")&&!s.includes(u)).sort((u,h)=>u[0].localeCompare(h[0])),d=(u,h)=>{const f=[...h.entries()].sort((p,C)=>Rt(p[0])-Rt(C[0])).map(([p,C])=>`${Dr(p)}:{${fe(C).join(" ")}}`).join(" ");return`${u}(${f})`},c=[];i?c.push(d(i[0],i[1])):c.push("idle:None");for(const[u,h]of[...l,...o])c.push(d(u,h));return c.join(", ")}function dn(e,t){const n=e[1];return Q.indexOf(n)>Q.indexOf(t)}function Rr(e){const t=e.threat,n=e.threatLabels,r=[],s=["E","W"],a=["C","D","H","S"],i=["S","H","D","C"],l=["tier2a","tier2b","tier3a","tier3b"];for(const o of s){const d=i.filter(f=>!!t?.threatsBySuit[f]),c=[];for(const f of a){if(d.includes(f))continue;const p=fe(e.hands[o][f].map(C=>k(f,C)));p.length>0&&c.push(`idle:${f}{${p.join(" ")}}`)}const u=c.length>0?c.join(" "):"idle:(None)",h=[];for(const f of d){const p=fe(e.hands[o][f].map(A=>k(f,A)));if(p.length===0){h.push(`busy:${f}(None)`);continue}const C=t&&n?Ie(f,t,n):null,y=t?.threatsBySuit[f]?.stopStatus==="double"?"2":"3",b=new Map;for(const A of p){const v=C&&dn(A,C)?`tier${y}a`:`tier${y}b`,H=b.get(v)??[];H.push(A),b.set(v,H)}const E=l.filter(A=>(b.get(A)?.length??0)>0).map(A=>`${A.slice(4)}:{${fe(b.get(A)??[]).join(" ")}}`);h.push(`busy:${f}(${E.join(" ")||"None"})`)}r.push(`seat=${o} | ${u} | ${h.join(" | ")||"busy:(None)"}`)}return["","================= DEFENDER INVENTORY EQ (initial) =================",...r,"===================================================================",""]}function Pr(e,t){const n=e.threat,r=e.threatLabels,s=["C","D","H","S"],a=["S","H","D","C"],i=["tier2a","tier2b","tier3a","tier3b"],l=a.filter(u=>!!n?.threatsBySuit[u]),o=[];for(const u of s){const h=fe([...r?.[t].idle??new Set].filter(f=>f[0]===u));h.length>0&&o.push(`idle:${u}{${h.join(" ")}}`)}const d=o.length>0?o.join(" "):"idle:(None)",c=[];for(const u of l){const h=fe([...r?.[t].busy??new Set].filter(b=>b[0]===u));if(h.length===0){c.push(`busy:${u}(None)`);continue}const f=n&&r?Ie(u,n,r):null,C=n?.threatsBySuit[u]?.stopStatus==="double"?"2":"3",S=new Map;for(const b of h){const E=f&&dn(b,f)?`tier${C}a`:`tier${C}b`,A=S.get(E)??[];A.push(b),S.set(E,A)}const y=i.filter(b=>(S.get(b)?.length??0)>0).map(b=>`${b.slice(4)}:{${fe(S.get(b)??[]).join(" ")}}`);c.push(`busy:${u}(${y.join(" ")||"None"})`)}return`${d} | ${c.join(" | ")||"busy:(None)"}`}function Pt(e,t,n){const r=new Map;for(const s of de)for(const a of Ne)for(const i of e.hands[s][a]){const l=k(a,i),o=t&&n?_t(l,t,n,Pe):"black",d=e.cardRoles[l]??"default";r.set(l,{color:o,role:d,seat:s})}return r}function Hr(e,t,n){const r=[],s=l=>`${l[0]}${tt(l.slice(1))}`;for(const[l,o]of t.entries()){const d=n.get(l);if(d&&!(o.color===d.color&&o.role===d.role)){if(o.color!==d.color&&kr(o.seat,l),d.role==="idle"&&o.role!=="idle"){r.push(`${s(l)} idle`);continue}if(d.role==="promotedWinner"&&o.role!=="promotedWinner"){r.push(`${s(l)} promoted`);continue}d.role==="busy"&&o.role!=="busy"&&r.push(`${s(l)} busy`)}}if(r.length===0)return;const a=r.slice(0,6),i=r.length-a.length;We({kind:"recolor",label:`${s(e)} -> ${a.join(", ")}${i>0?` (+${i} more)`:""}`})}function Kr(e,t){const n=le(e);for(const r of t){if(r.type==="played"||r.type==="autoplay"){const s=Pt(n,n.threat??null,n.threatLabels??null);Ae(n,r);const a=Pt(n,n.threat??null,n.threatLabels??null),i=k(r.play.suit,r.play.rank);Hr(i,s,a);continue}Ae(n,r)}}function Or(e){const t=e.threat,n=e.threatLabels;if(!t||!n){We({kind:"info",at:"Start",label:"No teaching events yet."});return}const r=["S","H","D","C"],s=[];for(const a of r){const i=t.threatsBySuit[a];if(!i)continue;const l=Zt[i.establishedOwner],o=`${$t[a]}${tt(i.threatRank)}`,d=[...n.E.busy].some(h=>h[0]===a),c=[...n.W.busy].some(h=>h[0]===a);let u="unstopped";d&&c?u="stopped by both":c?u="stopped by West only":d&&(u="stopped by East only"),s.push(`${l} has ${o}, ${u}.`)}if(s.length===0){We({kind:"info",at:"Start",label:"No teaching events yet."});return}We({kind:"threatSummary",at:"Start",label:"Threats:",detail:s.join(`
`)})}function Ae(e,t){if(t.type==="played"||t.type==="autoplay"){const n=k(t.play.suit,t.play.rank),r=M(e,t.play.seat,n).classId,s=e.hands[t.play.seat][t.play.suit],a=s.indexOf(t.play.rank);if(a>=0&&s.splice(a,1),e.trick.push({...t.play}),e.trickClassIds.push(`${t.play.seat}:${r}`),e.threat&&e.threatLabels){const i=Ut({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},k(t.play.suit,t.play.rank));e.threat=i.threat,e.threatLabels=i.labels,e.cardRoles={...i.perCardRole}}e.turn=Ar(e.turn);return}if(t.type==="trickComplete"){e.trick=[],e.trickClassIds=[],e.leader=t.winner,e.turn=t.winner,e.tricksWon[xr(t.winner)]+=1;return}t.type==="handComplete"&&(e.phase="end",e.tricksWon={...t.tricksWon})}function st(e,t,n,r){const s=[],a=le(e);for(const i of n){if(i.type==="played"||i.type==="autoplay"){ge>0&&s.push(""),ge+=1,s.push(`----- PLAY ${ge} -----`);const l=k(i.play.suit,i.play.rank);let o=`play ${i.play.seat}:${l} (${i.type==="played"?"user":"auto"})`;if(i.type==="played"){const d=Ye(i.play.seat,l);o+=` | eq=${d}`}else{const d=cn(a,i,-1);if(d)o+=` | eq=${d.chosen} (card=${l}; bucket=${d.bucket}; remaining=${d.remaining.join(",")||"-"})`;else{const c=M(a,i.play.seat,l).classId;o+=` | eq=${c}${i.chosenBucket?` (card=${l}; bucket=${i.chosenBucket})`:""}`}}s.push(o)}if(G&&i.type==="autoplay"){if(i.replay?.action==="forced"&&s.push(`[PLAYAGAIN] forcing index=${i.replay.index??"?"} card=${i.replay.card??`${i.play.suit}${i.play.rank}`}`),i.replay?.action==="disabled"&&(i.replay.reason==="class-not-legal"?s.push(`[PLAYAGAIN] force failed idx=${i.replay.index??"?"} forcedClass=${i.replay.forcedClassId??"-"} reason=class-not-legal; continuing unforced`):s.push(`[PLAYAGAIN] replay disabled due to ${i.replay.reason??"mismatch"}`)),i.preferredDiscard){const o=i.preferredDiscard;o.applied&&o.chosen?s.push(`[PREFDISC] seat=${i.play.seat} applied preferred discard=${o.chosen}`):s.push(`[PREFDISC] seat=${i.play.seat} preferred=${o.preferred.join("/")} not-applied reason=${o.reason}`)}if(a.policies[a.turn]?.kind==="threatAware"&&a.trick.length>0&&a.hands[a.turn][a.trick[0].suit].length>0){const o=a.trick[0].suit,d=B(a).map(u=>`${u.suit}${u.rank}`),c=a.threat&&a.threatLabels?Ie(o,a.threat,a.threatLabels):null;if(c){const u=B(a).filter(f=>Q.indexOf(f.rank)>Q.indexOf(c)),h=B(a).filter(f=>Q.indexOf(f.rank)<=Q.indexOf(c));s.push(`[THREAT] follow seat=${a.turn} ledSuit=${o} threshold=${c} inSuit=${d.length} chosen=${i.play.suit}${i.play.rank} below=${u.length} above=${h.length}`)}else s.push(`[THREAT] follow seat=${a.turn} ledSuit=${o} threshold=- inSuit=${d.length} chosen=${i.play.suit}${i.play.rank} mode=baseline`)}if((a.turn==="E"||a.turn==="W")&&a.trick.length>0&&a.hands[a.turn][a.trick[0].suit].length===0&&a.threat&&a.threatLabels){const o=a.trick[0].suit,d=a.threat,c=a.threatLabels,u=bt(a.turn,sn(a),o,d,c),h=[["t2a",u.tier2a.length],["t2b",u.tier2b.length],["t3a",u.tier3a.length],["t3b",u.tier3b.length]].filter(([,f])=>f>0).map(([f,p])=>`${f}:${p}`).join(" ");s.push(`[THREAT] discard seat=${a.turn} ledSuit=${o} legal=${u.legal.length} chosen=${i.play.suit}${i.play.rank} bucket=${i.chosenBucket??"-"} tiers=${h||"-"}`)}}if((i.type==="illegal"||i.type==="handComplete")&&s.push(Er(i)),Ae(a,i),G&&i.type==="illegal"){const l=a.trick[0]?.suit??"none",o=B(a).slice(0,10).map(ke).join(" ");s.push(`illegalContext attempted=${ke(t)} turn=${a.turn} leadSuit=${l} legal=${o||"-"}`)}i.type==="trickComplete"&&(s.push(`----- TRICK COMPLETE ----- winner=${i.winner} trick=${i.trick.map(ke).join(" ")}`),s.push(""))}return s}function jr(e,t){const n=le(e);for(const r of t){if(r.type==="autoplay"&&(r.play.seat==="E"||r.play.seat==="W")&&r.decisionSig){He+=1;const s=xe.join(" > ");G&&(m=[...m,me(s||"-",`[INV_EQ:atDecision] idx=${_.length} seat=${r.play.seat} nodeKey=${s||"-"} invEq=${Pr(n,r.play.seat)}`)].slice(-500));const a=cn(n,r,_.length);if(!a){Ae(n,r);continue}const i=k(r.play.suit,r.play.rank),l=M(n,r.play.seat,i).classId,o=a.chosen,d=[...a.classes],c=[...a.remaining],u=r.bucketCards?[...r.bucketCards]:[i],h=x=>{if(a.bucket.startsWith("tier1"))return"idle:tier1";if(a.bucket.startsWith("tier2")||a.bucket.startsWith("tier3"))return`busy:${x[0]}`;if(a.bucket==="tier4")return`other:${x[0]}`;const I=n.threatLabels;if(I){if(I[r.play.seat].busy.has(x))return`busy:${x[0]}`;if(I[r.play.seat].idle.has(x))return"idle:tier1"}return r.policyClassByCard?.[x]??M(n,r.play.seat,x).classId},f={};for(const x of u){const I=h(x);f[I]||(f[I]=x)}d.includes(o)&&(f[o]=i);const p=n.threatLabels,C=d.filter(x=>{if(x.startsWith("idle"))return!0;const I=u.filter($=>h($)===x);return I.length>0&&!!p&&I.every($=>p[r.play.seat].idle.has($))}),S=r.replay?.action==="forced"&&n.replay.transcript&&typeof r.replay.index=="number"?n.replay.transcript.decisions[r.replay.index]:null,y=[...a.remaining],b=null;if(S&&S.seat===r.play.seat){const x=[S.chosenAltClassId??S.chosenClassId,...S.sameBucketAlternativeClassIds].filter((I,$,L)=>I&&L.indexOf(I)===$);d.splice(0,d.length,...x);for(const[I,$]of Object.entries(S.representativeCardByClass))f[I]=$;if(d.includes(o)||d.push(o),f[o]=i,G&&(y&&y.join(",")!==S.sameBucketAlternativeClassIds.join(",")||!y&&b)){const I=y?y.join(",")||"-":"unavailable:unknown",$=a.classes,L=new Set(S.invEqIdleClasses),N=$.filter(he=>!he.startsWith("idle")&&!L.has(he)),re=y&&y.length>0?"ok":"singleton";m=[...m,me(S.nodeKey||"-",`[EQC:replay] idx=${r.replay.index} recordedRemaining=${S.sameBucketAlternativeClassIds.join(",")||"-"} runtimeRemaining=${I}`),me(S.nodeKey||"-",`[EQC:replayRemaining] idx=${r.replay.index} seat=${r.play.seat} nodeKey=${S.nodeKey||"-"} policyScope=${ue} availClasses={${$.join(",")||"-"}} branchableAvail={${N.join(",")||"-"}} chosenClass=${o} computedRemaining={${y?.join(",")||"-"}} reason=${re}`)].slice(-500)}}const E=u.filter(x=>h(x)===o);G&&(m=[...m,me(s||"-",`[EQC] idx=${_.length} seat=${r.play.seat} nodeKey=${s||"-"} scope=${ue} bucket=${a.bucket} classes=${d.join(",")||"-"} chosen=${o} covers=${E.join(",")||"-"} remaining=${c.join(",")||"-"} invEqVersion=${He}`)].slice(-500));const A=_.length,v=r.play.seat,H=`${A}:${v}`;Ke.has(H)||Ke.set(H,{idx:A,seat:v,bucket:a.bucket,classes:[...d],remaining:[...c],chosen:o,eqByTier:a.eqByTier}),Nr(),_.push({index:_.length,seat:r.play.seat,nodeKey:s,sig:r.decisionSig,chosenCard:i,chosenClassId:l,chosenAltClassId:o,invEqIdleClasses:C,chosenBucket:a.bucket,bucketCards:u,sameBucketAlternativeClassIds:d.filter(x=>x!==o),representativeCardByClass:f}),xe.push(o)}Ae(n,r)}}function qr(e){const t=e.goal;return t.type==="minTricks"?`${t.side} ${t.n} tricks`:"Unknown goal"}function Mr(){return D&&pe?pe:g}function je(e){D=!1,Se=null,pe=null,oe=!1,e&&ee.length>0&&(m=[...m,...ee].slice(-500),ee=[])}function Re(e,t){return t.startsWith("idle")||e.invEqIdleClasses.includes(t)}function un(e,t,n,r){const s=new Set(e.decisions.map(o=>o.index)),a=Vn(t,s,n),i=[],l=[];for(const o of e.decisions){const d=[o.chosenAltClassId??o.chosenClassId,...o.sameBucketAlternativeClassIds].filter((C,S,y)=>!!C&&y.indexOf(C)===S),c=d.filter(C=>Re(o,C)),u=d.filter(C=>!Re(o,C)),f=(a.find(C=>C.index===o.index)?.remainingKeys??[]).filter(C=>!Re(o,C)),p=u.length>=2&&f.length>0;i.push(me(o.nodeKey||"-",`[PLAYAGAIN] candCheck idx=${o.index} seat=${o.seat} nodeKey=${o.nodeKey||"-"} avail={${d.join(",")||"-"}} invEqIdle={${c.join(",")||"-"}} -> branchableAvail={${u.join(",")||"-"}} branchable=${p} reason=${p?r:"idleFiltered"}`)),p&&l.push({index:o.index,seat:o.seat,nodeKey:o.nodeKey||"-",avail:d,invEqIdle:c,branchableAvail:u,remainingKeys:f})}return{candidates:l,logsOut:i}}function Ht(e,t){const n=de.map(s=>`${s}:${Ne.map(a=>e.hands[s][a].join("")).join("/")}`).join("|"),r=e.trick.map(s=>`${s.seat}${s.suit}${s.rank}`).join(",");return`${e.phase}|${e.turn}|${e.leader}|${r}|${n}|${t.seat}${t.suit}${t.rank}`}function fn(){const n=g.userControls.includes(g.turn)&&(!D&&g.phase==="awaitUser"||D&&oe&&g.phase!=="end");if(!Ve||!n){U();return}const r=B(g).filter(i=>i.seat===g.turn);if(r.length!==1){U();return}const s=r[0],a=Ht(g,s);Te&&lt===a||(U(),lt=a,Te=setTimeout(()=>{const o=g.userControls.includes(g.turn)&&(!D&&g.phase==="awaitUser"||D&&oe&&g.phase!=="end");if(!Ve||!o){U();return}const d=B(g).filter(u=>u.seat===g.turn);if(d.length!==1){U();return}const c=d[0];if(Ht(g,c)!==a){U();return}U(),pn(c)},500))}function rt(e,t){t&&(m=[]);const n=$r(Z);if($e=g.threat??null,Ee=g.threatLabels??null,t&&et(),n.length===0){V.length===0&&We({kind:"info",at:"Start",label:"No teaching events yet."});return}V.some(r=>r.kind==="threatSummary")||Or(g),G&&(dt||rn(),dt=!1,m=[...m,`[THREAT:init] problem=${e} raw=${n.join(",")} validation=OK`].slice(-500),m=[...m,...Lr(g)].slice(-500),m=[...m,...Rr(g)].slice(-500))}function yt(e,t){U(),Ze(),se.clear();const n=e>>>0;n!==W>>>0&&(Y.triedByIdx.clear(),Y.recordedRemainingByIdx.clear(),Y.representativeByIdx.clear()),W=n,g=Je({...Z,rngSeed:W}),m=[...m,`${t} seed=${W}`].slice(-500),j="running",ge=0,He=0,ie=null,we=!1,w=!1,O=null,X=null,_=[],ce=[],xe=[],et(),nt(g),xt(),Oe.length=0,ee=[],je(!1),rt(ne,!1),T()}function Ur(e){U(),Ze(),se.clear();const t=ve.find(n=>n.id===e);t&&(Z=t.problem,ne=t.id,W=Z.rngSeed>>>0,g=Je({...Z,rngSeed:W}),j="running",ge=0,He=0,ie=null,we=!1,w=!1,O=null,X=null,_=[],ce=[],xe=[],et(),nt(g),xt(),K=null,Y.triedByIdx.clear(),Y.recordedRemainingByIdx.clear(),Y.representativeByIdx.clear(),Oe.length=0,ee=[],je(!1),rt(ne,!0),T())}function Gr(){U();const e=Oe.pop();e&&(vr(e),Ze(),se.clear(),m=[...m,`[UNDO] restored snapshot before user play: ${e.play.seat}:${k(e.play.suit,e.play.rank)}`].slice(-500),T())}function pn(e){if(U(),g.replay.enabled&&g.replay.transcript&&(e.seat==="N"||e.seat==="S")){const a=k(e.suit,e.rank),i=Ye(e.seat,a),l=g.replay.transcript.userPlays[ce.length];if(l&&l.playClassId!==i){const o=g.replay.cursor;g.replay.enabled=!1,we=!0,m=[...m,`[PLAYAGAIN] user diverged at decisionIdx=${o} expectedClass=${l.playClassId} actualClass=${i}; continuing without forcing further decisions`].slice(-500)}else if(G){const o=Ye(e.seat,a),d=Br(o,a);m=[...m,`[EQ] seat=${e.seat} played=${a} class=${o} rep=${d}`].slice(-500)}}if(e.seat==="N"||e.seat==="S"){const a=k(e.suit,e.rank),i=Ye(e.seat,a);ce.push({index:ce.length,seat:e.seat,playClassId:i}),xe.push(i)}Oe.push(Ir(e)),D&&je(!0);const t=g,n=Un(g,e);g=n.state,$e=g.threat??null,Ee=g.threatLabels??null,Kr(t,n.events);const r=n.events.findIndex(a=>a.type==="trickComplete");if(jr(t,n.events),r>=0){const a=n.events.slice(0,r+1),i=n.events.slice(r+1),l=le(t);for(const c of a)Ae(l,c);D=!0,pe=l;const o=a[a.length-1];o.type==="trickComplete"&&(Se=o.trick.map(c=>({...c}))),oe=g.phase!=="end"&&g.trick.length===0&&g.userControls.includes(g.turn);const d=st(t,e,a);if(m=[...m,...d].slice(-500),i.length>0){const c=st(l,e,i);ee=[...ee,...c].slice(-500)}}else{const a=st(t,e,n.events);m=[...m,...a].slice(-500)}const s=n.events.find(a=>a.type==="handComplete");if(s?.type==="handComplete"&&s.success){K={problemId:ne,seed:W,decisions:_.map(o=>({...o,bucketCards:[...o.bucketCards],sameBucketAlternativeClassIds:[...o.sameBucketAlternativeClassIds],representativeCardByClass:{...o.representativeCardByClass}})),userPlays:ce.map(o=>({...o}))},m=[...m,`[PLAYAGAIN] recorded transcript ${K.decisions.length} decisions`].slice(-500);for(const o of K.decisions)Qn(Y,o);const{candidates:a,logsOut:i}=un(K,Y,ie,"endOfRunSuccess");w=a.length>0,O=w?null:ie!==null?"user-mismatch-exhausted":"exhausted-all-variations",X=w?a[a.length-1].index:null;const l=w?(()=>{const o=a[a.length-1],d=o.remainingKeys[0]??"-",c=Y.representativeByIdx.get(o.index)?.get(d)??"-";return J(`[PLAYAGAIN] offer available=true candidates=[${a.map(u=>u.index).join(",")}] chosenCandidate=${o.index} forcedClass=${d} forcedCard=${c} reason=endOfRunSuccess`)})():null;m=[...m,...i,`[PLAYAGAIN] candidates=[${a.map(o=>o.index).join(",")}] cutoffIdx=${ie??"-"}`,...a.map(o=>`[PLAYAGAIN] idx=${o.index} remainingUntried=${o.remainingKeys.length} keys=${o.remainingKeys.join(",")}`),...l?[l]:[],w?`[PLAYAGAIN] availability ok=true lastCandidateIndex=${X}`:`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500)}if(s?.type==="handComplete"){const a=s.success?"success":"failure";G&&(m=[...m,`[GOAL] endOfRun=true NSwon=${s.tricksWon.NS} EWwon=${s.tricksWon.EW} required${g.goal.side}>=${g.goal.n} success=${s.success}`,`[RUNSTATUS] ${j} -> ${a}`].slice(-500)),j=a}T()}function Yr(e="autoplay"){if(U(),!K){w=!1,O="exhausted-all-variations",X=null,m=[...m,`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500),T();return}const{candidates:t,logsOut:n}=un(K,Y,ie,e==="manual"?"manualRequest":"offerCheck");if(w=t.length>0,O=w?null:ie!==null?"user-mismatch-exhausted":"exhausted-all-variations",X=w?t[t.length-1].index:null,m=[...m,...n,J(`[PLAYAGAIN] candidates=[${t.map(c=>c.index).join(",")}] cutoffIdx=${ie??"-"}`),...t.map(c=>`[PLAYAGAIN] idx=${c.index} remainingUntried=${c.remainingKeys.length} keys=${c.remainingKeys.join(",")}`)].slice(-500),w){const c=t[t.length-1],u=c.remainingKeys[0]??"-",h=Y.representativeByIdx.get(c.index)?.get(u)??"-";m=[...m,J(`[PLAYAGAIN] offer shown candidates=[${t.map(f=>f.index).join(",")}] reason=${e==="manual"?"manualRequest":"other"}`),J(`[PLAYAGAIN] offer available=true candidates=[${t.map(f=>f.index).join(",")}] chosenCandidate=${c.index} forcedClass=${u} forcedCard=${h} reason=${e==="manual"?"manualRequest":"other"}`)].slice(-500)}if(!w){m=[...m,`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500),T();return}const r=K?.seed??W;g=Je({...Z,rngSeed:r});let s=null,a=null,i=null;const l=[];for(const c of t)c.remainingKeys.length>0&&l.push(`[EQC:playagain] idx=${c.index} remaining=${c.remainingKeys.join(",")||"-"}`);const o=t[t.length-1];if(s=o.index,a=o.remainingKeys[0]??null,a&&(i=Y.representativeByIdx.get(s)?.get(a)??null,m=[...m,`[PLAYAGAIN] candidates=[${t.map(u=>u.index).join(",")}] chosen=${s}`].slice(-500),m=[...m,`[PLAYAGAIN] divergenceIndex=${s} forcedClass=${a} forcedCard=${i??"-"}`].slice(-500)),G&&(m=[...m,"----- PLAY AGAIN COVERAGE -----",...l.length>0?l:["[EQC:playagain] none"]].slice(-500)),!a||s===null){w=!1,O="exhausted-all-variations",X=null,m=[...m,`[PLAYAGAIN] availability ok=false reason=${O}`].slice(-500),T();return}rn(),dt=!0,m=[...m,J(`[PLAYAGAIN] offer selected chosenCandidate=${s} divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"} source=${e==="manual"?"uiClick":"other"}`),J(`[PLAYAGAIN] ${e==="manual"?"manual":"autoplay"} selected=true source=${e==="manual"?"uiClick":"other"} -> starting replay divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"}`)].slice(-500),g.replay={enabled:!0,transcript:{problemId:K.problemId,seed:K.seed,decisions:K.decisions.map(c=>({...c,bucketCards:[...c.bucketCards],sameBucketAlternativeClassIds:[...c.sameBucketAlternativeClassIds],representativeCardByClass:{...c.representativeCardByClass}})),userPlays:K.userPlays.map(c=>({...c}))},cursor:0,divergenceIndex:s,forcedCard:i,forcedClassId:a},W=r,j="running",ge=0,He=0,we=!1,w=!1,O=null,X=null,_=[],ce=[],xe=[],et(),nt(g),xt(),ee=[],je(!1);const d=[J("[PLAYAGAIN] replayStart candidates summary:")];for(const c of K.decisions){const u=[c.chosenAltClassId??c.chosenClassId,...c.sameBucketAlternativeClassIds].filter((p,C,S)=>!!p&&S.indexOf(p)===C),h=u.filter(p=>!Re(c,p));if(h.length<2)continue;const f=c.index===s?` FORCING=${a}`:"";d.push(me(c.nodeKey||"-",`[PLAYAGAIN] idx=${c.index} seat=${c.seat} nodeKey=${c.nodeKey||"-"} avail={${u.join(",")}} branchableAvail={${h.join(",")}} chosen=${c.chosenAltClassId} remaining={${c.sameBucketAlternativeClassIds.filter(p=>!Re(c,p)).join(",")||"-"}}${f}`))}m=[...m,J(`[PLAYAGAIN] replayStart plan divergenceIdx=${s} forcedClass=${a} forcedCard=${i??"-"} source=${e}`),...d,J(`===== PLAY AGAIN REPLAY ===== divergenceIdx=${s} forced=${i??"-"} forcedClass=${a}`),J("[PLAYAGAIN] replay enabled"),""].slice(-500),rt(ne,!1),T()}function Fr(e,t,n,r,s){const a=document.createElement("div");a.className="suit-row";const i=document.createElement("span");i.className=`suit-symbol suit-${n}`,i.textContent=$t[n],a.appendChild(i);const l=document.createElement("div");l.className="cards";const o=Sr(e.hands[t][n]),d=new Set;if(Pe){for(const c of ze(e,t,n))if(c.length>1)for(const u of c)d.add(u)}if(o.length>0)for(const c of o){const u=`${n}${c}`,h=s&&r.has(u),f=d.has(c);if(h){const p=document.createElement("button");p.type="button",p.className="rank-text legal",(se.get(ft(t,k(n,c)))??0)>Date.now()&&p.classList.add("card-pulse"),ht(p,c,pt(k(n,c)),f),p.onclick=()=>pn({seat:t,suit:n,rank:c}),l.appendChild(p)}else{const p=document.createElement("span");p.className="rank-text muted",(se.get(ft(t,k(n,c)))??0)>Date.now()&&p.classList.add("card-pulse"),ht(p,c,pt(k(n,c)),f),l.appendChild(p)}}return a.appendChild(l),a}function Me(e,t){const n=document.createElement("section"),r=e.turn===t;n.className=`hand seat-${t}`;const s=document.createElement("div");s.className="hand-head",s.innerHTML=`<strong class="seat-name${r?" active-seat-name":""}">${Zt[t]}</strong>`,n.appendChild(s);const a=!D&&r?B(e):[],i=new Set(a.map(d=>`${d.suit}${d.rank}`)),l=!D&&e.phase!=="end"&&e.userControls.includes(t)&&r;if(D&&oe&&g.userControls.includes(g.turn)&&t===g.turn){const d=B(g);for(const c of d)i.add(`${c.suit}${c.rank}`)}const o=l||D&&oe&&t===g.turn;for(const d of Ne)n.appendChild(Fr(e,t,d,i,o));return n}function Qr(e){const t=document.createElement("section");t.className=`trick-table${D?" frozen":""}`,D&&(t.title="Click to dismiss trick",t.onclick=()=>{je(!0),T()});const n=D&&Se?Se:e.trick,r=new Map(n.map(s=>[s.seat,s]));for(const s of de){const a=document.createElement("div");a.className=`trick-slot slot-${s}`;const i=r.get(s);if(i){const l=document.createElement("span");l.className="played-text";const o=document.createElement("span");o.className=`played-suit suit-${i.suit}`,o.textContent=$t[i.suit];const d=document.createElement("span");d.className="played-rank",ht(d,i.rank,pt(k(i.suit,i.rank))),l.append(o,d),a.appendChild(l)}t.appendChild(a)}return t}function Vr(e){const t=document.createElement("section");t.className="status-panel";const n=document.createElement("strong");n.textContent="Status",t.appendChild(n);const r=document.createElement("div");r.className="status-facts",r.innerHTML=`
    <div><span class="k">Contract</span><span class="v">${e.contract.strain}</span></div>
    <div><span class="k">Goal</span><span class="v">${qr(e)}</span></div>
    <div class="tricks"><span class="k">Tricks</span><span class="v heavy">NS ${e.tricksWon.NS} - EW ${e.tricksWon.EW}</span></div>
    <div class="meta-row"><span class="k">Leader</span><span class="v turn-meta">${e.leader}</span></div>
    <div class="meta-row"><span class="k">Turn</span><span class="v turn-meta turn-emph">${e.turn}</span></div>
    <div class="meta-row"><span class="k">Seed</span><span class="v seed">${W}</span></div>
  `;const s=document.createElement("div");s.className="meta-row";const a=document.createElement("span");a.className="k",a.textContent="Variations";const i=document.createElement("span");i.className="v turn-meta";const l=document.createElement("select");return["strict","sameLevel","allBusy"].forEach(o=>{const d=document.createElement("option");d.value=o,d.textContent=Dt[o],o===ue&&(d.selected=!0),l.appendChild(d)}),l.onchange=()=>{const o=l.value;o!==ue&&(ue=o,yt(W,`Variation mode changed: ${Dt[o]}`))},i.appendChild(l),s.append(a,i),r.appendChild(s),t.appendChild(r),t}function zr(){const e=document.createElement("section");e.className="controls-banner";const t=document.createElement("div");t.className="controls";const n=document.createElement("label");n.textContent="Puzzle: ";const r=document.createElement("select"),s=[...ve].sort((b,E)=>+!!b.experimental-+!!E.experimental);for(const b of s){const E=document.createElement("option");E.value=b.id,E.textContent=b.label,E.selected=b.id===ne,r.appendChild(E)}r.onchange=()=>{Ur(r.value)},n.appendChild(r),t.appendChild(n);const a=document.createElement("button");a.type="button",a.textContent="Reset",a.onclick=()=>yt(W,"reset"),t.appendChild(a);const i=document.createElement("button");i.type="button",i.textContent="Backup",i.disabled=Oe.length===0,i.onclick=()=>Gr(),t.appendChild(i);const l=document.createElement("button");l.type="button",l.textContent="New seed",l.onclick=()=>yt(Date.now()>>>0,"newSeed"),t.appendChild(l);const o=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=ot,d.onchange=()=>{ot=d.checked,T()},o.append(d," Show boxes"),t.appendChild(o);const c=document.createElement("label"),u=document.createElement("input");u.type="checkbox",u.checked=Pe,u.onchange=()=>{Pe=u.checked,T()},c.append(u," Teaching mode"),t.appendChild(c);const h=document.createElement("label"),f=document.createElement("input");f.type="checkbox",f.checked=Ve,f.onchange=()=>{Ve=f.checked,fn(),T()},h.append(f," Autoplay singletons"),t.appendChild(h);const p=document.createElement("label"),C=document.createElement("input");C.type="checkbox",C.checked=it,C.onchange=()=>{it=C.checked,T()},p.append(C," Show log"),t.appendChild(p);const S=document.createElement("label"),y=document.createElement("input");return y.type="checkbox",y.checked=G,y.onchange=()=>{G=y.checked,T()},S.append(y," Verbose log"),t.appendChild(S),e.appendChild(t),e}function Jr(){const e=document.createElement("aside");e.className="teaching-pane";const t=document.createElement("strong");t.textContent="Key teaching events",e.appendChild(t);const n=document.createElement("div");n.className="teaching-events";const r=V.length>0?V:[{id:0,kind:"info",label:"No teaching events yet."}];for(const s of r){const a=document.createElement("div");a.className=`teaching-event teaching-${s.kind}`;const i=document.createElement("span");i.className="teaching-at",i.textContent=s.at??"",a.appendChild(i);const l=document.createElement("span");if(l.className="teaching-text",l.textContent=s.label,a.appendChild(l),s.detail){const o=document.createElement("pre");o.className="teaching-detail",o.textContent=s.detail,a.appendChild(o)}n.appendChild(a)}return e.appendChild(n),e}function T(){const e=Mr();P.innerHTML="",P.appendChild(zr());const t=document.createElement("section");t.className="main-row";const n=document.createElement("div");n.className="table-host";const r=document.createElement("main");if(r.className=`table-canvas${ot?" show-guides":""}`,r.appendChild(Qr(e)),r.appendChild(Me(e,"N")),r.appendChild(Me(e,"W")),r.appendChild(Me(e,"E")),r.appendChild(Me(e,"S")),n.appendChild(r),t.appendChild(Jr()),t.appendChild(n),t.appendChild(Vr(e)),P.appendChild(t),j==="success"||j==="failure"){const s=document.createElement("div");s.className=`banner ${j==="success"?"ok":"fail"}`,s.textContent=j==="success"?"Success - goal achieved":"Not enough tricks - try again",P.appendChild(s)}if(j==="success"&&w){const s=document.createElement("button");s.type="button",s.textContent="Play Again",s.onclick=()=>Yr("manual"),P.appendChild(s)}if(j==="success"&&!w){const s=document.createElement("div");s.className="banner",s.textContent="No 'Play Again' variations available: defenders had no same-tier alternatives to explore.",P.appendChild(s)}if(it){const s=document.createElement("section");s.className="log-panel";const a=document.createElement("strong");a.textContent="Log",s.appendChild(a);const i=document.createElement("div");i.className="log",i.textContent=m.length>0?m.join(`
`):"No events yet",s.appendChild(i),P.appendChild(s),i.scrollTop=i.scrollHeight}fn()}rt(ne,!1);T();
