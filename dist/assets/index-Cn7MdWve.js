(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const Te=["S","H","D","C"],Ze=["E","W"],kt={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function H(e){const t=e.slice(0,1),n=e.slice(1);if(!Te.includes(t)||!(n in kt))throw new Error(`Invalid CardId: ${e}`);return{suit:t,rank:n}}function g(e,t){return`${e}${t}`}function F(e){return kt[e]}function bt(e,t){const{suit:n,rank:r}=H(t),s=[],i=["N","E","S","W"];for(const a of i)e.hands[a][n].includes(r)&&s.push(a);return s}function St(e,t,n,r){return e.hands[t][n].filter(s=>F(s)>=F(r)).length}function Mt(e,t){const n={};for(const r of t){const{suit:s,rank:i}=H(r);if(n[s])throw new Error(`Duplicate threat suit: ${s}`);const a=bt(e,r);if(a.length!==1)throw new Error(`Threat card ${r} must exist in exactly one hand (found ${a.length})`);const l=a[0];n[s]={suit:s,threatCardId:r,threatRank:i,establishedOwner:l,active:!0,threatLength:St(e,l,s,i)}}return{threatsBySuit:n,threatCardIds:[...t]}}function Yt(e,t){const n={E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}};for(const r of Ze)for(const s of Te){for(const c of t.hands[r][s])n[r].idle.add(g(s,c));const i=e.threatsBySuit[s];if(!i||!i.active||i.threatLength<=0)continue;const a=t.hands[r][s],l=a.some(c=>F(c)>F(i.threatRank)),o=a.length>=i.threatLength;if(!l||!o)continue;const u=[...a].sort((c,d)=>F(d)-F(c)).slice(0,i.threatLength);for(const c of u){const d=g(s,c);n[r].idle.delete(d),n[r].busy.add(d)}}return n}function Ft(e){return{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}}function lt(e,t,n){return[...e[t].busy].some(r=>H(r).suit===n)}function et(e,t,n){const r=e.threatsBySuit[n];if(!r||!r.active)return;const s=lt(t,"E",n),i=lt(t,"W",n);return s&&i?"double":s||i?"single":"none"}function $t(e,t,n){const r=e.threatsBySuit[n];return!r||!r.active?!1:(r.stopStatus??et(e,t,n))==="none"}function Qt(e,t,n){return $t(e,t,n)?e.threatsBySuit[n]?.threatRank??null:null}function zt(e,t,n,r){for(const s of Ze){for(const c of[...n[s].busy])H(c).suit===r&&n[s].busy.delete(c);for(const c of[...n[s].idle])H(c).suit===r&&n[s].idle.delete(c);for(const c of t.hands[s][r])n[s].idle.add(g(r,c));const i=e.threatsBySuit[r];if(!i||!i.active||i.threatLength<=0)continue;const a=t.hands[s][r],l=a.some(c=>F(c)>F(i.threatRank)),o=a.length>=i.threatLength;if(!l||!o)continue;const u=[...a].sort((c,d)=>F(d)-F(c)).slice(0,i.threatLength);for(const c of u){const d=g(r,c);n[s].idle.delete(d),n[s].busy.add(d)}}}function It(e,t,n,r,s){for(const l of Object.keys(e))H(l).suit===s&&delete e[l];const i=["N","E","S","W"];for(const l of i)for(const o of r.hands[l][s]){const u=g(s,o);e[u]="default"}for(const l of Ze){for(const o of n[l].idle)H(o).suit===s&&(e[o]="idle");for(const o of n[l].busy)H(o).suit===s&&(e[o]="busy")}const a=t.threatsBySuit[s];a?.active&&(e[a.threatCardId]="threat",$t(t,n,s)&&(e[a.threatCardId]="promotedWinner"))}function ct(e,t){const n=Mt(e,t),r=Yt(n,e);for(const i of Te){const a=n.threatsBySuit[i];a&&(n.threatsBySuit[i]={...a,stopStatus:et(n,r,i)})}const s={};for(const i of Te)It(s,n,r,e,i);return{threat:n,labels:r,perCardRole:s}}function xt(e,t,n){const r={threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}},s=Ft(e.labels),i={...e.perCardRole};delete i[n];const a=H(n).suit,l=new Set;r.threatsBySuit[a]&&l.add(a);for(const o of l){const u=r.threatsBySuit[o];if(!u)continue;const c=bt(t,u.threatCardId),d=c.length===1&&c[0]===u.establishedOwner;r.threatsBySuit[o]={...u,active:d,threatLength:d?St(t,u.establishedOwner,o,u.threatRank):0,stopStatus:void 0},zt(r,t,s,o);const h=r.threatsBySuit[o];h&&(r.threatsBySuit[o]={...h,stopStatus:et(r,s,o)}),It(i,r,s,t,o)}return{threat:r,labels:s,perCardRole:i}}const Vt=["S","H","D","C"],fe={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function Jt(e,t){if(t&&e[t].length>0)return e[t].map(r=>g(t,r));const n=[];for(const r of Vt)for(const s of e[r])n.push(g(r,s));return n}function tt(e,t,n){return n[e].idle.has(t)}function Et(e){return H(e).rank}function K(e){return H(e).suit}function nt(e,t){return!!t.threatsBySuit[e]?.active}function At(e,t){const n=t.threatsBySuit[e];return!n||!n.active?null:n.threatRank}function Ee(e,t,n){const r=At(e,t);if(!r)return null;const s=Qt(t,n,e);return s&&fe[s]>fe[r]?s:r}function Bt(e,t,n,r){return tt(e,t,n)?!nt(K(t),r):!1}function vt(e,t,n,r){if(!tt(e,t,n))return!1;const s=K(t),i=Ee(s,r,n);return i?fe[Et(t)]<fe[i]:!1}function _t(e,t,n,r){return tt(e,t,n)?!Bt(e,t,n,r)&&!vt(e,t,n,r):!1}function Xt(e,t,n){return n[e].busy.has(t)}function we(e,t,n,r){if(!Xt(e,t,n))return!1;const s=K(t);return nt(s,r)}function wt(e,t,n){const r=n.threatsBySuit[e]?.stopStatus;if(r)return r;if(!nt(e,n))return;const s=[...t.E.busy].some(a=>K(a)===e),i=[...t.W.busy].some(a=>K(a)===e);return s&&i?"double":s||i?"single":"none"}function dt(e,t,n,r){return wt(t,n,r)==="double"}function ut(e,t,n,r){return wt(t,n,r)!=="single"?!1:[...n[e].busy].some(s=>K(s)===t)}function ft(e,t){const n=K(e),r=Et(e),s=At(n,t);return s?fe[r]<fe[s]:!1}function rt(e,t,n,r,s){const i=t.hands[e],a=Jt(i,n),l=a.filter(p=>Bt(e,p,s,r)),o=a.filter(p=>vt(e,p,s,r)),u=a.filter(p=>_t(e,p,s,r)),c=a.filter(p=>{if(!we(e,p,s,r))return!1;const k=K(p);return dt(e,k,s,r)&&ft(p,r)}),d=a.filter(p=>{if(!we(e,p,s,r))return!1;const k=K(p);return dt(e,k,s,r)}),h=a.filter(p=>{if(!we(e,p,s,r))return!1;const k=K(p);return ut(e,k,s,r)&&ft(p,r)}),f=a.filter(p=>{if(!we(e,p,s,r))return!1;const k=K(p);return ut(e,k,s,r)});return{legal:a,tier1a:l,tier1b:o,tier1c:u,tier2a:c,tier2b:d,tier3a:h,tier3b:f,tier4:a}}const Nt=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],Zt=["N","E","S","W"];function J(e){return Nt.indexOf(e)}function Lt(e,t){return`${e}${t}`}function en(e,t){const n=J(e),r=J(t);return n<0||r<0||r-n<=1?[]:Nt.slice(n+1,r)}function tn(e,t,n,r,s){const i=en(r,s);if(i.length===0)return!0;const a=Zt.filter(l=>l!==t);return i.every(l=>a.every(o=>!e.hands[o][n].includes(l)))}function nn(e,t){return Math.abs(J(e)-J(t))===1}function je(e,t,n){const r=[...e.hands[t][n]].sort((i,a)=>J(i)-J(a));if(r.length===0)return[];const s=[[r[0]]];for(let i=1;i<r.length;i+=1){const a=r[i-1],l=r[i];nn(a,l)||tn(e,t,n,a,l)?s[s.length-1].push(l):s.push([l])}return s}function rn(e,t,n){const r=[...n].sort((a,l)=>J(a)-J(l)),s=r[0],i=r[r.length-1];return`${e}:${t}:${s}-${i}`}function sn(e,t){const n=[...t].sort((s,i)=>J(s)-J(i)),r=n[n.length-1];return Lt(e,r)}function D(e,t,n){const r=n[0],s=n.slice(1),a=je(e,t,r).find(l=>l.includes(s))??[s];return{classId:rn(t,r,a),representative:sn(r,a),members:a.map(l=>Lt(r,l))}}const $e=["N","E","S","W"],st=["S","H","D","C"],le={2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,T:10,J:11,Q:12,K:13,A:14};function Z(e){return{S:[...e.S],H:[...e.H],D:[...e.D],C:[...e.C]}}function an(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},hands:{N:Z(e.hands.N),E:Z(e.hands.E),S:Z(e.hands.S),W:Z(e.hands.W)},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:{enabled:e.replay.enabled,transcript:e.replay.transcript?{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}:null,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId}}}function on(e){const t=$e.indexOf(e);return $e[(t+1)%$e.length]}function ln(e){return e==="N"||e==="S"?"NS":"EW"}function Re(e){return $e.every(t=>st.every(n=>e[t][n].length===0))}function cn(e,t){return e.type==="minTricks"?t[e.side]>=e.n:!1}function dn(e){let n=e.seed+Math.imul(e.counter,2654435769)>>>0;return n^=n>>>16,n=Math.imul(n,2146121005)>>>0,n^=n>>>15,n=Math.imul(n,2221713035)>>>0,n^=n>>>16,e.counter+=1,n/4294967296}function Fe(e,t){return Math.floor(dn(t)*e)}function un(e,t){const n=e[0].suit,r=t?e.filter(a=>a.suit===t):[],s=r.length>0?r:e.filter(a=>a.suit===n);let i=s[0];for(const a of s)le[a.rank]>le[i.rank]&&(i=a);return i.seat}function fn(e,t,n){const r=e[t].indexOf(n);return r<0?!1:(e[t].splice(r,1),!0)}function Se(e){return e.userControls.includes(e.turn)}function be(e){const t=A(e);if(t.length===0)return null;const n=Fe(t.length,e.rng);return!Number.isFinite(n)||n<0||n>=t.length?t[0]:t[n]??t[0]}function pn(e){const t=e.turn,n=e.trick[0]?.suit??"-",r=e.contract.strain,s=A(e).map(a=>D(e,a.seat,g(a.suit,a.rank)).classId).sort().join(","),i=e.trickClassIds.join(",");return`seat=${t}|lead=${n}|trump=${r}|legal=${s}|trick=${i}`}function hn(e){const t={};for(const n of $e){const r=e.preferredDiscards?.[n];r&&(t[n]=Array.isArray(r)?[...r]:[r])}return t}function yn(e){const t=e.turn,n=e.preferredDiscards[t];if(!n||n.length===0)return null;const r=e.trick[0]?.suit??null;if(!r)return{preferred:n,applied:!1,reason:"not-discard"};if(e.hands[t][r].length>0)return{preferred:n,applied:!1,reason:"can-follow-suit"};if(e.preferredDiscardUsed[t])return{preferred:n,applied:!1,reason:"already-used"};const s=A(e).map(a=>g(a.suit,a.rank)),i=new Set;for(const a of st)for(const l of e.hands[t][a])i.add(g(a,l));for(const a of n)if(i.has(a))return s.includes(a)?{preferred:n,applied:!0,chosen:a,reason:"applied"}:{preferred:n,applied:!1,chosen:a,reason:"not-legal"};return{preferred:n,applied:!1,reason:"not-in-hand"}}function Y(e,t,n,r){if(!r||r.length===0)return;const s={};for(const i of r){const a=D(e,t,i).classId;!n||!n.startsWith("tier")?s[i]=a:n.startsWith("tier1")?s[i]="idle:tier1":n.startsWith("tier2")||n.startsWith("tier3")?s[i]=`busy:${i[0]}`:s[i]=`other:${i[0]}`}return s}function Cn(e,t){const n=e.turn==="E"||e.turn==="W",r=n?pn(e):void 0;let s;if(n&&e.replay.enabled&&e.replay.transcript){const m=e.replay.transcript.decisions[e.replay.cursor];if(!m)e.replay.enabled=!1;else if(m.sig!==r)e.replay.enabled=!1,s={action:"disabled",index:m.index,reason:"sig-mismatch",card:m.chosenCard};else{const $=A(e),S=e.replay.divergenceIndex!==null&&e.replay.cursor===e.replay.divergenceIndex,b=$.map(x=>g(x.suit,x.rank)),I=Y(e,e.turn,m.chosenBucket,b);let j,ne=m.chosenCard,oe=!1;if(S&&e.replay.forcedClassId){const x=$.find(L=>I[g(L.suit,L.rank)]===e.replay.forcedClassId);x?(j=x,ne=g(x.suit,x.rank)):(e.replay.enabled=!1,s={action:"disabled",index:m.index,reason:"class-not-legal",card:m.chosenCard,forcedClassId:e.replay.forcedClassId},oe=!0)}if(!j&&!oe&&(ne=S&&e.replay.forcedCard?e.replay.forcedCard:m.chosenCard,j=$.find(x=>g(x.suit,x.rank)===ne)),!j&&!oe){const x=$.find(L=>D(e,L.seat,g(L.suit,L.rank)).classId===m.chosenClassId);if(!x)e.replay.enabled=!1,s={action:"disabled",index:m.index,reason:"card-not-legal",card:ne};else{e.replay.cursor+=1;const L=m.chosenBucket,B=[...m.bucketCards],re=Y(e,e.turn,L,B);return S&&(e.replay.enabled=!1),{play:x,decisionSig:r,chosenBucket:L,bucketCards:B,policyClassByCard:re,replay:{action:"forced",index:m.index,card:g(x.suit,x.rank)}}}}else{e.replay.cursor+=1;const x=m.chosenBucket,L=[...m.bucketCards],B=Y(e,e.turn,x,L);return S&&(e.replay.enabled=!1),{play:j,decisionSig:r,chosenBucket:x,bucketCards:L,policyClassByCard:B,replay:{action:"forced",index:m.index,card:ne}}}}}const i=yn(e);if(i?.applied&&i.chosen){e.preferredDiscardUsed[e.turn]=!0;const{suit:m,rank:$}=H(i.chosen),S=[i.chosen],b="preferred",I=Y(e,e.turn,b,S);return{play:{seat:e.turn,suit:m,rank:$},preferredDiscard:i,chosenBucket:b,bucketCards:S,policyClassByCard:I,decisionSig:r,replay:s}}if(t.kind==="randomLegal"){const m=A(e),$="legal",S=m.map(I=>g(I.suit,I.rank)),b=n?Y(e,e.turn,$,S):void 0;return{play:be(e),preferredDiscard:i??void 0,chosenBucket:$,bucketCards:S,policyClassByCard:b,decisionSig:r,replay:s}}if(t.kind!=="threatAware")return{play:null,preferredDiscard:i??void 0,decisionSig:r,replay:s};if(e.turn!=="E"&&e.turn!=="W")return{play:be(e),preferredDiscard:i??void 0,decisionSig:r,replay:s};const a=e.trick[0]?.suit??null;if(!a){const m=A(e),$="lead:none",S=m.map(I=>g(I.suit,I.rank)),b=Y(e,e.turn,$,S);return{play:be(e),preferredDiscard:i??void 0,chosenBucket:$,bucketCards:S,policyClassByCard:b,decisionSig:r,replay:s}}if(e.hands[e.turn][a].length>0){const m=A(e);if(!e.threat||!e.threatLabels){const B="follow:baseline",re=m.map(ke=>g(ke.suit,ke.rank)),qe=Y(e,e.turn,B,re);return{play:be(e),preferredDiscard:i??void 0,chosenBucket:B,bucketCards:re,policyClassByCard:qe,decisionSig:r,replay:s}}const $=Ee(a,e.threat,e.threatLabels);if(!$){const B="follow:baseline",re=m.map(ke=>g(ke.suit,ke.rank)),qe=Y(e,e.turn,B,re);return{play:be(e),preferredDiscard:i??void 0,chosenBucket:B,bucketCards:re,policyClassByCard:qe,decisionSig:r,replay:s}}const S=m.filter(B=>le[B.rank]<le[$]),b=m.filter(B=>le[B.rank]>=le[$]),I=S.length>0?S:b,j=Fe(I.length,e.rng),ne=I[j]??I[0]??m[0]??null,oe=S.length>0?"follow:below":"follow:above",x=I.map(B=>g(B.suit,B.rank)),L=Y(e,e.turn,oe,x);return{play:ne,preferredDiscard:i??void 0,chosenBucket:oe,bucketCards:x,policyClassByCard:L,decisionSig:r,replay:s}}if(!e.threat)return{play:null,preferredDiscard:i??void 0,decisionSig:r,replay:s};const l=e.threatLabels??{E:{busy:new Set,idle:new Set},W:{busy:new Set,idle:new Set}},o=rt(e.turn,{hands:e.hands},a,e.threat,l),c=[{name:"tier1a",cards:o.tier1a},{name:"tier1b",cards:o.tier1b},{name:"tier1c",cards:o.tier1c},{name:"tier2a",cards:o.tier2a},{name:"tier2b",cards:o.tier2b},{name:"tier3a",cards:o.tier3a},{name:"tier3b",cards:o.tier3b},{name:"tier4",cards:o.tier4}].find(m=>m.cards.length>0)??{name:"tier4",cards:o.tier4},d=Fe(c.cards.length,e.rng),h=c.cards[d]??c.cards[0],{suit:f,rank:p}=H(h),k=Y(e,e.turn,c.name,c.cards)??{};for(const m of[...o.tier2a,...o.tier2b,...o.tier3a,...o.tier3b])k[m]=`busy:${m[0]}`;const N={};return o.tier2a.length>0&&(N.tier2a=[...o.tier2a]),o.tier2b.length>0&&(N.tier2b=[...o.tier2b]),o.tier3a.length>0&&(N.tier3a=[...o.tier3a]),o.tier3b.length>0&&(N.tier3b=[...o.tier3b]),{play:{seat:e.turn,suit:f,rank:p},preferredDiscard:i??void 0,chosenBucket:c.name,bucketCards:[...c.cards],policyClassByCard:k,tierBuckets:N,decisionSig:r,replay:s}}function pt(e,t,n,r,s,i,a,l,o,u){const c=[],d=g(t.suit,t.rank),h=D(e,t.seat,d).classId;if(!fn(e.hands[t.seat],t.suit,t.rank))return c.push({type:"illegal",reason:`Card ${t.suit}${t.rank} not in ${t.seat} hand`}),c;if(e.trick.push({...t}),e.trickClassIds.push(`${t.seat}:${h}`),n==="autoplay"?c.push({type:n,play:{...t},preferredDiscard:r,chosenBucket:s,bucketCards:i,policyClassByCard:a,tierBuckets:l,decisionSig:o,replay:u}):c.push({type:n,play:{...t}}),e.threat&&e.threatLabels){const m=xt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},g(t.suit,t.rank));e.threat=m.threat,e.threatLabels=m.labels,e.cardRoles={...m.perCardRole}}if(e.trick.length<4)return e.turn=on(e.turn),c;const p=e.trick.map(m=>({...m})),k=un(p,e.trumpSuit),N=ln(k);return e.tricksWon[N]+=1,e.trick=[],e.trickClassIds=[],e.leader=k,e.turn=k,c.push({type:"trickComplete",winner:k,trick:p}),Re(e.hands)&&(e.phase="end",c.push({type:"handComplete",success:cn(e.goal,e.tricksWon),tricksWon:{...e.tricksWon}})),c}function Ue(e){const t=e.contract.strain==="NT"?null:e.contract.strain,n=Object.values(e.policies).some(l=>l?.kind==="threatAware");let r=null,s=null,i={};if(n){if(!e.threatCardIds||e.threatCardIds.length===0)throw new Error(`Problem ${e.id} uses threatAware policy but has no threatCardIds`);const l=ct({hands:e.hands},e.threatCardIds);r=l.threat,s=l.labels,i={...l.perCardRole}}else if(e.threatCardIds&&e.threatCardIds.length>0){const l=ct({hands:e.hands},e.threatCardIds);r=l.threat,s=l.labels,i={...l.perCardRole}}const a={id:e.id,contract:{...e.contract},trumpSuit:t,threat:r,threatLabels:s,cardRoles:i,hands:{N:Z(e.hands.N),E:Z(e.hands.E),S:Z(e.hands.S),W:Z(e.hands.W)},leader:e.leader,turn:e.leader,trick:[],trickClassIds:[],tricksWon:{NS:0,EW:0},phase:"awaitUser",rng:{seed:e.rngSeed>>>0,counter:0},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},preferredDiscards:hn(e),preferredDiscardUsed:{},replay:{enabled:!1,transcript:null,cursor:0,divergenceIndex:null,forcedCard:null,forcedClassId:null}};return Re(a.hands)?a.phase="end":a.phase=Se(a)?"awaitUser":"auto",a}function A(e){if(e.phase==="end")return[];const t=e.hands[e.turn],n=e.trick[0]?.suit,r=n?t[n]??[]:[],s=n&&r.length>0?[n]:st,i=[];for(const a of s){const l=t[a]??[];for(const o of l)i.push({seat:e.turn,suit:a,rank:o})}return i}function mn(e,t){const n=an(e),r=[];if(n.phase==="end")return r.push({type:"illegal",reason:"Hand already complete"}),{state:n,events:r};if(t.seat!==n.turn)return r.push({type:"illegal",reason:`Expected turn ${n.turn}, got ${t.seat}`}),n.phase=Se(n)?"awaitUser":"auto",{state:n,events:r};if(!A(n).some(a=>a.seat===t.seat&&a.suit===t.suit&&a.rank===t.rank))return r.push({type:"illegal",reason:`Illegal play ${t.seat}:${t.suit}${t.rank}`}),n.phase=Se(n)?"awaitUser":"auto",{state:n,events:r};for(r.push(...pt(n,t,"played"));!Se(n)&&!Re(n.hands);){n.phase="auto";const a=n.policies[n.turn];if(!a){r.push({type:"illegal",reason:`No policy configured for auto seat ${n.turn}`});break}const l=Cn(n,a);if(!l.play){const o=A(n);r.push({type:"illegal",reason:`Autoplay failed for ${n.turn} (policy=${a?.kind??"none"}, legal=${o.length}${l.replay?.reason?`, replay=${l.replay.reason}`:""})`});break}r.push(...pt(n,l.play,"autoplay",l.preferredDiscard,l.chosenBucket,l.bucketCards,l.policyClassByCard,l.tierBuckets,l.decisionSig,l.replay))}return Re(n.hands)?(n.phase="end",{state:n,events:r}):(n.phase=Se(n)?"awaitUser":"auto",{state:n,events:r})}function gn(e,t){return t.E.busy.has(e)||t.W.busy.has(e)}function kn(e,t){if(!t.threatCardIds.includes(e))return!1;const{suit:n}=e.length>=2?{suit:e[0]}:{suit:"S"},r=t.threatsBySuit[n];return!!(r?.active&&r.threatCardId===e)}function bn(e,t,n){const{suit:r}=e.length>=2?{suit:e[0]}:{suit:"S"},s=t.threatsBySuit[r];if(!s||!s.active||s.threatCardId!==e)return!1;const i=[...n.E.busy].some(l=>l.startsWith(r)),a=[...n.W.busy].some(l=>l.startsWith(r));return!i&&!a}function Sn(e,t,n,r){return r?bn(e,t,n)?"purple":kn(e,t)?"green":gn(e,n)?"blue":"black":"black"}function $n(e,t){const n=e.triedByIdx.get(t.index)??new Set;n.add(t.chosenAltClassId||t.chosenClassId),e.triedByIdx.set(t.index,n);const r=e.recordedRemainingByIdx.get(t.index)??new Set;for(const i of t.sameBucketAlternativeClassIds)r.add(i);e.recordedRemainingByIdx.set(t.index,r);const s=e.representativeByIdx.get(t.index)??new Map;for(const[i,a]of Object.entries(t.representativeCardByClass))s.set(i,a);s.set(t.chosenAltClassId||t.chosenClassId,t.chosenCard),e.representativeByIdx.set(t.index,s)}function Wt(e,t,n){const r=[...e.recordedRemainingByIdx.keys()].sort((i,a)=>i-a),s=[];for(const i of r){if(t&&!t.has(i)||typeof n=="number"&&i>=n)continue;const a=e.recordedRemainingByIdx.get(i)??new Set,l=e.triedByIdx.get(i)??new Set,o=[...a].filter(u=>!l.has(u)).sort();o.length>0&&s.push({index:i,remainingKeys:o})}return s}const In={id:"p001",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:[],H:[],D:["A","K","Q"],C:[]},S:{S:["5"],H:[],D:["2"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8"]},xn={id:"p002",contract:{strain:"C"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:7},hands:{N:{S:["A","Q","9","5","4"],H:["A","K","2"],D:[],C:[]},W:{S:["J","T","8"],H:["Q","T","8"],D:["A","Q"],C:[]},E:{S:["K","7","6"],H:["J","9","7"],D:["K","J"],C:[]},S:{S:[],H:["4","3"],D:["6","5","4"],C:["T","9","8"]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},threatCardIds:["S9","H2","D5"],preferredDiscards:{W:"DA",E:"H7"},rngSeed:202},En={id:"p003",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:3},hands:{N:{S:["A","8"],H:["8"],D:[],C:[]},E:{S:["Q","T"],H:[],D:["A"],C:[]},S:{S:["5"],H:[],D:["8"],C:["A"]},W:{S:["K","J"],H:["A"],D:[],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:101,threatCardIds:["H8","S8","D8"]},An={id:"p004",contract:{strain:"NT"},leader:"S",userControls:["N","S"],goal:{type:"minTricks",side:"NS",n:5},hands:{N:{S:["8"],H:["A","8"],D:["5"],C:["3","2"]},E:{S:[],H:["Q","T"],D:["Q","T","6"],C:["4"]},S:{S:[],H:["5"],D:["A","K","8"],C:["A","K"]},W:{S:["A"],H:["K","J"],D:["J","9","7"],C:[]}},policies:{E:{kind:"threatAware"},W:{kind:"threatAware"}},rngSeed:404,threatCardIds:["S8","H8","D8"]},me=[{id:"p001",label:"p001",problem:In},{id:"p002",label:"p002",problem:xn},{id:"p003",label:"p003",problem:En},{id:"p004",label:"p004",problem:An}],Dt=document.querySelector("#app");if(!Dt)throw new Error("Missing #app");const P=Dt,ce=["N","E","S","W"],Ae=["S","H","D","C"],q=["A","K","Q","J","T","9","8","7","6","5","4","3","2"],Tt={S:"♠",H:"♥",D:"♦",C:"♣"},Bn={N:"North",E:"East",S:"South",W:"West"},vn={strict:"Strict",sameLevel:"Same level",allBusy:"All busy"},ht=Math.max(...me.flatMap(({problem:e})=>ce.flatMap(t=>Ae.map(n=>e.hands[t][n].length)))),wn=12,Nn=4,Ln=9,Wn=4,Dn=4,Tn=6,at=17,Rn=16,Pn=3,On=16,Hn=Math.round(at*.6),jn=Math.round(at*.6),Un=wn+Nn+ht*Ln+Math.max(0,ht-1)*Wn+Dn,Rt=Rn+Pn+at*4+On+Tn,Pt=Rt+6;P.style.setProperty("--hand-box-w",`${Un}px`);P.style.setProperty("--hand-box-h",`${Rt}px`);P.style.setProperty("--trick-box-w",`${Pt}px`);P.style.setProperty("--trick-box-h",`${Pt}px`);P.style.setProperty("--table-gap-y",`${Hn}px`);P.style.setProperty("--table-gap-x",`${jn}px`);P.style.setProperty("--slot-offset","12%");const it="sameLevel";let z=me[0].problem,_=me[0].id,W=z.rngSeed>>>0,C=Ue({...z,rngSeed:W}),y=[],V=[],M=!1,Qe=!0,Me=!0,Pe=!0,Oe=!1,Ie=null,ze=null,v=!1,pe=null,ae=null,te=!1,he=null,ye=null;const Be=[];let X=[],T=null;const G={triedByIdx:new Map,recordedRemainingByIdx:new Map,representativeByIdx:new Map};let se=[],Ce=[],O="running",E=!1,R=null,Q=null,de=0,ee=null,ge=!1;const Ve=new Map,Le=new Map,xe=new Map;let Je=!1;Ge(C);function U(){Ie&&(clearTimeout(Ie),Ie=null),ze=null}function Gn(e){const t=new Map(q.map((n,r)=>[n,r]));return[...e].sort((n,r)=>(t.get(n)??99)-(t.get(r)??99))}function ue(e){return`${e.seat}:${e.suit}${Ht(e.rank)}`}function Ot(e){return{hands:e.hands}}function Kn(e){return Array.isArray(e.threatCardIds)?[...e.threatCardIds]:[]}function Ht(e){return e==="T"?"10":e}function _e(e){if(!he||!ye)return"rank--black";const t=Sn(e,he,ye,Pe);return t==="purple"?"rank--purple":t==="green"?"rank--green":t==="blue"?"rank--blue":"rank--black"}function Xe(e,t,n,r=!1){const s=document.createElement("span");if(s.className=`rank ${n}${r?" eq-underline":""}`,t!=="T"){s.textContent=Ht(t),e.appendChild(s);return}const i=document.createElement("span");i.className=`rank ten ${n}${r?" eq-underline":""}`;const a=document.createElement("span");a.className="digit-one",a.textContent="1";const l=document.createElement("span");l.className="digit-zero",l.textContent="0",i.append(a,l),e.appendChild(i)}function qn(e){return e.type==="played"?`played ${ue(e.play)}`:e.type==="autoplay"?`autoplay ${ue(e.play)}`:e.type==="illegal"?`illegal ${e.reason}`:e.type==="trickComplete"?`trickComplete winner=${e.winner} trick=${e.trick.map(ue).join(" ")}`:`handComplete success=${e.success} NS=${e.tricksWon.NS} EW=${e.tricksWon.EW}`}function Mn(e){return e==="N"||e==="S"?"NS":"EW"}function Yn(e){const t=ce.indexOf(e);return ce[(t+1)%ce.length]}function ie(e){return{...e,contract:{...e.contract},threat:e.threat?{threatCardIds:[...e.threat.threatCardIds],threatsBySuit:{...e.threat.threatsBySuit}}:null,hands:{N:{S:[...e.hands.N.S],H:[...e.hands.N.H],D:[...e.hands.N.D],C:[...e.hands.N.C]},E:{S:[...e.hands.E.S],H:[...e.hands.E.H],D:[...e.hands.E.D],C:[...e.hands.E.C]},S:{S:[...e.hands.S.S],H:[...e.hands.S.H],D:[...e.hands.S.D],C:[...e.hands.S.C]},W:{S:[...e.hands.W.S],H:[...e.hands.W.H],D:[...e.hands.W.D],C:[...e.hands.W.C]}},trick:e.trick.map(t=>({...t})),trickClassIds:[...e.trickClassIds],tricksWon:{...e.tricksWon},rng:{...e.rng},goal:{...e.goal},userControls:[...e.userControls],policies:{...e.policies},threatLabels:e.threatLabels?{E:{busy:new Set(e.threatLabels.E.busy),idle:new Set(e.threatLabels.E.idle)},W:{busy:new Set(e.threatLabels.W.busy),idle:new Set(e.threatLabels.W.idle)}}:null,cardRoles:{...e.cardRoles},preferredDiscards:{N:e.preferredDiscards.N?[...e.preferredDiscards.N]:void 0,E:e.preferredDiscards.E?[...e.preferredDiscards.E]:void 0,S:e.preferredDiscards.S?[...e.preferredDiscards.S]:void 0,W:e.preferredDiscards.W?[...e.preferredDiscards.W]:void 0},preferredDiscardUsed:{...e.preferredDiscardUsed},replay:e.replay.transcript?{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:{problemId:e.replay.transcript.problemId,seed:e.replay.transcript.seed,decisions:e.replay.transcript.decisions.map(t=>({...t,bucketCards:[...t.bucketCards],sameBucketAlternativeClassIds:[...t.sameBucketAlternativeClassIds],representativeCardByClass:{...t.representativeCardByClass}})),userPlays:e.replay.transcript.userPlays.map(t=>({...t}))}}:{enabled:e.replay.enabled,cursor:e.replay.cursor,divergenceIndex:e.replay.divergenceIndex,forcedCard:e.replay.forcedCard,forcedClassId:e.replay.forcedClassId,transcript:null}}}function jt(e){return e?{threatCardIds:[...e.threatCardIds],threatsBySuit:{...e.threatsBySuit}}:null}function Ut(e){return e?{E:{busy:new Set(e.E.busy),idle:new Set(e.E.idle)},W:{busy:new Set(e.W.busy),idle:new Set(e.W.idle)}}:null}function Gt(e){return e?e.map(t=>({...t})):null}function Fn(e){return{state:ie(C),currentProblemId:_,currentSeed:W,logs:[...y],deferredLogLines:[...V],trickFrozen:v,lastCompletedTrick:Gt(pe),frozenViewState:ae?ie(ae):null,canLeadDismiss:te,threatCtx:jt(he),threatLabels:Ut(ye),play:{...e},runStatus:O,playAgainAvailable:E,playAgainUnavailableReason:R,playAgainLastCandidateIndex:Q,replaySuppressedForRun:ge}}function Qn(e){C=ie(e.state),_=e.currentProblemId,z=me.find(t=>t.id===_)?.problem??z,W=e.currentSeed,y=[...e.logs],V=[...e.deferredLogLines],v=e.trickFrozen,pe=Gt(e.lastCompletedTrick),ae=e.frozenViewState?ie(e.frozenViewState):null,te=e.canLeadDismiss,he=jt(e.threatCtx),ye=Ut(e.threatLabels),O=e.runStatus,E=e.playAgainAvailable,R=e.playAgainUnavailableReason,Q=e.playAgainLastCandidateIndex,ge=e.replaySuppressedForRun}function ot(){xe.clear(),Je=!1}function zn(){if(!M||Je||xe.size===0)return;const e=[...xe.values()].sort((t,n)=>t.idx-n.idx||(t.seat<n.seat?-1:t.seat>n.seat?1:0));y=[...y,"","================= DEFENDER EQ (initial snapshot, first EQCs observed) =================",...e.map(t=>`idx=${t.idx} seat=${t.seat} bucket=${t.bucket} classes={${t.classes.join(",")}} remaining={${t.remaining.join(",")}} chosen=${t.chosen}`),"=========================================================================================",""].slice(-500),Je=!0}function Vn(e,t){const n=[];for(const r of Ae)for(const s of je(e,t,r))n.push(`${r}${s.join("")}`);return n}function Ge(e){Ve.clear(),Le.clear();for(const t of e.userControls)for(const n of Ae){const r=je(e,t,n);for(const s of r){if(s.length===0)continue;const i=g(n,s[0]),l=D(e,t,i).classId;Le.has(l)||Le.set(l,i);for(const o of s){const u=g(n,o);Ve.set(u,l)}}}}function We(e,t){return e!=="N"&&e!=="S"?D(C,e,t).classId:Ve.get(t)??D(C,e,t).classId}function Jn(e,t){return Le.get(e)??t}function _n(e){const t=["","================= USER EQ (initial) ================="];for(const n of e.userControls){const r=Vn(e,n);t.push(`seat=${n} classes: ${r.join("  ")||"-"}`)}return t.push("====================================================="),t.push(""),t}function Kt(e,t,n){if(t.play.seat!=="E"&&t.play.seat!=="W"||!t.decisionSig)return null;const r=g(t.play.suit,t.play.rank),s=t.bucketCards?[...t.bucketCards]:[r],i=t.policyClassByCard??{},a=t.chosenBucket??"unknown",l=t.tierBuckets??{};let o=[...s];if((a.startsWith("tier2")||a.startsWith("tier3"))&&it!=="strict"){const f=[`tier${a.startsWith("tier2")?"2":"3"}a`,`tier${a.startsWith("tier2")?"2":"3"}b`],p=[];for(const k of f)for(const N of l[k]??[])p.includes(N)||p.push(N);p.length>0&&(o=p)}const u=f=>{if(a.startsWith("tier1"))return"idle:tier1";if(a.startsWith("tier2")||a.startsWith("tier3"))return`busy:${f[0]}`;if(a==="tier4")return`other:${f[0]}`;const p=i[f];return p||D(e,t.play.seat,f).classId},c=[],d=u(r);for(const f of o){const p=u(f);c.includes(p)||c.push(p)}const h=c.filter(f=>f!==d);return{idx:n,seat:t.play.seat,bucket:a,classes:c,remaining:h,chosen:d,eqByTier:er(e,t)}}function De(e){const t={S:0,H:1,D:2,C:3};return[...e].sort((n,r)=>{const s=q.indexOf(n[1]),i=q.indexOf(r[1]);return s!==i?s-i:t[n[0]]-t[r[0]]})}function yt(e){const n=["tier1a","tier1b","tier1c","tier2a","tier2b","tier3a","tier3b","tier4","follow:below","follow:above","follow:baseline","lead:none","legal","preferred"].indexOf(e);return n>=0?n:999}function Xn(e){return e.startsWith("tier")?e.slice(4):e.startsWith("follow:")?e.slice(7):e==="lead:none"?"lead":e}function Zn(e,t){const n=new Map,r=A(e).filter(a=>a.seat===t.play.seat).map(a=>g(a.suit,a.rank)),s=e.trick[0]?.suit??null;if(!s){for(const a of r)n.set(a,"lead:none");return n}if(e.hands[e.turn][s].length===0&&e.threat&&e.threatLabels){const a=rt(e.turn,Ot(e),s,e.threat,e.threatLabels),l=[["tier1a",a.tier1a],["tier1b",a.tier1b],["tier1c",a.tier1c],["tier2a",a.tier2a],["tier2b",a.tier2b],["tier3a",a.tier3a],["tier3b",a.tier3b],["tier4",a.tier4]];for(const[o,u]of l)for(const c of u)n.has(c)||n.set(c,o);return n}if(e.hands[e.turn][s].length>0){const a=A(e).filter(o=>o.seat===e.turn).map(o=>g(o.suit,o.rank));if(!e.threat||!e.threatLabels){for(const o of a)n.set(o,"follow:baseline");return n}const l=Ee(s,e.threat,e.threatLabels);if(!l){for(const o of a)n.set(o,"follow:baseline");return n}for(const o of a){const u=o[1];n.set(o,q.indexOf(u)>q.indexOf(l)?"follow:below":"follow:above")}return n}for(const a of r)n.set(a,t.chosenBucket??"unknown");return n}function er(e,t){const n=Zn(e,t),r=new Map;for(const[d,h]of n.entries()){let f=t.policyClassByCard?.[d];f||(h.startsWith("tier1")?f="idle:tier1":h.startsWith("tier2")||h.startsWith("tier3")?f=`busy:${d[0]}`:h==="tier4"?f=`other:${d[0]}`:f=D(e,t.play.seat,d).classId);const p=r.get(f)??new Map,k=p.get(h)??[];k.push(d),p.set(h,k),r.set(f,p)}const s=["busy:S","busy:H","busy:D","busy:C"],i=[...r.entries()],a=i.find(([d])=>d.startsWith("idle")),l=s.map(d=>i.find(([h])=>h===d)).filter(d=>!!d),o=i.filter(([d])=>!d.startsWith("idle")&&!s.includes(d)).sort((d,h)=>d[0].localeCompare(h[0])),u=(d,h)=>{const f=[...h.entries()].sort((p,k)=>yt(p[0])-yt(k[0])).map(([p,k])=>`${Xn(p)}:{${De(k).join(" ")}}`).join(" ");return`${d}(${f})`},c=[];a?c.push(u(a[0],a[1])):c.push("idle:None");for(const[d,h]of[...l,...o])c.push(u(d,h));return c.join(", ")}function tr(e,t){const n=e[1];return q.indexOf(n)>q.indexOf(t)}function nr(e){const t=e.threat,n=e.threatLabels,r=[],s=["E","W"],i=["C","D","H","S"],a=["S","H","D","C"],l=["tier2a","tier2b","tier3a","tier3b"];for(const o of s){const u=a.filter(f=>!!t?.threatsBySuit[f]),c=[];for(const f of i){if(u.includes(f))continue;const p=De(e.hands[o][f].map(k=>g(f,k)));p.length>0&&c.push(`idle:${f}{${p.join(" ")}}`)}const d=c.length>0?c.join(" "):"idle:(None)",h=[];for(const f of u){const p=De(e.hands[o][f].map(b=>g(f,b)));if(p.length===0){h.push(`busy:${f}(None)`);continue}const k=t&&n?Ee(f,t,n):null,m=t?.threatsBySuit[f]?.stopStatus==="double"?"2":"3",$=new Map;for(const b of p){const I=k&&tr(b,k)?`tier${m}a`:`tier${m}b`,j=$.get(I)??[];j.push(b),$.set(I,j)}const S=l.filter(b=>($.get(b)?.length??0)>0).map(b=>`${b.slice(4)}:{${De($.get(b)??[]).join(" ")}}`);h.push(`busy:${f}(${S.join(" ")||"None"})`)}r.push(`seat=${o} | ${d} | ${h.join(" | ")||"busy:(None)"}`)}return["","================= DEFENDER INVENTORY EQ (initial) =================",...r,"===================================================================",""]}function He(e,t){if(t.type==="played"||t.type==="autoplay"){const n=g(t.play.suit,t.play.rank),r=D(e,t.play.seat,n).classId,s=e.hands[t.play.seat][t.play.suit],i=s.indexOf(t.play.rank);if(i>=0&&s.splice(i,1),e.trick.push({...t.play}),e.trickClassIds.push(`${t.play.seat}:${r}`),e.threat&&e.threatLabels){const a=xt({threat:e.threat,labels:e.threatLabels,perCardRole:e.cardRoles},{hands:e.hands},g(t.play.suit,t.play.rank));e.threat=a.threat,e.threatLabels=a.labels,e.cardRoles={...a.perCardRole}}e.turn=Yn(e.turn);return}if(t.type==="trickComplete"){e.trick=[],e.trickClassIds=[],e.leader=t.winner,e.turn=t.winner,e.tricksWon[Mn(t.winner)]+=1;return}t.type==="handComplete"&&(e.phase="end",e.tricksWon={...t.tricksWon})}function Ye(e,t,n,r){const s=[],i=ie(e);for(const a of n){if(a.type==="played"||a.type==="autoplay"){de>0&&s.push(""),de+=1,s.push(`----- PLAY ${de} -----`);const l=g(a.play.suit,a.play.rank);let o=`play ${a.play.seat}:${l} (${a.type==="played"?"user":"auto"})`;if(a.type==="played"){const u=We(a.play.seat,l);o+=` | eq=${u}`}else{const u=Kt(i,a,-1);if(u)o+=` | eq=${u.chosen} (card=${l}; bucket=${u.bucket}; remaining=${u.remaining.join(",")||"-"})`;else{const c=D(i,a.play.seat,l).classId;o+=` | eq=${c}${a.chosenBucket?` (card=${l}; bucket=${a.chosenBucket})`:""}`}}s.push(o)}if(M&&a.type==="autoplay"){if(a.replay?.action==="forced"&&s.push(`[PLAYAGAIN] forcing index=${a.replay.index??"?"} card=${a.replay.card??`${a.play.suit}${a.play.rank}`}`),a.replay?.action==="disabled"&&(a.replay.reason==="class-not-legal"?s.push(`[PLAYAGAIN] force failed idx=${a.replay.index??"?"} forcedClass=${a.replay.forcedClassId??"-"} reason=class-not-legal; continuing unforced`):s.push(`[PLAYAGAIN] replay disabled due to ${a.replay.reason??"mismatch"}`)),a.preferredDiscard){const o=a.preferredDiscard;o.applied&&o.chosen?s.push(`[PREFDISC] seat=${a.play.seat} applied preferred discard=${o.chosen}`):s.push(`[PREFDISC] seat=${a.play.seat} preferred=${o.preferred.join("/")} not-applied reason=${o.reason}`)}if(i.policies[i.turn]?.kind==="threatAware"&&i.trick.length>0&&i.hands[i.turn][i.trick[0].suit].length>0){const o=i.trick[0].suit,u=A(i).map(d=>`${d.suit}${d.rank}`),c=i.threat&&i.threatLabels?Ee(o,i.threat,i.threatLabels):null;if(c){const d=A(i).filter(f=>q.indexOf(f.rank)>q.indexOf(c)),h=A(i).filter(f=>q.indexOf(f.rank)<=q.indexOf(c));s.push(`[THREAT] follow seat=${i.turn} ledSuit=${o} threshold=${c} inSuit=${u.length} chosen=${a.play.suit}${a.play.rank} below=${d.length} above=${h.length}`)}else s.push(`[THREAT] follow seat=${i.turn} ledSuit=${o} threshold=- inSuit=${u.length} chosen=${a.play.suit}${a.play.rank} mode=baseline`)}if((i.turn==="E"||i.turn==="W")&&i.trick.length>0&&i.hands[i.turn][i.trick[0].suit].length===0&&i.threat&&i.threatLabels){const o=i.trick[0].suit,u=i.threat,c=i.threatLabels,d=rt(i.turn,Ot(i),o,u,c),h=[["t2a",d.tier2a.length],["t2b",d.tier2b.length],["t3a",d.tier3a.length],["t3b",d.tier3b.length]].filter(([,f])=>f>0).map(([f,p])=>`${f}:${p}`).join(" ");s.push(`[THREAT] discard seat=${i.turn} ledSuit=${o} legal=${d.legal.length} chosen=${a.play.suit}${a.play.rank} bucket=${a.chosenBucket??"-"} tiers=${h||"-"}`)}}if((a.type==="illegal"||a.type==="handComplete")&&s.push(qn(a)),He(i,a),M&&a.type==="illegal"){const l=i.trick[0]?.suit??"none",o=A(i).slice(0,10).map(ue).join(" ");s.push(`illegalContext attempted=${ue(t)} turn=${i.turn} leadSuit=${l} legal=${o||"-"}`)}a.type==="trickComplete"&&(s.push(`----- TRICK COMPLETE ----- winner=${a.winner} trick=${a.trick.map(ue).join(" ")}`),s.push(""))}return s}function rr(e,t){const n=ie(e);for(const r of t){if(r.type==="autoplay"&&(r.play.seat==="E"||r.play.seat==="W")&&r.decisionSig){const s=Kt(n,r,X.length);if(!s){He(n,r);continue}const i=g(r.play.suit,r.play.rank),a=D(n,r.play.seat,i).classId,l=s.chosen,o=[...s.classes],u=[...s.remaining],c=r.bucketCards?[...r.bucketCards]:[i],d={};for(const S of c){const b=r.policyClassByCard?.[S]??D(n,r.play.seat,S).classId;d[b]||(d[b]=S)}o.includes(l)&&(d[l]=i);const h=r.replay?.action==="forced"&&n.replay.transcript&&typeof r.replay.index=="number"?n.replay.transcript.decisions[r.replay.index]:null,f=[...s.remaining],p=null;if(h&&h.seat===r.play.seat){const S=[h.chosenAltClassId??h.chosenClassId,...h.sameBucketAlternativeClassIds].filter((b,I,j)=>b&&j.indexOf(b)===I);o.splice(0,o.length,...S);for(const[b,I]of Object.entries(h.representativeCardByClass))d[b]=I;if(o.includes(l)||o.push(l),d[l]=i,M&&(f&&f.join(",")!==h.sameBucketAlternativeClassIds.join(",")||!f&&p)){const b=f?f.join(",")||"-":"unavailable:unknown";y=[...y,`[EQC:replay] idx=${r.replay.index} recordedRemaining=${h.sameBucketAlternativeClassIds.join(",")||"-"} runtimeRemaining=${b}`].slice(-500)}}const k=c.filter(S=>(r.policyClassByCard?.[S]??D(n,r.play.seat,S).classId)===l);M&&(y=[...y,`[EQC] idx=${X.length} seat=${r.play.seat} scope=${it} bucket=${s.bucket} classes=${o.join(",")||"-"} chosen=${l} covers=${k.join(",")||"-"} remaining=${u.join(",")||"-"}`].slice(-500));const N=X.length,m=r.play.seat,$=`${N}:${m}`;xe.has($)||xe.set($,{idx:N,seat:m,bucket:s.bucket,classes:[...o],remaining:[...u],chosen:l,eqByTier:s.eqByTier}),zn(),X.push({index:X.length,seat:r.play.seat,nodeKey:Ce.join(" > "),sig:r.decisionSig,chosenCard:i,chosenClassId:a,chosenAltClassId:l,chosenBucket:s.bucket,bucketCards:c,sameBucketAlternativeClassIds:o.filter(S=>S!==l),representativeCardByClass:d}),Ce.push(l)}He(n,r)}}function sr(e){const t=e.goal;return t.type==="minTricks"?`${t.side} ${t.n} tricks`:"Unknown goal"}function ar(){return v&&ae?ae:C}function ve(e){v=!1,pe=null,ae=null,te=!1,e&&V.length>0&&(y=[...y,...V].slice(-500),V=[])}function Ct(e,t){const n=ce.map(s=>`${s}:${Ae.map(i=>e.hands[s][i].join("")).join("/")}`).join("|"),r=e.trick.map(s=>`${s.seat}${s.suit}${s.rank}`).join(",");return`${e.phase}|${e.turn}|${e.leader}|${r}|${n}|${t.seat}${t.suit}${t.rank}`}function mt(){const n=C.userControls.includes(C.turn)&&(!v&&C.phase==="awaitUser"||v&&te&&C.phase!=="end");if(!Oe||!n){U();return}const r=A(C).filter(a=>a.seat===C.turn);if(r.length!==1){U();return}const s=r[0],i=Ct(C,s);Ie&&ze===i||(U(),ze=i,Ie=setTimeout(()=>{const o=C.userControls.includes(C.turn)&&(!v&&C.phase==="awaitUser"||v&&te&&C.phase!=="end");if(!Oe||!o){U();return}const u=A(C).filter(d=>d.seat===C.turn);if(u.length!==1){U();return}const c=u[0];if(Ct(C,c)!==i){U();return}U(),qt(c)},500))}function Ke(e,t){t&&(y=[]);const n=Kn(z);he=C.threat??null,ye=C.threatLabels??null,n.length!==0&&M&&(y=[...y,`[THREAT:init] problem=${e} raw=${n.join(",")} validation=OK`].slice(-500),y=[...y,..._n(C)].slice(-500),y=[...y,...nr(C)].slice(-500))}function gt(e,t){U();const n=e>>>0;n!==W>>>0&&(G.triedByIdx.clear(),G.recordedRemainingByIdx.clear(),G.representativeByIdx.clear()),W=n,C=Ue({...z,rngSeed:W}),y=[...y,`${t} seed=${W}`].slice(-500),O="running",de=0,ee=null,ge=!1,E=!1,R=null,Q=null,X=[],se=[],Ce=[],Ge(C),ot(),Be.length=0,V=[],ve(!1),Ke(_,!1),w()}function ir(e){U();const t=me.find(n=>n.id===e);t&&(z=t.problem,_=t.id,W=z.rngSeed>>>0,C=Ue({...z,rngSeed:W}),O="running",de=0,ee=null,ge=!1,E=!1,R=null,Q=null,X=[],se=[],Ce=[],Ge(C),ot(),T=null,G.triedByIdx.clear(),G.recordedRemainingByIdx.clear(),G.representativeByIdx.clear(),Be.length=0,V=[],ve(!1),Ke(_,!0),w())}function or(){U();const e=Be.pop();e&&(Qn(e),y=[...y,`[UNDO] restored snapshot before user play: ${e.play.seat}:${g(e.play.suit,e.play.rank)}`].slice(-500),w())}function qt(e){if(U(),C.replay.enabled&&C.replay.transcript&&(e.seat==="N"||e.seat==="S")){const i=g(e.suit,e.rank),a=We(e.seat,i),l=C.replay.transcript.userPlays[se.length];if(l&&l.playClassId!==a){const o=C.replay.cursor;C.replay.enabled=!1,ge=!0,y=[...y,`[PLAYAGAIN] user diverged at decisionIdx=${o} expectedClass=${l.playClassId} actualClass=${a}; continuing without forcing further decisions`].slice(-500)}else if(M){const o=We(e.seat,i),u=Jn(o,i);y=[...y,`[EQ] seat=${e.seat} played=${i} class=${o} rep=${u}`].slice(-500)}}if(e.seat==="N"||e.seat==="S"){const i=g(e.suit,e.rank),a=We(e.seat,i);se.push({index:se.length,seat:e.seat,playClassId:a}),Ce.push(a)}Be.push(Fn(e)),v&&ve(!0);const t=C,n=mn(C,e);C=n.state,he=C.threat??null,ye=C.threatLabels??null;const r=n.events.findIndex(i=>i.type==="trickComplete");if(rr(t,n.events),r>=0){const i=n.events.slice(0,r+1),a=n.events.slice(r+1),l=ie(t);for(const c of i)He(l,c);v=!0,ae=l;const o=i[i.length-1];o.type==="trickComplete"&&(pe=o.trick.map(c=>({...c}))),te=C.phase!=="end"&&C.trick.length===0&&C.userControls.includes(C.turn);const u=Ye(t,e,i);if(y=[...y,...u].slice(-500),a.length>0){const c=Ye(l,e,a);V=[...V,...c].slice(-500)}}else{const i=Ye(t,e,n.events);y=[...y,...i].slice(-500)}const s=n.events.find(i=>i.type==="handComplete");if(s?.type==="handComplete"&&s.success){T={problemId:_,seed:W,decisions:X.map(o=>({...o,bucketCards:[...o.bucketCards],sameBucketAlternativeClassIds:[...o.sameBucketAlternativeClassIds],representativeCardByClass:{...o.representativeCardByClass}})),userPlays:se.map(o=>({...o}))},y=[...y,`[PLAYAGAIN] recorded transcript ${T.decisions.length} decisions`].slice(-500);for(const o of T.decisions)$n(G,o);const i=new Set(T.decisions.map(o=>o.index)),a=Wt(G,i,ee);E=a.length>0,R=E?null:ee!==null?"user-mismatch-exhausted":"exhausted-all-variations",Q=E?a[a.length-1].index:null;const l=E?(()=>{const o=a[a.length-1],u=o.remainingKeys[0]??"-",c=G.representativeByIdx.get(o.index)?.get(u)??"-";return`[PLAYAGAIN] offer available=true candidates=[${a.map(d=>d.index).join(",")}] chosenCandidate=${o.index} forcedClass=${u} forcedCard=${c} reason=endOfRunSuccess`})():null;y=[...y,`[PLAYAGAIN] candidates=[${a.map(o=>o.index).join(",")}] cutoffIdx=${ee??"-"}`,...a.map(o=>`[PLAYAGAIN] idx=${o.index} remainingUntried=${o.remainingKeys.length} keys=${o.remainingKeys.join(",")}`),...l?[l]:[],E?`[PLAYAGAIN] availability ok=true lastCandidateIndex=${Q}`:`[PLAYAGAIN] availability ok=false reason=${R}`].slice(-500)}if(s?.type==="handComplete"){const i=s.success?"success":"failure";M&&(y=[...y,`[GOAL] endOfRun=true NSwon=${s.tricksWon.NS} EWwon=${s.tricksWon.EW} required${C.goal.side}>=${C.goal.n} success=${s.success}`,`[RUNSTATUS] ${O} -> ${i}`].slice(-500)),O=i}w()}function lr(e="autoplay"){if(U(),!T){E=!1,R="exhausted-all-variations",Q=null,y=[...y,`[PLAYAGAIN] availability ok=false reason=${R}`].slice(-500),w();return}const t=new Set(T.decisions.map(c=>c.index)),n=Wt(G,t,ee);if(E=n.length>0,R=E?null:ee!==null?"user-mismatch-exhausted":"exhausted-all-variations",Q=E?n[n.length-1].index:null,y=[...y,`[PLAYAGAIN] candidates=[${n.map(c=>c.index).join(",")}] cutoffIdx=${ee??"-"}`,...n.map(c=>`[PLAYAGAIN] idx=${c.index} remainingUntried=${c.remainingKeys.length} keys=${c.remainingKeys.join(",")}`)].slice(-500),E){const c=n[n.length-1],d=c.remainingKeys[0]??"-",h=G.representativeByIdx.get(c.index)?.get(d)??"-";y=[...y,`[PLAYAGAIN] offer available=true candidates=[${n.map(f=>f.index).join(",")}] chosenCandidate=${c.index} forcedClass=${d} forcedCard=${h} reason=${e==="manual"?"manualRequest":"other"}`].slice(-500)}if(!E){y=[...y,`[PLAYAGAIN] availability ok=false reason=${R}`].slice(-500),w();return}const r=T?.seed??W;C=Ue({...z,rngSeed:r});let s=null,i=null,a=null;const l=[];for(const c of n)c.remainingKeys.length>0&&l.push(`[EQC:playagain] idx=${c.index} remaining=${c.remainingKeys.join(",")||"-"}`);const o=n[n.length-1];if(s=o.index,i=o.remainingKeys[0]??null,i&&(a=G.representativeByIdx.get(s)?.get(i)??null,y=[...y,`[PLAYAGAIN] candidates=[${n.map(d=>d.index).join(",")}] chosen=${s}`].slice(-500),y=[...y,`[PLAYAGAIN] divergenceIndex=${s} forcedClass=${i} forcedCard=${a??"-"}`].slice(-500)),M&&(y=[...y,"----- PLAY AGAIN COVERAGE -----",...l.length>0?l:["[EQC:playagain] none"]].slice(-500)),!i||s===null){E=!1,R="exhausted-all-variations",Q=null,y=[...y,`[PLAYAGAIN] availability ok=false reason=${R}`].slice(-500),w();return}y=[...y,`[PLAYAGAIN] ${e==="manual"?"manual":"autoplay"} selected=true source=${e==="manual"?"uiClick":"other"} -> starting replay divergenceIdx=${s} forcedClass=${i} forcedCard=${a??"-"}`].slice(-500),C.replay={enabled:!0,transcript:{problemId:T.problemId,seed:T.seed,decisions:T.decisions.map(c=>({...c,bucketCards:[...c.bucketCards],sameBucketAlternativeClassIds:[...c.sameBucketAlternativeClassIds],representativeCardByClass:{...c.representativeCardByClass}})),userPlays:T.userPlays.map(c=>({...c}))},cursor:0,divergenceIndex:s,forcedCard:a,forcedClassId:i},W=r,O="running",de=0,ge=!1,E=!1,R=null,Q=null,X=[],se=[],Ce=[],Ge(C),ot(),V=[],ve(!1);const u=[];for(const c of T.decisions){const d=[c.chosenAltClassId??c.chosenClassId,...c.sameBucketAlternativeClassIds].filter((f,p,k)=>!!f&&k.indexOf(f)===p);if(d.length<2)continue;const h=c.index===s?` FORCING=${i}`:"";u.push(`[PLAYAGAIN] idx=${c.index} seat=${c.seat} nodeKey=${c.nodeKey||"-"} avail={${d.join(",")}} chosen=${c.chosenAltClassId} remaining={${c.sameBucketAlternativeClassIds.join(",")||"-"}}${h}`)}y=[...y,`[PLAYAGAIN] replayStart plan divergenceIdx=${s} forcedClass=${i} forcedCard=${a??"-"} source=${e}`,...u,`===== PLAY AGAIN REPLAY ===== divergenceIdx=${s} forced=${a??"-"} forcedClass=${i}`,"[PLAYAGAIN] replay enabled",""].slice(-500),Ke(_,!1),w()}function cr(e,t,n,r,s){const i=document.createElement("div");i.className="suit-row";const a=document.createElement("span");a.className=`suit-symbol suit-${n}`,a.textContent=Tt[n],i.appendChild(a);const l=document.createElement("div");l.className="cards";const o=Gn(e.hands[t][n]),u=new Set;if(Pe){for(const c of je(e,t,n))if(c.length>1)for(const d of c)u.add(d)}if(o.length>0)for(const c of o){const d=`${n}${c}`,h=s&&r.has(d),f=u.has(c);if(h){const p=document.createElement("button");p.type="button",p.className="rank-text legal",Xe(p,c,_e(g(n,c)),f),p.onclick=()=>qt({seat:t,suit:n,rank:c}),l.appendChild(p)}else{const p=document.createElement("span");p.className="rank-text muted",Xe(p,c,_e(g(n,c)),f),l.appendChild(p)}}return i.appendChild(l),i}function Ne(e,t){const n=document.createElement("section"),r=e.turn===t;n.className=`hand seat-${t}`;const s=document.createElement("div");s.className="hand-head",s.innerHTML=`<strong class="seat-name${r?" active-seat-name":""}">${Bn[t]}</strong>`,n.appendChild(s);const i=!v&&r?A(e):[],a=new Set(i.map(u=>`${u.suit}${u.rank}`)),l=!v&&e.phase!=="end"&&e.userControls.includes(t)&&r;if(v&&te&&C.userControls.includes(C.turn)&&t===C.turn){const u=A(C);for(const c of u)a.add(`${c.suit}${c.rank}`)}const o=l||v&&te&&t===C.turn;for(const u of Ae)n.appendChild(cr(e,t,u,a,o));return n}function dr(e){const t=document.createElement("section");t.className=`trick-table${v?" frozen":""}`,v&&(t.title="Click to dismiss trick",t.onclick=()=>{ve(!0),w()});const n=v&&pe?pe:e.trick,r=new Map(n.map(s=>[s.seat,s]));for(const s of ce){const i=document.createElement("div");i.className=`trick-slot slot-${s}`;const a=r.get(s);if(a){const l=document.createElement("span");l.className="played-text";const o=document.createElement("span");o.className=`played-suit suit-${a.suit}`,o.textContent=Tt[a.suit];const u=document.createElement("span");u.className="played-rank",Xe(u,a.rank,_e(g(a.suit,a.rank))),l.append(o,u),i.appendChild(l)}t.appendChild(i)}return t}function ur(e){const t=document.createElement("section");t.className="status-panel";const n=document.createElement("div");n.className="status-head";const r=document.createElement("strong");r.textContent="Status",n.appendChild(r);const s=document.createElement("div");s.className="controls";const i=document.createElement("button");i.type="button",i.textContent="Reset",i.onclick=()=>gt(W,"reset"),s.appendChild(i);const a=document.createElement("button");a.type="button",a.textContent="Backup",a.disabled=Be.length===0,a.onclick=()=>or(),s.appendChild(a);const l=document.createElement("button");l.type="button",l.textContent="New seed",l.onclick=()=>gt(Date.now()>>>0,"newSeed"),s.appendChild(l);const o=document.createElement("label"),u=document.createElement("input");u.type="checkbox",u.checked=Qe,u.onchange=()=>{Qe=u.checked,w()},o.append(u," Show log"),s.appendChild(o);const c=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=M,d.onchange=()=>{M=d.checked,w()},c.append(d," Verbose log"),s.appendChild(c),n.appendChild(s),t.appendChild(n);const h=document.createElement("div");return h.className="status-facts",h.innerHTML=`
    <div><span class="k">Contract</span><span class="v">${e.contract.strain}</span></div>
    <div><span class="k">Goal</span><span class="v">${sr(e)}</span></div>
    <div class="tricks"><span class="k">Tricks</span><span class="v heavy">NS ${e.tricksWon.NS} - EW ${e.tricksWon.EW}</span></div>
    <div class="meta-row"><span class="k">Leader</span><span class="v turn-meta">${e.leader}</span></div>
    <div class="meta-row"><span class="k">Turn</span><span class="v turn-meta turn-emph">${e.turn}</span></div>
    <div class="meta-row"><span class="k">Seed</span><span class="v seed">${W}</span></div>
    <div class="meta-row"><span class="k">Variations</span><span class="v turn-meta">${vn[it]}</span></div>
  `,t.appendChild(h),t}function w(){const e=ar();P.innerHTML="";const t=document.createElement("section");t.className="board-shell";const n=document.createElement("div");n.className="table-host";const r=document.createElement("div");r.className="table-tools";const s=document.createElement("label");s.textContent="Puzzle: ";const i=document.createElement("select");for(const f of me){const p=document.createElement("option");p.value=f.id,p.textContent=f.label,p.selected=f.id===_,i.appendChild(p)}i.onchange=()=>{ir(i.value)},s.appendChild(i),r.appendChild(s);const a=document.createElement("label"),l=document.createElement("input");l.type="checkbox",l.checked=Me,l.onchange=()=>{Me=l.checked,w()},a.append(l," Show guides"),r.appendChild(a);const o=document.createElement("label"),u=document.createElement("input");u.type="checkbox",u.checked=Pe,u.onchange=()=>{Pe=u.checked,w()},o.append(u," Teaching mode"),r.appendChild(o);const c=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.checked=Oe,d.onchange=()=>{Oe=d.checked,mt(),w()},c.append(d," Autoplay singletons"),r.appendChild(c),n.appendChild(r);const h=document.createElement("main");if(h.className=`table-canvas${Me?" show-guides":""}`,h.appendChild(dr(e)),h.appendChild(Ne(e,"N")),h.appendChild(Ne(e,"W")),h.appendChild(Ne(e,"E")),h.appendChild(Ne(e,"S")),n.appendChild(h),t.appendChild(n),t.appendChild(ur(e)),P.appendChild(t),O==="success"||O==="failure"){const f=document.createElement("div");f.className=`banner ${O==="success"?"ok":"fail"}`,f.textContent=O==="success"?"Success - goal achieved":"Not enough tricks - try again",P.appendChild(f)}if(O==="success"&&E){const f=document.createElement("button");f.type="button",f.textContent="Play Again",f.onclick=()=>lr("manual"),P.appendChild(f)}if(O==="success"&&!E){const f=document.createElement("div");f.className="banner",f.textContent="No 'Play Again' variations available: defenders had no same-tier alternatives to explore.",P.appendChild(f)}if(Qe){const f=document.createElement("section");f.className="log-panel";const p=document.createElement("strong");p.textContent="Log",f.appendChild(p);const k=document.createElement("div");k.className="log",k.textContent=y.length>0?y.join(`
`):"No events yet",f.appendChild(k),P.appendChild(f),k.scrollTop=k.scrollHeight}mt()}Ke(_,!1);w();
